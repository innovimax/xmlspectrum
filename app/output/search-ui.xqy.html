<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>search-ui.xqy</title><link rel="stylesheet" type="text/css" href="theme.css"></head><body><div><pre class="spectrum"><span class="comment" pos="1">(:&#xD;
 : search-ui.xqy&#xD;
 :&#xD;
 : Copyright (c) 2008 Mark Logic Corporation. All rights reserved.&#xD;
 :&#xD;
 : Licensed under the Apache License, Version 2.0 (the "License");&#xD;
 : you may not use this file except in compliance with the License.&#xD;
 : You may obtain a copy of the License at&#xD;
 :&#xD;
 :     http://www.apache.org/licenses/LICENSE-2.0&#xD;
 :&#xD;
 : Unless required by applicable law or agreed to in writing, software&#xD;
 : distributed under the License is distributed on an "AS IS" BASIS,&#xD;
 : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&#xD;
 : See the License for the specific language governing permissions and&#xD;
 : limitations under the License.&#xD;
 :&#xD;
 :&#xD;
 : Search UI Library&#xD;
 : This library has over 1,000 lines of code used specifically for&#xD;
 : creating search experiences in an end-to-end XQuery application.&#xD;
 : Primarily used in demos and prototypes to speed development of common&#xD;
 : search-related tasks.&#xD;
 : &#xD;
 : This library is meant to be changed to suit your application's needs.&#xD;
 : Please test your application when using this library.&#xD;
 :&#xD;
 : Coordinator:&#xD;
 : @author &lt;a href="mailto:chris.welch@marklogic.com"&gt;Chris Welch&lt;/a&gt;&#xD;
 :&#xD;
 : @requires MarkLogic Server 3.2&#xD;
 : @requires Versi&#xD;
 : @requires lib-search&#xD;
 : @requires lib-uitools&#xD;
 : All are available for download on developer.marklogic.com&#xD;
 : Format: 3.2-YYYY-MM-DD.[Incremental]&#xD;
 : @version 3.2-2008-06-10&#xD;
 :&#xD;
 :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">module</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="1420">http://www.marklogic.com/ps/versi/search-ui</span><span class="op">"</span><span class="open"></span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">import</span><span class="whitespace"> </span><span class="qname">module</span><span class="whitespace"> </span><span class="qname">namespace</span><span class="whitespace"> </span><span class="qname">search</span><span class="op">=</span><span class="op">"</span><span class="literal" pos="1500">http://www.marklogic.com/ps/lib/lib-search</span><span class="op">"</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="1548">lib-search.xqy</span><span class="op">"</span><span class="whitespace">&#xD;
</span><span class="qname">import</span><span class="whitespace"> </span><span class="qname">module</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="1580">http://www.marklogic.com/ps/lib/lib-search</span><span class="op">"</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="1628">lib-search-custom.xqy</span><span class="op">"</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">import</span><span class="whitespace"> </span><span class="qname">module</span><span class="whitespace"> </span><span class="qname">namespace</span><span class="whitespace"> </span><span class="qname">uit</span><span class="op">=</span><span class="op">"</span><span class="literal" pos="1681">http://www.marklogic.com/ps/lib/lib-uitools</span><span class="op">"</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="1730">lib-uitools.xqy</span><span class="op">"</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="1751">(: Defines the fields in which a user can search in. Each item should be in the format "[scope-id]|[display-name]" :)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">variable</span><span class="whitespace"> </span><span class="variable">$SEARCH-FIELDS</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="whitespace"> </span><span class="op">{</span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="1919">|Anywhere</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="1934">title|Headline</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="1958">(: Enable the date range search boxes in the advance search forms :)</span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">variable</span><span class="whitespace"> </span><span class="variable">$ENABLE-DATE-CRITERIA</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:boolean</span><span class="whitespace"> </span><span class="op">{</span><span class="whitespace"> </span><span class="function">fn:false</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="2098">(: The default rendering mode for value facets :)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">variable</span><span class="whitespace"> </span><span class="variable">$DEFAULT-FACET-MODE</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">{</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="2200">add</span><span class="op">"</span><span class="whitespace"> </span><span class="op">}</span><span class="whitespace"> </span><span class="comment" pos="2208">(: "mixed | one | add" :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="2237">(:-- Search UI Functions --:)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="2270">(:~&#xD;
:&#xD;
: (Public) Converts &lt;params&gt; into &lt;search:search-criteria&gt;.  &#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @return The equivalent search-criteria XML.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">params-to-query</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:search-criteria</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$start-date</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-date</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-year</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-day</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$end-date</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-date</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-year</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-day</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="op">return</span><span class="whitespace">&#xD;
    	</span><span class="function">build-query-element</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="function">xdmp:url-decode</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> &#xD;
    		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="variable">$start-date</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="variable">$end-date</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="op">,</span><span class="whitespace">&#xD;
    		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">sort</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">build-query-element</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$text</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$field</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$collections</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$values</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$start-date</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:date</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$end-date</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:date</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$duration</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:duration</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$sort</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="quantifier">?</span><span class="whitespace">&#xD;
    </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:search-criteria</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span pos="3391" class="es">&lt;</span><span pos="3392" class="en">search-criteria</span><span pos="3407" class="atn"> fast-pagination</span><span pos="3423" class="atneq">=</span><span pos="3424" class="z">"</span><span pos="3425" class="av">true</span><span pos="3429" class="z">"</span><span pos="3430" class="atn"> xmlns</span><span pos="3436" class="atneq">=</span><span pos="3437" class="z">"</span><span pos="3438" class="av">http://www.marklogic.com/ps/lib/lib-search</span><span pos="3480" class="z">"</span><span pos="3481" class="z">&gt;</span><span pos="3482" class="txt">&#xD;
        </span><span pos="3492" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$text</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span pos="3528" class="es">&lt;</span><span pos="3529" class="en">term</span><span pos="3533" class="z">&gt;</span><span pos="3534" class="txt">&#xD;
            </span><span pos="3548" class="es">&lt;</span><span pos="3549" class="en">text</span><span pos="3553" class="z">&gt;</span><span pos="3554" class="op">{</span><span class="variable">$text</span><span pos="3560" class="op">}</span><span pos="3561" class="sc">&lt;/</span><span pos="3563" class="cl">text</span><span pos="3567" class="z">&gt;</span><span pos="3568" class="txt">&#xD;
            </span><span pos="3582" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$field</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span pos="3631" class="es">&lt;</span><span pos="3632" class="en">scope-id</span><span pos="3640" class="z">&gt;</span><span pos="3641" class="op">{</span><span class="variable">$field</span><span pos="3648" class="op">}</span><span pos="3649" class="sc">&lt;/</span><span pos="3651" class="cl">scope-id</span><span pos="3659" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="3695" class="op">}</span><span pos="3696" class="txt">&#xD;
        </span><span pos="3706" class="sc">&lt;/</span><span pos="3708" class="cl">term</span><span pos="3712" class="z">&gt;</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span pos="3740" class="op">}</span><span pos="3741" class="txt">&#xD;
        </span><span pos="3751" class="op">{</span><span class="function">construct-collection-criteria</span><span class="parenthesis">(</span><span class="variable">$collections</span><span class="parenthesis">)</span><span pos="3795" class="op">}</span><span pos="3796" class="txt">&#xD;
        </span><span pos="3806" class="op">{</span><span class="function">construct-value-criteria</span><span class="parenthesis">(</span><span class="variable">$values</span><span class="parenthesis">)</span><span pos="3840" class="op">}</span><span pos="3841" class="txt">&#xD;
        </span><span pos="3851" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$start-date</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$end-date</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="3910" class="es">&lt;</span><span pos="3911" class="en">date-range</span><span pos="3921" class="z">&gt;</span><span pos="3922" class="txt">&#xD;
                </span><span pos="3940" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$start-date</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="3963" class="es">&lt;</span><span pos="3964" class="en">from</span><span pos="3968" class="z">&gt;</span><span pos="3969" class="op">{</span><span class="variable">$start-date</span><span pos="3981" class="op">}</span><span pos="3982" class="sc">&lt;/</span><span pos="3984" class="cl">from</span><span pos="3988" class="z">&gt;</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="3997" class="op">}</span><span pos="3998" class="txt">&#xD;
                </span><span pos="4016" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$end-date</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="4037" class="es">&lt;</span><span pos="4038" class="en">to</span><span pos="4040" class="z">&gt;</span><span pos="4041" class="op">{</span><span class="variable">$end-date</span><span pos="4051" class="op">}</span><span pos="4052" class="sc">&lt;/</span><span pos="4054" class="cl">to</span><span pos="4056" class="z">&gt;</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="4065" class="op">}</span><span pos="4066" class="txt">&#xD;
            </span><span pos="4080" class="sc">&lt;/</span><span pos="4082" class="cl">date-range</span><span pos="4092" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$duration</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="4141" class="es">&lt;</span><span pos="4142" class="en">date-range</span><span pos="4152" class="z">&gt;</span><span pos="4153" class="txt">&#xD;
                </span><span pos="4171" class="es">&lt;</span><span pos="4172" class="en">trailing-duration</span><span pos="4189" class="z">&gt;</span><span pos="4190" class="op">{</span><span class="variable">$duration</span><span pos="4200" class="op">}</span><span pos="4201" class="sc">&lt;/</span><span pos="4203" class="cl">trailing-duration</span><span pos="4220" class="z">&gt;</span><span pos="4221" class="txt">&#xD;
            </span><span pos="4235" class="sc">&lt;/</span><span pos="4237" class="cl">date-range</span><span pos="4247" class="z">&gt;</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace">&#xD;
            </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span pos="4288" class="op">}</span><span pos="4289" class="txt">&#xD;
        </span><span pos="4299" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$text</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$sort</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="4351">rel</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$sort</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span pos="4434" class="es">&lt;</span><span pos="4435" class="en">sort</span><span pos="4439" class="z">&gt;</span><span pos="4440" class="es">&lt;</span><span pos="4441" class="en">sort-field-id</span><span pos="4454" class="z">&gt;</span><span pos="4455" class="op">{</span><span class="variable">$sort</span><span pos="4461" class="op">}</span><span pos="4462" class="sc">&lt;/</span><span pos="4464" class="cl">sort-field-id</span><span pos="4477" class="z">&gt;</span><span pos="4478" class="sc">&lt;/</span><span pos="4480" class="cl">sort</span><span pos="4484" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace">&#xD;
            </span><span pos="4551" class="es">&lt;</span><span pos="4552" class="en">sort</span><span pos="4556" class="z">&gt;</span><span pos="4557" class="es">&lt;</span><span pos="4558" class="en">sort-field-id</span><span pos="4571" class="z">&gt;</span><span pos="4572" class="txt">date</span><span pos="4576" class="sc">&lt;/</span><span pos="4578" class="cl">sort-field-id</span><span pos="4591" class="z">&gt;</span><span pos="4592" class="sc">&lt;/</span><span pos="4594" class="cl">sort</span><span pos="4598" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span pos="4605" class="op">}</span><span pos="4606" class="txt">&#xD;
    </span><span pos="4612" class="sc">&lt;/</span><span pos="4614" class="cl">search-criteria</span><span pos="4629" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">construct-collection-criteria</span><span class="parenthesis">(</span><span class="variable">$collections</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$set-ids</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="function">fn:distinct-values</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$collections</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$coll</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace">&#xD;
               </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$criteria</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$set-id</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$set-ids</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$names</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$collections</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$coll</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-id</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace"> </span><span pos="5225" class="es">&lt;</span><span pos="5226" class="en">search:value</span><span pos="5238" class="z">&gt;</span><span pos="5239" class="op">{</span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span pos="5250" class="op">}</span><span pos="5251" class="sc">&lt;/</span><span pos="5253" class="cl">search:value</span><span pos="5265" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$names</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="5298">all</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> &#xD;
        </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span pos="5335" class="es">&lt;</span><span pos="5336" class="en">collections</span><span pos="5347" class="atn"> xmlns</span><span pos="5353" class="atneq">=</span><span pos="5354" class="z">"</span><span pos="5355" class="av">http://www.marklogic.com/ps/lib/lib-search</span><span pos="5397" class="z">"</span><span pos="5398" class="z">&gt;</span><span pos="5399" class="txt">&#xD;
                </span><span pos="5417" class="es">&lt;</span><span pos="5418" class="en">set-id</span><span pos="5424" class="z">&gt;</span><span pos="5425" class="op">{</span><span class="variable">$set-id</span><span pos="5433" class="op">}</span><span pos="5434" class="sc">&lt;/</span><span pos="5436" class="cl">set-id</span><span pos="5442" class="z">&gt;</span><span pos="5443" class="txt">&#xD;
                </span><span pos="5461" class="op">{</span><span class="variable">$names</span><span pos="5468" class="op">}</span><span pos="5469" class="txt">&#xD;
            </span><span pos="5483" class="sc">&lt;/</span><span pos="5485" class="cl">collections</span><span pos="5496" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="variable">$criteria</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">construct-value-criteria</span><span class="parenthesis">(</span><span class="variable">$search-values</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$scope-ids</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="function">fn:distinct-values</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$search-values</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace">&#xD;
               </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$criteria</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$set-id</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$scope-ids</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$values</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$search-values</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-id</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace"> </span><span pos="6125" class="es">&lt;</span><span pos="6126" class="en">search:value</span><span pos="6138" class="z">&gt;</span><span pos="6139" class="op">{</span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span pos="6150" class="op">}</span><span pos="6151" class="sc">&lt;/</span><span pos="6153" class="cl">search:value</span><span pos="6165" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$values</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="6199">all</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> &#xD;
        </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span pos="6236" class="es">&lt;</span><span pos="6237" class="en">values</span><span pos="6243" class="atn"> xmlns</span><span pos="6249" class="atneq">=</span><span pos="6250" class="z">"</span><span pos="6251" class="av">http://www.marklogic.com/ps/lib/lib-search</span><span pos="6293" class="z">"</span><span pos="6294" class="z">&gt;</span><span pos="6295" class="txt">&#xD;
                </span><span pos="6313" class="es">&lt;</span><span pos="6314" class="en">scope-id</span><span pos="6322" class="z">&gt;</span><span pos="6323" class="op">{</span><span class="variable">$set-id</span><span pos="6331" class="op">}</span><span pos="6332" class="sc">&lt;/</span><span pos="6334" class="cl">scope-id</span><span pos="6342" class="z">&gt;</span><span pos="6343" class="txt">&#xD;
                </span><span pos="6361" class="op">{</span><span class="variable">$values</span><span pos="6369" class="op">}</span><span pos="6370" class="txt">&#xD;
            </span><span pos="6384" class="sc">&lt;/</span><span pos="6386" class="cl">values</span><span pos="6392" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="variable">$criteria</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$raw</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:tokenize</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal" pos="6509">:</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$raw</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">(</span><span class="variable">$raw</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="variable">$raw</span><span class="filter">[</span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="function">fn:last</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="6620">:</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$raw</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="6651">(:-- Search Form Controls --:)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="6685">(:~&#xD;
:&#xD;
: (Public) Renders an advanced search form, including building&#xD;
: parametric select boxes based on facet information. &#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @param $facet-defs The facets to use to build the advanced search form.&#xD;
: @return A &lt;form&gt; containing the rendered search form.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-form</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
	</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace">&#xD;
	</span><span class="variable">$facet-defs</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet-defs</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span pos="7137" class="es">&lt;</span><span pos="7138" class="en">form</span><span pos="7142" class="atn"> action</span><span pos="7149" class="atneq">=</span><span pos="7150" class="z">"</span><span pos="7151" class="av">search.xqy</span><span pos="7161" class="z">"</span><span pos="7162" class="atn"> method</span><span pos="7169" class="atneq">=</span><span pos="7170" class="z">"</span><span pos="7171" class="av">get</span><span pos="7174" class="z">"</span><span pos="7175" class="z">&gt;</span><span pos="7176" class="txt">	    &#xD;
        </span><span pos="7191" class="es">&lt;</span><span pos="7192" class="en">div</span><span pos="7195" class="atn"> style</span><span pos="7201" class="atneq">=</span><span pos="7202" class="z">"</span><span pos="7203" class="av">background:#F8F8F8;border:1px solid #D0D0D0;width:38em;padding:.6em .7em;</span><span pos="7276" class="z">"</span><span pos="7277" class="z">&gt;</span><span pos="7278" class="txt">&#xD;
            </span><span pos="7292" class="op">{</span><span class="open"></span><span class="axis">element</span><span class="whitespace"> </span><span class="qname">input</span><span class="whitespace"> </span><span class="op">{</span><span class="whitespace">&#xD;
                    </span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">id</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="7344">adv-search-terms</span><span class="op">"</span><span class="open"></span><span class="op">}</span><span class="whitespace">&#xD;
                    </span><span class="op">,</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">name</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="7402">q</span><span class="op">"</span><span class="open"></span><span class="op">}</span><span class="whitespace">&#xD;
                    </span><span class="op">,</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">type</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="7445">text</span><span class="op">"</span><span class="open"></span><span class="op">}</span><span class="whitespace">&#xD;
                    </span><span class="op">,</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">style</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="7492">display:inline;width:250px;padding:.2em .3em;</span><span class="op">"</span><span class="op">}</span><span class="whitespace">&#xD;
                    </span><span class="op">,</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">value</span><span class="whitespace"> </span><span class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="op">}</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">}</span><span pos="7657" class="op">}</span><span pos="7658" class="txt">&#xD;
            </span><span pos="7672" class="op">{</span><span class="open"></span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$SEARCH-FIELDS</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="7712" class="es">&lt;</span><span pos="7713" class="en">select</span><span pos="7719" class="atn"> name</span><span pos="7724" class="atneq">=</span><span pos="7725" class="z">"</span><span pos="7726" class="av">field</span><span pos="7731" class="z">"</span><span pos="7732" class="atn"> style</span><span pos="7738" class="atneq">=</span><span pos="7739" class="z">"</span><span pos="7740" class="av">display:inline;margin-left:.3em;</span><span pos="7772" class="z">"</span><span pos="7773" class="z">&gt;</span><span pos="7774" class="txt">&#xD;
            	</span><span pos="7789" class="op">{</span><span class="open"></span><span class="whitespace">     &#xD;
    			</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$option</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$SEARCH-FIELDS</span><span class="whitespace">&#xD;
    			</span><span class="op">return</span><span class="whitespace">&#xD;
					</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:tokenize</span><span class="parenthesis">(</span><span class="variable">$option</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="7890">\|</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
					</span><span class="op">return</span><span class="whitespace"> &#xD;
						</span><span class="axis">element</span><span class="whitespace"> </span><span class="qname">option</span><span class="whitespace"> </span><span class="op">{</span><span class="whitespace">&#xD;
							</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">value</span><span class="whitespace"> </span><span class="op">{</span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="op">,</span><span class="whitespace">&#xD;
							</span><span class="if">if(</span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="8021"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> &#xD;
								</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="8091">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace">&#xD;
							</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
							</span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace">&#xD;
						</span><span class="op">}</span><span class="whitespace">&#xD;
    			</span><span pos="8155" class="op">}</span><span pos="8156" class="txt">&#xD;
		    </span><span pos="8164" class="sc">&lt;/</span><span pos="8166" class="cl">select</span><span pos="8172" class="z">&gt;</span><span class="whitespace">&#xD;
		    </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span pos="8189" class="op">}</span><span pos="8190" class="txt">&#xD;
        </span><span pos="8200" class="sc">&lt;/</span><span pos="8202" class="cl">div</span><span pos="8205" class="z">&gt;</span><span pos="8206" class="txt">&#xD;
        </span><span pos="8216" class="op">{</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="variable">$pos</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facet-defs</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="filter">[</span><span class="qname">search:collection-set-facet</span><span class="filter">]</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span class="function">search-form-control-collection-set</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
                </span><span class="variable">$params</span><span class="op">,</span><span class="whitespace">&#xD;
                </span><span class="variable">$facet</span><span class="op">,</span><span class="whitespace">&#xD;
                </span><span class="variable">$pos</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">)</span><span pos="8463" class="op">}</span><span pos="8464" class="txt">&#xD;
        </span><span pos="8474" class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$ENABLE-DATE-CRITERIA</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">search-form-control-discrete-date</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="8557" class="op">}</span><span pos="8558" class="txt">&#xD;
		</span><span pos="8562" class="es">&lt;</span><span pos="8563" class="en">input</span><span pos="8568" class="atn"> value</span><span pos="8574" class="atneq">=</span><span pos="8575" class="z">"</span><span pos="8576" class="av">Search</span><span pos="8582" class="z">"</span><span pos="8583" class="atn"> type</span><span pos="8588" class="atneq">=</span><span pos="8589" class="z">"</span><span pos="8590" class="av">submit</span><span pos="8596" class="z">"</span><span pos="8597" class="atn"> class</span><span pos="8603" class="atneq">=</span><span pos="8604" class="z">"</span><span pos="8605" class="av">button</span><span pos="8611" class="z">"</span><span pos="8612" class="atn"> style</span><span pos="8618" class="atneq">=</span><span pos="8619" class="z">"</span><span pos="8620" class="av">display:block;margin:.5em .5em;</span><span pos="8651" class="z">"</span><span pos="8652" class="atn"> </span><span pos="8653" class="z">/&gt;</span><span pos="8655" class="txt">&#xD;
	</span><span pos="8658" class="sc">&lt;/</span><span pos="8660" class="cl">form</span><span pos="8664" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-form-control-collection-set</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$facet-def</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet-def</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$position</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="whitespace">&#xD;
    </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$collection-set-id</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet-def</span><span class="step">/</span><span class="qname">search:collection-set-facet</span><span class="step">/</span><span class="qname">search:set-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$title</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:title</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$resolved-facet</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="function">search:resolve-facet</span><span class="parenthesis">(</span><span pos="9077" class="es">&lt;</span><span pos="9078" class="en">search:search-criteria</span><span pos="9100" class="atn"> </span><span pos="9101" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-def</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    </span><span pos="9134" class="es">&lt;</span><span pos="9135" class="en">div</span><span pos="9138" class="atn"> style</span><span pos="9144" class="atneq">=</span><span pos="9145" class="z">"</span><span pos="9146" class="av">margin: .7em .7em;</span><span pos="9164" class="z">"</span><span pos="9165" class="z">&gt;</span><span pos="9166" class="txt">&#xD;
        </span><span pos="9176" class="op">{</span><span class="variable">$title</span><span pos="9183" class="op">}</span><span pos="9184" class="txt"> [Article Count]:</span><span pos="9201" class="es">&lt;</span><span pos="9202" class="en">br</span><span pos="9204" class="z">/&gt;</span><span pos="9206" class="txt">&#xD;
        </span><span pos="9216" class="es">&lt;</span><span pos="9217" class="en">select</span><span pos="9223" class="atn"> id</span><span pos="9226" class="atneq">=</span><span pos="9227" class="z">"</span><span pos="9228" class="av">select-</span><span pos="9235" class="op">{</span><span class="variable">$position</span><span pos="9245" class="op">}</span><span pos="9246" class="z">"</span><span pos="9247" class="atn"> multiple</span><span pos="9256" class="atneq">=</span><span pos="9257" class="z">"</span><span pos="9258" class="av">multiple</span><span pos="9266" class="z">"</span><span pos="9267" class="atn"> name</span><span pos="9272" class="atneq">=</span><span pos="9273" class="z">"</span><span pos="9274" class="av">coll</span><span pos="9278" class="z">"</span><span pos="9279" class="atn"> size</span><span pos="9284" class="atneq">=</span><span pos="9285" class="z">"</span><span pos="9286" class="av">4</span><span pos="9287" class="z">"</span><span pos="9288" class="atn"> style</span><span pos="9294" class="atneq">=</span><span pos="9295" class="z">"</span><span pos="9296" class="av">width:300px;</span><span pos="9308" class="z">"</span><span pos="9309" class="atn"> </span><span pos="9310" class="z">&gt;</span><span pos="9311" class="txt">&#xD;
            </span><span pos="9325" class="es">&lt;</span><span pos="9326" class="en">option</span><span pos="9332" class="atn"> value</span><span pos="9338" class="atneq">=</span><span pos="9339" class="z">"</span><span pos="9340" class="op">{</span><span class="open"></span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="9371">:all</span><span class="op">"</span><span class="parenthesis">)</span><span pos="9378" class="op">}</span><span pos="9379" class="z">"</span><span pos="9380" class="z">&gt;</span><span pos="9381" class="txt">&#xD;
                </span><span pos="9399" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="9480">:all</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="9531">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace">&#xD;
                </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="9567" class="op">}</span><span pos="9568" class="txt">&#xD;
                All </span><span pos="9590" class="op">{</span><span class="variable">$title</span><span pos="9597" class="op">}</span><span pos="9598" class="txt">&#xD;
            </span><span pos="9612" class="sc">&lt;/</span><span pos="9614" class="cl">option</span><span pos="9620" class="z">&gt;</span><span pos="9621" class="txt">&#xD;
            </span><span pos="9635" class="op">{</span><span class="open"></span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">facet-item-sort</span><span class="parenthesis">(</span><span class="variable">$resolved-facet</span><span class="step">/</span><span class="qname">search:item</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:sort</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="9789">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace"> &#xD;
                </span><span pos="9856" class="es">&lt;</span><span pos="9857" class="en">option</span><span pos="9863" class="atn"> value</span><span pos="9869" class="atneq">=</span><span pos="9870" class="z">"</span><span pos="9871" class="op">{</span><span class="variable">$value</span><span pos="9878" class="op">}</span><span pos="9879" class="z">"</span><span pos="9880" class="z">&gt;</span><span pos="9881" class="txt">&#xD;
                	</span><span pos="9900" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                	</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="9978">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace">&#xD;
                	</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="10015" class="op">}</span><span pos="10016" class="txt">&#xD;
                	</span><span pos="10035" class="op">{</span><span class="open"></span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10059"> [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10088">]</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10092" class="op">}</span><span pos="10093" class="txt">&#xD;
                </span><span pos="10111" class="sc">&lt;/</span><span pos="10113" class="cl">option</span><span pos="10119" class="z">&gt;</span><span pos="10120" class="op">}</span><span pos="10121" class="txt">&#xD;
     	</span><span pos="10129" class="sc">&lt;/</span><span pos="10131" class="cl">select</span><span pos="10137" class="z">&gt;</span><span pos="10138" class="txt">&#xD;
     </span><span pos="10145" class="sc">&lt;/</span><span pos="10147" class="cl">div</span><span pos="10150" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-form-control-discrete-date</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span pos="10258" class="es">&lt;</span><span pos="10259" class="en">div</span><span pos="10262" class="atn"> style</span><span pos="10268" class="atneq">=</span><span pos="10269" class="z">"</span><span pos="10270" class="av">margin: .7em .7em;</span><span pos="10288" class="z">"</span><span pos="10289" class="z">&gt;</span><span pos="10290" class="txt">&#xD;
        Date:</span><span pos="10305" class="es">&lt;</span><span pos="10306" class="en">br</span><span pos="10308" class="z">/&gt;</span><span pos="10310" class="txt">&#xD;
        </span><span pos="10320" class="es">&lt;</span><span pos="10321" class="en">div</span><span pos="10324" class="atn"> style</span><span pos="10330" class="atneq">=</span><span pos="10331" class="z">"</span><span pos="10332" class="av">margin-top:.3em</span><span pos="10347" class="z">"</span><span pos="10348" class="z">&gt;</span><span pos="10349" class="txt">&#xD;
            </span><span pos="10363" class="es">&lt;</span><span pos="10364" class="en">label</span><span pos="10369" class="atn"> style</span><span pos="10375" class="atneq">=</span><span pos="10376" class="z">"</span><span pos="10377" class="av">font-weight:bold;float:left;margin-top:.4em;width:4em;</span><span pos="10431" class="z">"</span><span pos="10432" class="z">&gt;</span><span pos="10433" class="txt">Start: </span><span pos="10440" class="sc">&lt;/</span><span pos="10442" class="cl">label</span><span pos="10447" class="z">&gt;</span><span pos="10448" class="txt">&#xD;
            </span><span pos="10462" class="es">&lt;</span><span pos="10463" class="en">select</span><span pos="10469" class="atn"> name</span><span pos="10474" class="atneq">=</span><span pos="10475" class="z">"</span><span pos="10476" class="av">start-month</span><span pos="10487" class="z">"</span><span pos="10488" class="z">&gt;</span><span pos="10489" class="txt">&#xD;
            	</span><span pos="10504" class="es">&lt;</span><span pos="10505" class="en">option</span><span pos="10511" class="atn"> value</span><span pos="10517" class="atneq">=</span><span pos="10518" class="z">"</span><span pos="10519" class="av">01</span><span pos="10521" class="z">"</span><span pos="10522" class="z">&gt;</span><span pos="10523" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10558">01</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10563" class="op">}</span><span pos="10564" class="txt">January</span><span pos="10571" class="sc">&lt;/</span><span pos="10573" class="cl">option</span><span pos="10579" class="z">&gt;</span><span pos="10580" class="txt">&#xD;
            	</span><span pos="10595" class="es">&lt;</span><span pos="10596" class="en">option</span><span pos="10602" class="atn"> value</span><span pos="10608" class="atneq">=</span><span pos="10609" class="z">"</span><span pos="10610" class="av">02</span><span pos="10612" class="z">"</span><span pos="10613" class="z">&gt;</span><span pos="10614" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10649">02</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10654" class="op">}</span><span pos="10655" class="txt">February</span><span pos="10663" class="sc">&lt;/</span><span pos="10665" class="cl">option</span><span pos="10671" class="z">&gt;</span><span pos="10672" class="txt">&#xD;
            	</span><span pos="10687" class="es">&lt;</span><span pos="10688" class="en">option</span><span pos="10694" class="atn"> value</span><span pos="10700" class="atneq">=</span><span pos="10701" class="z">"</span><span pos="10702" class="av">03</span><span pos="10704" class="z">"</span><span pos="10705" class="z">&gt;</span><span pos="10706" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10741">03</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10746" class="op">}</span><span pos="10747" class="txt">March</span><span pos="10752" class="sc">&lt;/</span><span pos="10754" class="cl">option</span><span pos="10760" class="z">&gt;</span><span pos="10761" class="txt">&#xD;
            	</span><span pos="10776" class="es">&lt;</span><span pos="10777" class="en">option</span><span pos="10783" class="atn"> value</span><span pos="10789" class="atneq">=</span><span pos="10790" class="z">"</span><span pos="10791" class="av">04</span><span pos="10793" class="z">"</span><span pos="10794" class="z">&gt;</span><span pos="10795" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10830">04</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10835" class="op">}</span><span pos="10836" class="txt">April</span><span pos="10841" class="sc">&lt;/</span><span pos="10843" class="cl">option</span><span pos="10849" class="z">&gt;</span><span pos="10850" class="txt">&#xD;
            	</span><span pos="10865" class="es">&lt;</span><span pos="10866" class="en">option</span><span pos="10872" class="atn"> value</span><span pos="10878" class="atneq">=</span><span pos="10879" class="z">"</span><span pos="10880" class="av">05</span><span pos="10882" class="z">"</span><span pos="10883" class="z">&gt;</span><span pos="10884" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="10919">05</span><span class="op">"</span><span class="parenthesis">)</span><span pos="10924" class="op">}</span><span pos="10925" class="txt">May</span><span pos="10928" class="sc">&lt;/</span><span pos="10930" class="cl">option</span><span pos="10936" class="z">&gt;</span><span pos="10937" class="txt">&#xD;
            	</span><span pos="10952" class="es">&lt;</span><span pos="10953" class="en">option</span><span pos="10959" class="atn"> value</span><span pos="10965" class="atneq">=</span><span pos="10966" class="z">"</span><span pos="10967" class="av">06</span><span pos="10969" class="z">"</span><span pos="10970" class="z">&gt;</span><span pos="10971" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11006">06</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11011" class="op">}</span><span pos="11012" class="txt">June</span><span pos="11016" class="sc">&lt;/</span><span pos="11018" class="cl">option</span><span pos="11024" class="z">&gt;</span><span pos="11025" class="txt">&#xD;
            	</span><span pos="11040" class="es">&lt;</span><span pos="11041" class="en">option</span><span pos="11047" class="atn"> value</span><span pos="11053" class="atneq">=</span><span pos="11054" class="z">"</span><span pos="11055" class="av">07</span><span pos="11057" class="z">"</span><span pos="11058" class="z">&gt;</span><span pos="11059" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11094">07</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11099" class="op">}</span><span pos="11100" class="txt">July</span><span pos="11104" class="sc">&lt;/</span><span pos="11106" class="cl">option</span><span pos="11112" class="z">&gt;</span><span pos="11113" class="txt">&#xD;
            	</span><span pos="11128" class="es">&lt;</span><span pos="11129" class="en">option</span><span pos="11135" class="atn"> value</span><span pos="11141" class="atneq">=</span><span pos="11142" class="z">"</span><span pos="11143" class="av">08</span><span pos="11145" class="z">"</span><span pos="11146" class="z">&gt;</span><span pos="11147" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11182">08</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11187" class="op">}</span><span pos="11188" class="txt">August</span><span pos="11194" class="sc">&lt;/</span><span pos="11196" class="cl">option</span><span pos="11202" class="z">&gt;</span><span pos="11203" class="txt">&#xD;
            	</span><span pos="11218" class="es">&lt;</span><span pos="11219" class="en">option</span><span pos="11225" class="atn"> value</span><span pos="11231" class="atneq">=</span><span pos="11232" class="z">"</span><span pos="11233" class="av">09</span><span pos="11235" class="z">"</span><span pos="11236" class="z">&gt;</span><span pos="11237" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11272">09</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11277" class="op">}</span><span pos="11278" class="txt">September</span><span pos="11287" class="sc">&lt;/</span><span pos="11289" class="cl">option</span><span pos="11295" class="z">&gt;</span><span pos="11296" class="txt">&#xD;
            	</span><span pos="11311" class="es">&lt;</span><span pos="11312" class="en">option</span><span pos="11318" class="atn"> value</span><span pos="11324" class="atneq">=</span><span pos="11325" class="z">"</span><span pos="11326" class="av">10</span><span pos="11328" class="z">"</span><span pos="11329" class="z">&gt;</span><span pos="11330" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11365">10</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11370" class="op">}</span><span pos="11371" class="txt">October</span><span pos="11378" class="sc">&lt;/</span><span pos="11380" class="cl">option</span><span pos="11386" class="z">&gt;</span><span pos="11387" class="txt">&#xD;
            	</span><span pos="11402" class="es">&lt;</span><span pos="11403" class="en">option</span><span pos="11409" class="atn"> value</span><span pos="11415" class="atneq">=</span><span pos="11416" class="z">"</span><span pos="11417" class="av">11</span><span pos="11419" class="z">"</span><span pos="11420" class="z">&gt;</span><span pos="11421" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11456">11</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11461" class="op">}</span><span pos="11462" class="txt">November</span><span pos="11470" class="sc">&lt;/</span><span pos="11472" class="cl">option</span><span pos="11478" class="z">&gt;</span><span pos="11479" class="txt">&#xD;
            	</span><span pos="11494" class="es">&lt;</span><span pos="11495" class="en">option</span><span pos="11501" class="atn"> value</span><span pos="11507" class="atneq">=</span><span pos="11508" class="z">"</span><span pos="11509" class="av">12</span><span pos="11511" class="z">"</span><span pos="11512" class="z">&gt;</span><span pos="11513" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="11548">12</span><span class="op">"</span><span class="parenthesis">)</span><span pos="11553" class="op">}</span><span pos="11554" class="txt">December</span><span pos="11562" class="sc">&lt;/</span><span pos="11564" class="cl">option</span><span pos="11570" class="z">&gt;</span><span pos="11571" class="txt">&#xD;
            </span><span pos="11585" class="sc">&lt;/</span><span pos="11587" class="cl">select</span><span pos="11593" class="z">&gt;</span><span pos="11594" class="txt">&#xD;
            </span><span pos="11608" class="op">{</span><span class="op">"</span><span class="literal" pos="11609"> / </span><span class="op">"</span><span pos="11614" class="op">}</span><span pos="11615" class="txt">&#xD;
            </span><span pos="11629" class="es">&lt;</span><span pos="11630" class="en">input</span><span pos="11635" class="atn"> type</span><span pos="11640" class="atneq">=</span><span pos="11641" class="z">"</span><span pos="11642" class="av">text</span><span pos="11646" class="z">"</span><span pos="11647" class="atn"> name</span><span pos="11652" class="atneq">=</span><span pos="11653" class="z">"</span><span pos="11654" class="av">start-day</span><span pos="11663" class="z">"</span><span pos="11664" class="atn"> value</span><span pos="11670" class="atneq">=</span><span pos="11671" class="z">"</span><span pos="11672" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-day</span><span class="parenthesis">)</span><span pos="11701" class="op">}</span><span pos="11702" class="z">"</span><span pos="11703" class="atn"> style</span><span pos="11709" class="atneq">=</span><span pos="11710" class="z">"</span><span pos="11711" class="av">width:2em;</span><span pos="11721" class="z">"</span><span pos="11722" class="atn"> </span><span pos="11723" class="z">/&gt;</span><span pos="11725" class="txt">&#xD;
            </span><span pos="11739" class="op">{</span><span class="op">"</span><span class="literal" pos="11740"> / </span><span class="op">"</span><span pos="11745" class="op">}</span><span pos="11746" class="txt">&#xD;
            </span><span pos="11760" class="es">&lt;</span><span pos="11761" class="en">input</span><span pos="11766" class="atn"> type</span><span pos="11771" class="atneq">=</span><span pos="11772" class="z">"</span><span pos="11773" class="av">text</span><span pos="11777" class="z">"</span><span pos="11778" class="atn"> name</span><span pos="11783" class="atneq">=</span><span pos="11784" class="z">"</span><span pos="11785" class="av">start-year</span><span pos="11795" class="z">"</span><span pos="11796" class="atn"> value</span><span pos="11802" class="atneq">=</span><span pos="11803" class="z">"</span><span pos="11804" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">start-year</span><span class="parenthesis">)</span><span pos="11834" class="op">}</span><span pos="11835" class="z">"</span><span pos="11836" class="atn"> style</span><span pos="11842" class="atneq">=</span><span pos="11843" class="z">"</span><span pos="11844" class="av">width:4em;</span><span pos="11854" class="z">"</span><span pos="11855" class="atn"> </span><span pos="11856" class="z">/&gt;</span><span pos="11858" class="txt">&#xD;
        </span><span pos="11868" class="sc">&lt;/</span><span pos="11870" class="cl">div</span><span pos="11873" class="z">&gt;</span><span pos="11874" class="txt">&#xD;
        </span><span pos="11884" class="es">&lt;</span><span pos="11885" class="en">div</span><span pos="11888" class="z">&gt;</span><span pos="11889" class="txt">&#xD;
            </span><span pos="11903" class="es">&lt;</span><span pos="11904" class="en">label</span><span pos="11909" class="atn"> style</span><span pos="11915" class="atneq">=</span><span pos="11916" class="z">"</span><span pos="11917" class="av">font-weight:bold;float:left;margin-top:.4em;width:4em;</span><span pos="11971" class="z">"</span><span pos="11972" class="z">&gt;</span><span pos="11973" class="txt">End: </span><span pos="11978" class="sc">&lt;/</span><span pos="11980" class="cl">label</span><span pos="11985" class="z">&gt;</span><span pos="11986" class="txt">&#xD;
            </span><span pos="12000" class="es">&lt;</span><span pos="12001" class="en">select</span><span pos="12007" class="atn"> name</span><span pos="12012" class="atneq">=</span><span pos="12013" class="z">"</span><span pos="12014" class="av">end-month</span><span pos="12023" class="z">"</span><span pos="12024" class="z">&gt;</span><span pos="12025" class="txt">&#xD;
            	</span><span pos="12040" class="es">&lt;</span><span pos="12041" class="en">option</span><span pos="12047" class="atn"> value</span><span pos="12053" class="atneq">=</span><span pos="12054" class="z">"</span><span pos="12055" class="av">01</span><span pos="12057" class="z">"</span><span pos="12058" class="z">&gt;</span><span pos="12059" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12092">01</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12097" class="op">}</span><span pos="12098" class="txt">January</span><span pos="12105" class="sc">&lt;/</span><span pos="12107" class="cl">option</span><span pos="12113" class="z">&gt;</span><span pos="12114" class="txt">&#xD;
            	</span><span pos="12129" class="es">&lt;</span><span pos="12130" class="en">option</span><span pos="12136" class="atn"> value</span><span pos="12142" class="atneq">=</span><span pos="12143" class="z">"</span><span pos="12144" class="av">02</span><span pos="12146" class="z">"</span><span pos="12147" class="z">&gt;</span><span pos="12148" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12181">02</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12186" class="op">}</span><span pos="12187" class="txt">February</span><span pos="12195" class="sc">&lt;/</span><span pos="12197" class="cl">option</span><span pos="12203" class="z">&gt;</span><span pos="12204" class="txt">&#xD;
            	</span><span pos="12219" class="es">&lt;</span><span pos="12220" class="en">option</span><span pos="12226" class="atn"> value</span><span pos="12232" class="atneq">=</span><span pos="12233" class="z">"</span><span pos="12234" class="av">03</span><span pos="12236" class="z">"</span><span pos="12237" class="z">&gt;</span><span pos="12238" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12271">03</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12276" class="op">}</span><span pos="12277" class="txt">March</span><span pos="12282" class="sc">&lt;/</span><span pos="12284" class="cl">option</span><span pos="12290" class="z">&gt;</span><span pos="12291" class="txt">&#xD;
            	</span><span pos="12306" class="es">&lt;</span><span pos="12307" class="en">option</span><span pos="12313" class="atn"> value</span><span pos="12319" class="atneq">=</span><span pos="12320" class="z">"</span><span pos="12321" class="av">04</span><span pos="12323" class="z">"</span><span pos="12324" class="z">&gt;</span><span pos="12325" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12358">04</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12363" class="op">}</span><span pos="12364" class="txt">April</span><span pos="12369" class="sc">&lt;/</span><span pos="12371" class="cl">option</span><span pos="12377" class="z">&gt;</span><span pos="12378" class="txt">&#xD;
            	</span><span pos="12393" class="es">&lt;</span><span pos="12394" class="en">option</span><span pos="12400" class="atn"> value</span><span pos="12406" class="atneq">=</span><span pos="12407" class="z">"</span><span pos="12408" class="av">05</span><span pos="12410" class="z">"</span><span pos="12411" class="z">&gt;</span><span pos="12412" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12445">05</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12450" class="op">}</span><span pos="12451" class="txt">May</span><span pos="12454" class="sc">&lt;/</span><span pos="12456" class="cl">option</span><span pos="12462" class="z">&gt;</span><span pos="12463" class="txt">&#xD;
            	</span><span pos="12478" class="es">&lt;</span><span pos="12479" class="en">option</span><span pos="12485" class="atn"> value</span><span pos="12491" class="atneq">=</span><span pos="12492" class="z">"</span><span pos="12493" class="av">06</span><span pos="12495" class="z">"</span><span pos="12496" class="z">&gt;</span><span pos="12497" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12530">06</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12535" class="op">}</span><span pos="12536" class="txt">June</span><span pos="12540" class="sc">&lt;/</span><span pos="12542" class="cl">option</span><span pos="12548" class="z">&gt;</span><span pos="12549" class="txt">&#xD;
            	</span><span pos="12564" class="es">&lt;</span><span pos="12565" class="en">option</span><span pos="12571" class="atn"> value</span><span pos="12577" class="atneq">=</span><span pos="12578" class="z">"</span><span pos="12579" class="av">07</span><span pos="12581" class="z">"</span><span pos="12582" class="z">&gt;</span><span pos="12583" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12616">07</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12621" class="op">}</span><span pos="12622" class="txt">July</span><span pos="12626" class="sc">&lt;/</span><span pos="12628" class="cl">option</span><span pos="12634" class="z">&gt;</span><span pos="12635" class="txt">&#xD;
            	</span><span pos="12650" class="es">&lt;</span><span pos="12651" class="en">option</span><span pos="12657" class="atn"> value</span><span pos="12663" class="atneq">=</span><span pos="12664" class="z">"</span><span pos="12665" class="av">08</span><span pos="12667" class="z">"</span><span pos="12668" class="z">&gt;</span><span pos="12669" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12702">08</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12707" class="op">}</span><span pos="12708" class="txt">August</span><span pos="12714" class="sc">&lt;/</span><span pos="12716" class="cl">option</span><span pos="12722" class="z">&gt;</span><span pos="12723" class="txt">&#xD;
            	</span><span pos="12738" class="es">&lt;</span><span pos="12739" class="en">option</span><span pos="12745" class="atn"> value</span><span pos="12751" class="atneq">=</span><span pos="12752" class="z">"</span><span pos="12753" class="av">09</span><span pos="12755" class="z">"</span><span pos="12756" class="z">&gt;</span><span pos="12757" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12790">09</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12795" class="op">}</span><span pos="12796" class="txt">September</span><span pos="12805" class="sc">&lt;/</span><span pos="12807" class="cl">option</span><span pos="12813" class="z">&gt;</span><span pos="12814" class="txt">&#xD;
            	</span><span pos="12829" class="es">&lt;</span><span pos="12830" class="en">option</span><span pos="12836" class="atn"> value</span><span pos="12842" class="atneq">=</span><span pos="12843" class="z">"</span><span pos="12844" class="av">10</span><span pos="12846" class="z">"</span><span pos="12847" class="z">&gt;</span><span pos="12848" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12881">10</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12886" class="op">}</span><span pos="12887" class="txt">October</span><span pos="12894" class="sc">&lt;/</span><span pos="12896" class="cl">option</span><span pos="12902" class="z">&gt;</span><span pos="12903" class="txt">&#xD;
            	</span><span pos="12918" class="es">&lt;</span><span pos="12919" class="en">option</span><span pos="12925" class="atn"> value</span><span pos="12931" class="atneq">=</span><span pos="12932" class="z">"</span><span pos="12933" class="av">11</span><span pos="12935" class="z">"</span><span pos="12936" class="z">&gt;</span><span pos="12937" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="12970">11</span><span class="op">"</span><span class="parenthesis">)</span><span pos="12975" class="op">}</span><span pos="12976" class="txt">November</span><span pos="12984" class="sc">&lt;/</span><span pos="12986" class="cl">option</span><span pos="12992" class="z">&gt;</span><span pos="12993" class="txt">&#xD;
            	</span><span pos="13008" class="es">&lt;</span><span pos="13009" class="en">option</span><span pos="13015" class="atn"> value</span><span pos="13021" class="atneq">=</span><span pos="13022" class="z">"</span><span pos="13023" class="av">12</span><span pos="13025" class="z">"</span><span pos="13026" class="z">&gt;</span><span pos="13027" class="op">{</span><span class="open"></span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-month</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="13060">12</span><span class="op">"</span><span class="parenthesis">)</span><span pos="13065" class="op">}</span><span pos="13066" class="txt">December</span><span pos="13074" class="sc">&lt;/</span><span pos="13076" class="cl">option</span><span pos="13082" class="z">&gt;</span><span pos="13083" class="txt">&#xD;
            </span><span pos="13097" class="sc">&lt;/</span><span pos="13099" class="cl">select</span><span pos="13105" class="z">&gt;</span><span pos="13106" class="txt">&#xD;
            </span><span pos="13120" class="op">{</span><span class="op">"</span><span class="literal" pos="13121"> / </span><span class="op">"</span><span pos="13126" class="op">}</span><span pos="13127" class="txt">&#xD;
            </span><span pos="13141" class="es">&lt;</span><span pos="13142" class="en">input</span><span pos="13147" class="atn"> type</span><span pos="13152" class="atneq">=</span><span pos="13153" class="z">"</span><span pos="13154" class="av">text</span><span pos="13158" class="z">"</span><span pos="13159" class="atn"> name</span><span pos="13164" class="atneq">=</span><span pos="13165" class="z">"</span><span pos="13166" class="av">end-day</span><span pos="13173" class="z">"</span><span pos="13174" class="atn"> value</span><span pos="13180" class="atneq">=</span><span pos="13181" class="z">"</span><span pos="13182" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-day</span><span class="parenthesis">)</span><span pos="13209" class="op">}</span><span pos="13210" class="z">"</span><span pos="13211" class="atn"> style</span><span pos="13217" class="atneq">=</span><span pos="13218" class="z">"</span><span pos="13219" class="av">width:2em;</span><span pos="13229" class="z">"</span><span pos="13230" class="atn"> </span><span pos="13231" class="z">/&gt;</span><span pos="13233" class="txt">&#xD;
            </span><span pos="13247" class="op">{</span><span class="op">"</span><span class="literal" pos="13248"> / </span><span class="op">"</span><span pos="13253" class="op">}</span><span pos="13254" class="txt">&#xD;
            </span><span pos="13268" class="es">&lt;</span><span pos="13269" class="en">input</span><span pos="13274" class="atn"> type</span><span pos="13279" class="atneq">=</span><span pos="13280" class="z">"</span><span pos="13281" class="av">text</span><span pos="13285" class="z">"</span><span pos="13286" class="atn"> name</span><span pos="13291" class="atneq">=</span><span pos="13292" class="z">"</span><span pos="13293" class="av">end-year</span><span pos="13301" class="z">"</span><span pos="13302" class="atn"> value</span><span pos="13308" class="atneq">=</span><span pos="13309" class="z">"</span><span pos="13310" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">end-year</span><span class="parenthesis">)</span><span pos="13338" class="op">}</span><span pos="13339" class="z">"</span><span pos="13340" class="atn"> style</span><span pos="13346" class="atneq">=</span><span pos="13347" class="z">"</span><span pos="13348" class="av">width:4em;</span><span pos="13358" class="z">"</span><span pos="13359" class="atn"> </span><span pos="13360" class="z">/&gt;</span><span pos="13362" class="txt">&#xD;
        </span><span pos="13372" class="sc">&lt;/</span><span pos="13374" class="cl">div</span><span pos="13377" class="z">&gt;</span><span pos="13378" class="txt">&#xD;
 	</span><span pos="13382" class="sc">&lt;/</span><span pos="13384" class="cl">div</span><span pos="13387" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">select-option</span><span class="parenthesis">(</span><span class="variable">$param</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">attribute</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$param</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="13535">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="13561">(: Search Facets Functions :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="13594">(: &#xD;
   The format of the facet definitions is proscribed by lib-search. You can also&#xD;
   include custom elements which search-ui.xqy will use when rendering your facet.&#xD;
   Make sure to pass the custom section for each facet, which contains:&#xD;
   facet-def/custom/title : The heading used to display all related UI controls.&#xD;
   facet-def/custom/sort : default (default), count, name-asc, name-desc&#xD;
   facet-def/custom/icon : an image filename, used in the analysis panel only&#xD;
   facet-def/custom/qs-id : for collection and value facets, scope-ids should be used,&#xD;
       and this should match the name of the scope-id&#xD;
   facet-def/custom/mode : currently used only in value facets, changes how the user&#xD;
       interacts with the facet.&#xD;
   &#xD;
   For more information on defining facets, see the Search Library Guide.&#xD;
&#xD;
    &lt;facet-defs xmlns="http://www.marklogic.com/ps/lib/lib-search"&gt;&#xD;
        &lt;facet-def&gt;&#xD;
        ...&#xD;
        &lt;custom&gt;&#xD;
            &lt;sort&gt;name-asc&lt;/sort&gt;&#xD;
            &lt;qs-id&gt;comp&lt;/qs-id&gt;&#xD;
            &lt;title&gt;Companies&lt;/title&gt;&#xD;
            &lt;icon&gt;/images/silk/building.png&lt;/icon&gt;&#xD;
            &lt;mode&gt;mixed|one|add&lt;/mode&gt;&#xD;
        &lt;/custom&gt;&#xD;
        &lt;/facet-def&gt;&#xD;
    &lt;/facet-defs&gt;&#xD;
:)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="14803">(:~&#xD;
:&#xD;
: (Public) Renders an facets meant to be displayed on the sidebar of&#xD;
: the search page.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @param $facet-defs The facets to use to build the advanced search form.&#xD;
: @return The rendered HTML facets.&#xD;
:)</span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-facets</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-defs</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet-defs</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$rendered-facets</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$query</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">params-to-query</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facets</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">search:resolve-facets</span><span class="parenthesis">(</span><span class="variable">$query</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-defs</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facets</span><span class="step">/</span><span class="qname">search:facet</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="filter">[</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:collection-set-facet</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="function">collection-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="filter">[</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:value-facet</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="function">value-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="filter">[</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:trailing-date-facet</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="function">trailing-date-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="comment" pos="15790">(: Unhandled facet type&#xD;
            else if ($facet[search:facet-def/search:date-group-facet]) then&#xD;
                (date-group-facet($params, $facet)):)</span><span class="open"></span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$rendered-facets</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="16028" class="es">&lt;</span><span pos="16029" class="en">div</span><span pos="16032" class="z">&gt;</span><span pos="16033" class="op">{</span><span class="variable">$rendered-facets</span><span pos="16050" class="op">}</span><span pos="16051" class="sc">&lt;/</span><span pos="16053" class="cl">div</span><span pos="16056" class="z">&gt;</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="16081">(:~&#xD;
:&#xD;
: (Public) Renders tag clouds meant to be displayed on the top of&#xD;
: the search page. The items in the tag cloud are given a 1-6 "heat" rating,&#xD;
: which can be individually styled. The heat rating is determined, and can&#xD;
: be customized using the "determine-heat" function.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @param $facet-defs The facets to use to build the advanced search form.&#xD;
: @return The rendered HTML tag clouds&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-results-analysis</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-defs</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet-defs</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$query</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">params-to-query</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facets</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">search:resolve-facets</span><span class="parenthesis">(</span><span class="variable">$query</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet-defs</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facets</span><span class="step">/</span><span class="qname">search:facet</span><span class="step">/</span><span class="qname">search:item</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    </span><span pos="16836" class="es">&lt;</span><span pos="16837" class="en">div</span><span pos="16840" class="atn"> class</span><span pos="16846" class="atneq">=</span><span pos="16847" class="z">"</span><span pos="16848" class="av">analysis-panel</span><span pos="16862" class="z">"</span><span pos="16863" class="z">&gt;</span><span pos="16864" class="txt">&#xD;
        </span><span pos="16874" class="es">&lt;</span><span pos="16875" class="en">div</span><span pos="16878" class="atn"> class</span><span pos="16884" class="atneq">=</span><span pos="16885" class="z">"</span><span pos="16886" class="av">header</span><span pos="16892" class="z">"</span><span pos="16893" class="z">&gt;</span><span pos="16894" class="txt">These documents contain references to:&amp;nbsp;&amp;nbsp;</span><span pos="16944" class="es">&lt;</span><span pos="16945" class="en">a</span><span pos="16946" class="atn"> href</span><span pos="16951" class="atneq">=</span><span pos="16952" class="z">"</span><span pos="16953" class="av">search.xqy?</span><span pos="16964" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="16997">p</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="17002">hval</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="17010" class="op">}</span><span pos="17011" class="z">"</span><span pos="17012" class="z">&gt;</span><span pos="17013" class="txt">[CLEAR FILTERS]</span><span pos="17028" class="sc">&lt;/</span><span pos="17030" class="cl">a</span><span pos="17031" class="z">&gt;</span><span pos="17032" class="sc">&lt;/</span><span pos="17034" class="cl">div</span><span pos="17037" class="z">&gt;</span><span pos="17038" class="txt">&#xD;
        </span><span pos="17048" class="op">{</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facets</span><span class="step">/</span><span class="qname">search:facet</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="function">value-heatmap</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span pos="17150" class="op">}</span><span pos="17151" class="txt">&#xD;
    </span><span pos="17157" class="sc">&lt;/</span><span pos="17159" class="cl">div</span><span pos="17162" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="17183">(: NB: This facet doesn't yet support facet modes. It must be added later :)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">collection-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$title</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:title</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="17471">coll</span><span class="op">"</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="17528">p</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$collection-set-id</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:collection-set-facet</span><span class="step">/</span><span class="qname">search:set-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="17701">:all</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    &#xD;
    </span><span class="comment" pos="17720">(: Collection Management :)</span><span class="whitespace">&#xD;
    </span><span class="comment" pos="17753">(: Selects the param values that are within scope (ie have been returned from) of the current facet :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-colls</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-colls</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facet-colls</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="18026">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$passed-colls</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:starts-with</span><span class="parenthesis">(</span><span class="variable">$coll</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$collection-set-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$out-of-scope-colls</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$passed-colls</span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$coll</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-colls</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$coll</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$out-of-scope-colls</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$out-of-scope-colls</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace">&#xD;
    &#xD;
	</span><span class="op">return</span><span class="whitespace">&#xD;
	</span><span pos="18503" class="es">&lt;</span><span pos="18504" class="en">div</span><span pos="18507" class="z">&gt;</span><span pos="18508" class="txt">&#xD;
		</span><span pos="18512" class="op">{</span><span class="open"></span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$title</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="18531" class="es">&lt;</span><span pos="18532" class="en">h3</span><span pos="18534" class="z">&gt;</span><span pos="18535" class="op">{</span><span class="variable">$title</span><span pos="18542" class="op">}</span><span pos="18543" class="sc">&lt;/</span><span pos="18545" class="cl">h3</span><span pos="18547" class="z">&gt;</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span pos="18557" class="op">}</span><span pos="18558" class="txt">&#xD;
		</span><span pos="18562" class="es">&lt;</span><span pos="18563" class="en">div</span><span pos="18566" class="atn"> class</span><span pos="18572" class="atneq">=</span><span pos="18573" class="z">"</span><span pos="18574" class="av">search_facet</span><span pos="18586" class="z">"</span><span pos="18587" class="z">&gt;</span><span pos="18588" class="txt">&#xD;
		</span><span pos="18592" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="18594">(: ALL :)</span><span class="open"></span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$newParams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$facet-colls</span><span class="op">,</span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:all</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$newParams</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="18822">All [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="18837">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="op">return</span><span class="whitespace">			&#xD;
        	</span><span pos="18865" class="es">&lt;</span><span pos="18866" class="en">div</span><span pos="18869" class="z">&gt;</span><span pos="18870" class="es">&lt;</span><span pos="18871" class="en">a</span><span pos="18872" class="atn"> href</span><span pos="18877" class="atneq">=</span><span pos="18878" class="z">"</span><span pos="18879" class="av">search.xqy?</span><span pos="18890" class="op">{</span><span class="variable">$qs</span><span pos="18894" class="op">}</span><span pos="18895" class="z">"</span><span pos="18896" class="z">&gt;</span><span pos="18897" class="txt">&#xD;
        		</span><span pos="18909" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
        		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
        		    </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-colls</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
        			</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	     			</span><span class="parenthesis">(</span><span pos="19064" class="es">&lt;</span><span pos="19065" class="en">img</span><span pos="19068" class="atn"> src</span><span pos="19072" class="atneq">=</span><span pos="19073" class="z">"</span><span pos="19074" class="av">images/silk/bullet_black.png</span><span pos="19102" class="z">"</span><span pos="19103" class="atn"> class</span><span pos="19109" class="atneq">=</span><span pos="19110" class="z">"</span><span pos="19111" class="av">selected_icon</span><span pos="19124" class="z">"</span><span pos="19125" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="19128" class="es">&lt;</span><span pos="19129" class="en">strong</span><span pos="19135" class="z">&gt;</span><span pos="19136" class="op">{</span><span class="variable">$link</span><span pos="19142" class="op">}</span><span pos="19143" class="sc">&lt;/</span><span pos="19145" class="cl">strong</span><span pos="19151" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        		</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
        		</span><span pos="19187" class="op">}</span><span pos="19188" class="txt">&#xD;
        	</span><span pos="19199" class="sc">&lt;/</span><span pos="19201" class="cl">a</span><span pos="19202" class="z">&gt;</span><span pos="19203" class="sc">&lt;/</span><span pos="19205" class="cl">div</span><span pos="19208" class="z">&gt;</span><span class="whitespace">&#xD;
        </span><span pos="19219" class="op">}</span><span pos="19220" class="txt">&#xD;
    	</span><span pos="19227" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="19229">(: COLLECTIONS :)</span><span class="open"></span><span class="whitespace">&#xD;
    	</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">facet-item-sort</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:sort</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$collection-set-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="19400">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="19497"> [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="19509">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
 			</span><span class="comment" pos="19533">(: If the current collection exists in the params, then remove&#xD;
			   from params, else add to the params :)</span><span class="open"></span><span class="whitespace">&#xD;
			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
	    		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
				</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$value</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
			</span><span class="op">else</span><span class="whitespace">&#xD;
				</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
					</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
					</span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$param-name</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="19971">=</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="19984">&amp;</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	</span><span class="op">return</span><span class="whitespace">&#xD;
    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	    		</span><span pos="20038" class="es">&lt;</span><span pos="20039" class="en">div</span><span pos="20042" class="z">&gt;</span><span pos="20043" class="es">&lt;</span><span pos="20044" class="en">a</span><span pos="20045" class="atn"> href</span><span pos="20050" class="atneq">=</span><span pos="20051" class="z">"</span><span pos="20052" class="av">search.xqy?</span><span pos="20063" class="op">{</span><span class="variable">$qs</span><span pos="20067" class="op">}</span><span pos="20068" class="z">"</span><span pos="20069" class="z">&gt;</span><span pos="20070" class="txt">&#xD;
	    			</span><span pos="20080" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
	    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
	    				</span><span class="variable">$params</span><span class="step">/</span><span class="qname">coll</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	     				</span><span class="parenthesis">(</span><span pos="20194" class="es">&lt;</span><span pos="20195" class="en">img</span><span pos="20198" class="atn"> src</span><span pos="20202" class="atneq">=</span><span pos="20203" class="z">"</span><span pos="20204" class="av">images/silk/bullet_delete.png</span><span pos="20233" class="z">"</span><span pos="20234" class="atn"> class</span><span pos="20240" class="atneq">=</span><span pos="20241" class="z">"</span><span pos="20242" class="av">selected_icon</span><span pos="20255" class="z">"</span><span pos="20256" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="20259" class="es">&lt;</span><span pos="20260" class="en">strong</span><span pos="20266" class="z">&gt;</span><span pos="20267" class="op">{</span><span class="variable">$link</span><span pos="20273" class="op">}</span><span pos="20274" class="sc">&lt;/</span><span pos="20276" class="cl">strong</span><span pos="20282" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	    			</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
	    			</span><span pos="20314" class="op">}</span><span pos="20315" class="txt">&#xD;
	    		</span><span pos="20324" class="sc">&lt;/</span><span pos="20326" class="cl">a</span><span pos="20327" class="z">&gt;</span><span pos="20328" class="sc">&lt;/</span><span pos="20330" class="cl">div</span><span pos="20333" class="z">&gt;</span><span class="whitespace">&#xD;
	    	</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
 		</span><span pos="20354" class="op">}</span><span pos="20355" class="txt">&#xD;
 		</span><span pos="20360" class="sc">&lt;/</span><span pos="20362" class="cl">div</span><span pos="20365" class="z">&gt;</span><span pos="20366" class="txt">&#xD;
 	</span><span pos="20370" class="sc">&lt;/</span><span pos="20372" class="cl">div</span><span pos="20375" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">value-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace"> </span><span class="function">value-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">value-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$mode</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="quantifier">?</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="comment" pos="20647">(: mode == (one, add, mixed) :)</span><span class="open"></span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$mode</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
	    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$mode</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$mode</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="filter">[</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:mode</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:mode</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace">&#xD;
	            </span><span class="variable">$DEFAULT-FACET-MODE</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$title</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:title</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="21038">val</span><span class="op">"</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="21094">p</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs-id</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:qs-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="21228">:all</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    &#xD;
    </span><span class="comment" pos="21247">(: Value Management :)</span><span class="whitespace">&#xD;
    </span><span class="comment" pos="21275">(: Selects the param values that are within scope (ie have been returned from) of the current facet :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="21533">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$passed-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:starts-with</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$qs-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$out-of-scope-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$passed-vals</span><span class="whitespace">&#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$out-of-scope-vals</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$out-of-scope-vals</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace">&#xD;
    &#xD;
	</span><span class="op">return</span><span class="whitespace">&#xD;
	</span><span pos="21985" class="es">&lt;</span><span pos="21986" class="en">div</span><span pos="21989" class="z">&gt;</span><span pos="21990" class="txt">&#xD;
		</span><span pos="21994" class="op">{</span><span class="open"></span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$title</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="22013" class="es">&lt;</span><span pos="22014" class="en">h3</span><span pos="22016" class="z">&gt;</span><span pos="22017" class="op">{</span><span class="variable">$title</span><span pos="22024" class="op">}</span><span pos="22025" class="sc">&lt;/</span><span pos="22027" class="cl">h3</span><span pos="22029" class="z">&gt;</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span pos="22039" class="op">}</span><span pos="22040" class="txt">&#xD;
		</span><span pos="22044" class="es">&lt;</span><span pos="22045" class="en">div</span><span pos="22048" class="atn"> class</span><span pos="22054" class="atneq">=</span><span pos="22055" class="z">"</span><span pos="22056" class="av">search_facet</span><span pos="22068" class="z">"</span><span pos="22069" class="z">&gt;</span><span pos="22070" class="txt">&#xD;
		</span><span pos="22074" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="22076">(: ALL :)</span><span class="open"></span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$newParams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$facet-vals</span><span class="op">,</span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:all</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$newParams</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="22303">All [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="22318">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="op">return</span><span class="whitespace">			&#xD;
        	</span><span pos="22346" class="es">&lt;</span><span pos="22347" class="en">div</span><span pos="22350" class="z">&gt;</span><span pos="22351" class="es">&lt;</span><span pos="22352" class="en">a</span><span pos="22353" class="atn"> href</span><span pos="22358" class="atneq">=</span><span pos="22359" class="z">"</span><span pos="22360" class="av">search.xqy?</span><span pos="22371" class="op">{</span><span class="variable">$qs</span><span pos="22375" class="op">}</span><span pos="22376" class="z">"</span><span pos="22377" class="z">&gt;</span><span pos="22378" class="txt">&#xD;
        		</span><span pos="22390" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
        		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
        		    </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
        			</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	     			</span><span class="parenthesis">(</span><span pos="22541" class="es">&lt;</span><span pos="22542" class="en">img</span><span pos="22545" class="atn"> src</span><span pos="22549" class="atneq">=</span><span pos="22550" class="z">"</span><span pos="22551" class="av">images/silk/bullet_black.png</span><span pos="22579" class="z">"</span><span pos="22580" class="atn"> class</span><span pos="22586" class="atneq">=</span><span pos="22587" class="z">"</span><span pos="22588" class="av">selected_icon</span><span pos="22601" class="z">"</span><span pos="22602" class="atn"> </span><span pos="22603" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="22606" class="es">&lt;</span><span pos="22607" class="en">strong</span><span pos="22613" class="z">&gt;</span><span pos="22614" class="op">{</span><span class="variable">$link</span><span pos="22620" class="op">}</span><span pos="22621" class="sc">&lt;/</span><span pos="22623" class="cl">strong</span><span pos="22629" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        		</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
        		</span><span pos="22665" class="op">}</span><span pos="22666" class="txt">&#xD;
        	</span><span pos="22677" class="sc">&lt;/</span><span pos="22679" class="cl">a</span><span pos="22680" class="z">&gt;</span><span pos="22681" class="sc">&lt;/</span><span pos="22683" class="cl">div</span><span pos="22686" class="z">&gt;</span><span class="whitespace">&#xD;
        </span><span pos="22697" class="op">}</span><span pos="22698" class="txt">&#xD;
    	</span><span pos="22705" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="22707">(: VALUES :)</span><span class="open"></span><span class="whitespace">&#xD;
    	</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">facet-item-sort</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:sort</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="22861">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="function">capitalize-first-chars</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="22982"> [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="22994">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$add-qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
     		</span><span class="comment" pos="23025">(: If the current collection exists in the params, then remove&#xD;
    		   from params, else add to the params :)</span><span class="open"></span><span class="whitespace">&#xD;
    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
        		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    			</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$value</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="op">else</span><span class="whitespace">&#xD;
    			</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    				</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    				</span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$param-name</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="23485">=</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="function">xdmp:url-encode</span><span class="parenthesis">(</span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="23515">&amp;</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$one-qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
     		</span><span class="comment" pos="23552">(: If the current collection exists in the params, then remove&#xD;
    		   from params, else add to the params :)</span><span class="open"></span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$stripped-params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> &#xD;
    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$passed-vals</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    			    </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$passed-vals</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="op">else</span><span class="whitespace">&#xD;
    			    </span><span class="variable">$params</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace">&#xD;
        		</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
        			</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$stripped-params</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
        			</span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$param-name</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="23969">=</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="function">xdmp:url-encode</span><span class="parenthesis">(</span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="23999">&amp;</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace">&#xD;
    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	    		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$mode</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="24068">add</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	    		</span><span pos="24092" class="es">&lt;</span><span pos="24093" class="en">div</span><span pos="24096" class="z">&gt;</span><span pos="24097" class="es">&lt;</span><span pos="24098" class="en">a</span><span pos="24099" class="atn"> href</span><span pos="24104" class="atneq">=</span><span pos="24105" class="z">"</span><span pos="24106" class="av">search.xqy?</span><span pos="24117" class="op">{</span><span class="variable">$add-qs</span><span pos="24125" class="op">}</span><span pos="24126" class="z">"</span><span pos="24127" class="z">&gt;</span><span pos="24128" class="txt">&#xD;
    	    			</span><span pos="24142" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    	    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
    	    				</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	     				</span><span class="parenthesis">(</span><span pos="24266" class="es">&lt;</span><span pos="24267" class="en">img</span><span pos="24270" class="atn"> src</span><span pos="24274" class="atneq">=</span><span pos="24275" class="z">"</span><span pos="24276" class="av">images/silk/bullet_delete.png</span><span pos="24305" class="z">"</span><span pos="24306" class="atn"> class</span><span pos="24312" class="atneq">=</span><span pos="24313" class="z">"</span><span pos="24314" class="av">selected_icon</span><span pos="24327" class="z">"</span><span pos="24328" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="24331" class="es">&lt;</span><span pos="24332" class="en">strong</span><span pos="24338" class="z">&gt;</span><span pos="24339" class="op">{</span><span class="variable">$link</span><span pos="24345" class="op">}</span><span pos="24346" class="sc">&lt;/</span><span pos="24348" class="cl">strong</span><span pos="24354" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	    			</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
    	    			</span><span pos="24394" class="op">}</span><span pos="24395" class="txt">&#xD;
    	    		</span><span pos="24408" class="sc">&lt;/</span><span pos="24410" class="cl">a</span><span pos="24411" class="z">&gt;</span><span pos="24412" class="sc">&lt;/</span><span pos="24414" class="cl">div</span><span pos="24417" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$mode</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="24453">mixed</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	    		</span><span pos="24479" class="es">&lt;</span><span pos="24480" class="en">div</span><span pos="24483" class="z">&gt;</span><span pos="24484" class="es">&lt;</span><span pos="24485" class="en">a</span><span pos="24486" class="atn"> href</span><span pos="24491" class="atneq">=</span><span pos="24492" class="z">"</span><span pos="24493" class="av">search.xqy?</span><span pos="24504" class="op">{</span><span class="variable">$add-qs</span><span pos="24512" class="op">}</span><span pos="24513" class="z">"</span><span pos="24514" class="z">&gt;</span><span pos="24515" class="txt">&#xD;
    	    			</span><span pos="24529" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    	    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
    	    				</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	     				</span><span class="parenthesis">(</span><span pos="24653" class="es">&lt;</span><span pos="24654" class="en">img</span><span pos="24657" class="atn"> src</span><span pos="24661" class="atneq">=</span><span pos="24662" class="z">"</span><span pos="24663" class="av">images/silk/bullet_delete.png</span><span pos="24692" class="z">"</span><span pos="24693" class="atn"> class</span><span pos="24699" class="atneq">=</span><span pos="24700" class="z">"</span><span pos="24701" class="av">selected_icon</span><span pos="24714" class="z">"</span><span pos="24715" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="24718" class="es">&lt;</span><span pos="24719" class="en">strong</span><span pos="24725" class="z">&gt;</span><span pos="24726" class="op">{</span><span class="variable">$link</span><span pos="24732" class="op">}</span><span pos="24733" class="sc">&lt;/</span><span pos="24735" class="cl">strong</span><span pos="24741" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	    			</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
    	    			</span><span pos="24781" class="op">}</span><span pos="24782" class="txt">&#xD;
    	    		</span><span pos="24795" class="sc">&lt;/</span><span pos="24797" class="cl">a</span><span pos="24798" class="z">&gt;</span><span pos="24799" class="op">{</span><span class="op">"</span><span class="literal" pos="24800"> </span><span class="op">"</span><span pos="24803" class="op">}</span><span pos="24804" class="es">&lt;</span><span pos="24805" class="en">a</span><span pos="24806" class="atn"> href</span><span pos="24811" class="atneq">=</span><span pos="24812" class="z">"</span><span pos="24813" class="av">search.xqy?</span><span pos="24824" class="op">{</span><span class="variable">$one-qs</span><span pos="24832" class="op">}</span><span pos="24833" class="z">"</span><span pos="24834" class="z">&gt;</span><span pos="24835" class="txt">(only)</span><span pos="24841" class="sc">&lt;/</span><span pos="24843" class="cl">a</span><span pos="24844" class="z">&gt;</span><span pos="24845" class="sc">&lt;/</span><span pos="24847" class="cl">div</span><span pos="24850" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
                </span><span class="op">else</span><span class="whitespace">&#xD;
    	    		</span><span pos="24886" class="es">&lt;</span><span pos="24887" class="en">div</span><span pos="24890" class="z">&gt;</span><span pos="24891" class="es">&lt;</span><span pos="24892" class="en">a</span><span pos="24893" class="atn"> href</span><span pos="24898" class="atneq">=</span><span pos="24899" class="z">"</span><span pos="24900" class="av">search.xqy?</span><span pos="24911" class="op">{</span><span class="variable">$one-qs</span><span pos="24919" class="op">}</span><span pos="24920" class="z">"</span><span pos="24921" class="z">&gt;</span><span pos="24922" class="txt">&#xD;
    	    			</span><span pos="24936" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    	    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
    	    				</span><span class="variable">$params</span><span class="step">/</span><span class="qname">val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	     				</span><span class="parenthesis">(</span><span pos="25060" class="es">&lt;</span><span pos="25061" class="en">img</span><span pos="25064" class="atn"> src</span><span pos="25068" class="atneq">=</span><span pos="25069" class="z">"</span><span pos="25070" class="av">images/silk/bullet_black.png</span><span pos="25098" class="z">"</span><span pos="25099" class="atn"> class</span><span pos="25105" class="atneq">=</span><span pos="25106" class="z">"</span><span pos="25107" class="av">selected_icon</span><span pos="25120" class="z">"</span><span pos="25121" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="25124" class="es">&lt;</span><span pos="25125" class="en">strong</span><span pos="25131" class="z">&gt;</span><span pos="25132" class="op">{</span><span class="variable">$link</span><span pos="25138" class="op">}</span><span pos="25139" class="sc">&lt;/</span><span pos="25141" class="cl">strong</span><span pos="25147" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	    			</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
    	    			</span><span pos="25187" class="op">}</span><span pos="25188" class="txt">&#xD;
    	    		</span><span pos="25201" class="sc">&lt;/</span><span pos="25203" class="cl">a</span><span pos="25204" class="z">&gt;</span><span pos="25205" class="sc">&lt;/</span><span pos="25207" class="cl">div</span><span pos="25210" class="z">&gt;</span><span class="whitespace">&#xD;
                &#xD;
	    	</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
 		</span><span pos="25249" class="op">}</span><span pos="25250" class="txt">&#xD;
 		</span><span pos="25255" class="sc">&lt;/</span><span pos="25257" class="cl">div</span><span pos="25260" class="z">&gt;</span><span pos="25261" class="txt">&#xD;
 	</span><span pos="25265" class="sc">&lt;/</span><span pos="25267" class="cl">div</span><span pos="25270" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">value-heatmap</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$title</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:title</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$icon</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:icon</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$all-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="quantifier">?</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:all</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="whitespace">&#xD;
    	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer*</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="whitespace">&#xD;
    	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="quantifier">?</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:max</span><span class="parenthesis">(</span><span class="variable">$max-count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="25788">hval</span><span class="op">"</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="25849">p</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs-id</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:qs-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="25991">:all</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        &#xD;
        </span><span class="comment" pos="26018">(: Value Management :)</span><span class="whitespace">&#xD;
        </span><span class="comment" pos="26050">(: Selects the param values that are within scope of (ie have been returned from) the current facet :)</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="26316">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$passed-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:starts-with</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$qs-id</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$out-of-scope-vals</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$passed-vals</span><span class="whitespace">&#xD;
            </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$val</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$val</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$out-of-scope-vals</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$out-of-scope-vals</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace">&#xD;
        &#xD;
    	</span><span class="op">return</span><span class="whitespace">&#xD;
    	</span><span pos="26829" class="es">&lt;</span><span pos="26830" class="en">div</span><span pos="26833" class="z">&gt;</span><span pos="26834" class="txt">&#xD;
            </span><span pos="26848" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$icon</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span pos="26866" class="es">&lt;</span><span pos="26867" class="en">img</span><span pos="26870" class="atn"> class</span><span pos="26876" class="atneq">=</span><span pos="26877" class="z">"</span><span pos="26878" class="av">icon</span><span pos="26882" class="z">"</span><span pos="26883" class="atn"> src</span><span pos="26887" class="atneq">=</span><span pos="26888" class="z">"</span><span pos="26889" class="op">{</span><span class="variable">$icon</span><span pos="26895" class="op">}</span><span pos="26896" class="z">"</span><span pos="26897" class="atn"> </span><span pos="26898" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span class="op">"</span><span class="literal" pos="26901"> </span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="26913" class="op">}</span><span pos="26914" class="es">&lt;</span><span pos="26915" class="en">strong</span><span pos="26921" class="z">&gt;</span><span pos="26922" class="op">{</span><span class="variable">$title</span><span pos="26929" class="op">}</span><span pos="26930" class="sc">&lt;/</span><span pos="26932" class="cl">strong</span><span pos="26938" class="z">&gt;</span><span pos="26939" class="txt">: &#xD;
            </span><span pos="26955" class="es">&lt;</span><span pos="26956" class="en">span</span><span pos="26960" class="atn"> class</span><span pos="26966" class="atneq">=</span><span pos="26967" class="z">"</span><span pos="26968" class="av">heatmap</span><span pos="26975" class="z">"</span><span pos="26976" class="atn"> xml:space</span><span pos="26986" class="atneq">=</span><span pos="26987" class="z">"</span><span pos="26988" class="av">preserve</span><span pos="26996" class="z">"</span><span pos="26997" class="z">&gt;</span><span pos="26998" class="txt">&#xD;
    		</span><span pos="27006" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="27008">(: ALL :)</span><span class="open"></span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$newParams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$facet-vals</span><span class="op">,</span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:all</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$newParams</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="27251">[CLEAR &amp;raquo;]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="op">return</span><span class="whitespace">			&#xD;
            	</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
            	    </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$facet-vals</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace">&#xD;
            		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="op">else</span><span class="whitespace"> </span><span pos="27462" class="es">&lt;</span><span pos="27463" class="en">a</span><span pos="27464" class="atn"> href</span><span pos="27469" class="atneq">=</span><span pos="27470" class="z">"</span><span pos="27471" class="av">search.xqy?</span><span pos="27482" class="op">{</span><span class="variable">$qs</span><span pos="27486" class="op">}</span><span pos="27487" class="z">"</span><span pos="27488" class="z">&gt;</span><span pos="27489" class="es">&lt;</span><span pos="27490" class="en">strong</span><span pos="27496" class="z">&gt;</span><span pos="27497" class="op">{</span><span class="variable">$link</span><span pos="27503" class="op">}</span><span pos="27504" class="sc">&lt;/</span><span pos="27506" class="cl">strong</span><span pos="27512" class="z">&gt;</span><span pos="27513" class="sc">&lt;/</span><span pos="27515" class="cl">a</span><span pos="27516" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span pos="27531" class="op">}</span><span pos="27532" class="txt">&#xD;
        	</span><span pos="27543" class="op">{</span><span class="whitespace"> </span><span class="comment" pos="27545">(: VALUES :)</span><span class="open"></span><span class="whitespace">&#xD;
        	</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">facet-item-sort</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:sort</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$qs-id</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="27707">:</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">capitalize-first-chars</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    		</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
     			</span><span class="comment" pos="27867">(: If the current collection exists in the params, then remove&#xD;
    			   from params, else add to the params :)</span><span class="open"></span><span class="whitespace">&#xD;
    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
    	    		</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    				</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$value</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="op">else</span><span class="whitespace">&#xD;
    				</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    					</span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="variable">$param-name</span><span class="op">,</span><span class="variable">$set-selector</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    					</span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$param-name</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="28337">=</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="function">xdmp:url-encode</span><span class="parenthesis">(</span><span class="variable">$value</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="28367">&amp;</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        	</span><span class="op">return</span><span class="whitespace">&#xD;
        		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	    		</span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="28434"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span pos="28438" class="es">&lt;</span><span pos="28439" class="en">a</span><span pos="28440" class="atn"> href</span><span pos="28445" class="atneq">=</span><span pos="28446" class="z">"</span><span pos="28447" class="av">search.xqy?</span><span pos="28458" class="op">{</span><span class="variable">$qs</span><span pos="28462" class="op">}</span><span pos="28463" class="z">"</span><span pos="28464" class="z">&gt;</span><span pos="28465" class="es">&lt;</span><span pos="28466" class="en">span</span><span pos="28470" class="atn"> title</span><span pos="28476" class="atneq">=</span><span pos="28477" class="z">"</span><span pos="28478" class="op">{</span><span class="variable">$count</span><span pos="28485" class="op">}</span><span pos="28486" class="av"> documents</span><span pos="28496" class="z">"</span><span pos="28497" class="atn"> class</span><span pos="28503" class="atneq">=</span><span pos="28504" class="z">"</span><span pos="28505" class="av">heat</span><span pos="28509" class="op">{</span><span class="function">determine-heat</span><span class="parenthesis">(</span><span class="variable">$all-count</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$count</span><span class="parenthesis">)</span><span pos="28556" class="op">}</span><span pos="28557" class="z">"</span><span pos="28558" class="z">&gt;</span><span pos="28559" class="txt">&#xD;
    	    			</span><span pos="28573" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    	    			</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$set-selector</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> &#xD;
    	    				</span><span class="variable">$params</span><span class="step">/</span><span class="qname">hval</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    	     				</span><span class="parenthesis">(</span><span pos="28699" class="es">&lt;</span><span pos="28700" class="en">strong</span><span pos="28706" class="atn"> class</span><span pos="28712" class="atneq">=</span><span pos="28713" class="z">"</span><span pos="28714" class="av">selected</span><span pos="28722" class="z">"</span><span pos="28723" class="z">&gt;</span><span pos="28724" class="op">{</span><span class="variable">$link</span><span pos="28730" class="op">}</span><span pos="28731" class="sc">&lt;/</span><span pos="28733" class="cl">strong</span><span pos="28739" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	    			</span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
    	    			</span><span pos="28779" class="op">}</span><span pos="28780" class="txt">&#xD;
    	    		</span><span pos="28793" class="sc">&lt;/</span><span pos="28795" class="cl">span</span><span pos="28799" class="z">&gt;</span><span pos="28800" class="sc">&lt;/</span><span pos="28802" class="cl">a</span><span pos="28803" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    	    	</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
     		</span><span pos="28833" class="op">}</span><span pos="28834" class="txt">&#xD;
             &#xD;
            </span><span pos="28863" class="sc">&lt;/</span><span pos="28865" class="cl">span</span><span pos="28869" class="z">&gt;</span><span pos="28870" class="txt">&#xD;
     	</span><span pos="28878" class="sc">&lt;/</span><span pos="28880" class="cl">div</span><span pos="28883" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
 	</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">trailing-date-facet</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:facet</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$title</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:facet-def</span><span class="step">/</span><span class="qname">search:custom</span><span class="step">/</span><span class="qname">search:title</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="29141">p</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span pos="29171" class="es">&lt;</span><span pos="29172" class="en">div</span><span pos="29175" class="z">&gt;</span><span pos="29176" class="txt">&#xD;
        	</span><span pos="29187" class="op">{</span><span class="comment" pos="29188">(: Only display the date facets when there is no start and non-valid end fields :)</span><span pos="29270" class="op">}</span><span pos="29271" class="txt">&#xD;
    	    </span><span pos="29282" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$title</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="29300" class="es">&lt;</span><span pos="29301" class="en">h3</span><span pos="29303" class="z">&gt;</span><span pos="29304" class="op">{</span><span class="variable">$title</span><span pos="29311" class="op">}</span><span pos="29312" class="sc">&lt;/</span><span pos="29314" class="cl">h3</span><span pos="29316" class="z">&gt;</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="29325" class="op">}</span><span pos="29326" class="txt">&#xD;
            </span><span pos="29340" class="es">&lt;</span><span pos="29341" class="en">div</span><span pos="29344" class="atn"> class</span><span pos="29350" class="atneq">=</span><span pos="29351" class="z">"</span><span pos="29352" class="av">search_facet</span><span pos="29364" class="z">"</span><span pos="29365" class="z">&gt;</span><span pos="29366" class="txt">&#xD;
    		</span><span pos="29374" class="op">{</span><span class="whitespace">&#xD;
    			</span><span class="comment" pos="29384">(: ALL :)</span><span class="open"></span><span class="whitespace">&#xD;
    			</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$newParams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
    				</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="29459">dur</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:all</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$newParams</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="29631">All [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="29646">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="op">return</span><span class="whitespace">					&#xD;
    				</span><span pos="29680" class="es">&lt;</span><span pos="29681" class="en">div</span><span pos="29684" class="z">&gt;</span><span pos="29685" class="es">&lt;</span><span pos="29686" class="en">a</span><span pos="29687" class="atn"> href</span><span pos="29692" class="atneq">=</span><span pos="29693" class="z">"</span><span pos="29694" class="av">search.xqy?</span><span pos="29705" class="op">{</span><span class="variable">$qs</span><span pos="29709" class="op">}</span><span pos="29710" class="z">"</span><span pos="29711" class="z">&gt;</span><span pos="29712" class="txt">&#xD;
    				</span><span pos="29722" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    				</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="step">/</span><span class="node">text(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    					</span><span class="parenthesis">(</span><span pos="29783" class="es">&lt;</span><span pos="29784" class="en">img</span><span pos="29787" class="atn"> src</span><span pos="29791" class="atneq">=</span><span pos="29792" class="z">"</span><span pos="29793" class="av">images/silk/bullet_go.png</span><span pos="29818" class="z">"</span><span pos="29819" class="atn"> class</span><span pos="29825" class="atneq">=</span><span pos="29826" class="z">"</span><span pos="29827" class="av">selected_icon</span><span pos="29840" class="z">"</span><span pos="29841" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="29844" class="es">&lt;</span><span pos="29845" class="en">strong</span><span pos="29851" class="z">&gt;</span><span pos="29852" class="op">{</span><span class="variable">$link</span><span pos="29858" class="op">}</span><span pos="29859" class="sc">&lt;/</span><span pos="29861" class="cl">strong</span><span pos="29867" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    				</span><span class="op">else</span><span class="whitespace">&#xD;
    					</span><span class="variable">$link</span><span class="whitespace">&#xD;
    				</span><span pos="29909" class="op">}</span><span pos="29910" class="txt">&#xD;
    				</span><span pos="29920" class="sc">&lt;/</span><span pos="29922" class="cl">a</span><span pos="29923" class="z">&gt;</span><span pos="29924" class="txt">&#xD;
    				</span><span pos="29934" class="sc">&lt;/</span><span pos="29936" class="cl">div</span><span pos="29939" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
    			</span><span class="op">,</span><span class="whitespace">&#xD;
    			</span><span class="comment" pos="29959">(: DURATIONS :)</span><span class="open"></span><span class="whitespace">&#xD;
                </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="variable">$pos</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$facet</span><span class="step">/</span><span class="qname">search:item</span><span class="whitespace">&#xD;
    			</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$value</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">xs:duration</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$desc</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    			</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$newParams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
    				</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="30183">dur</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span pos="30190" class="es">&lt;</span><span pos="30191" class="en">dur</span><span pos="30194" class="z">&gt;</span><span pos="30195" class="op">{</span><span class="variable">$value</span><span pos="30202" class="op">}</span><span pos="30203" class="sc">&lt;/</span><span pos="30205" class="cl">dur</span><span pos="30208" class="z">&gt;</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$qs</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$newParams</span><span class="op">,</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$desc</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="30376"> [</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$count</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="30388">]</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span class="op">return</span><span class="whitespace">			&#xD;
                    </span><span pos="30441" class="es">&lt;</span><span pos="30442" class="en">div</span><span pos="30445" class="z">&gt;</span><span pos="30446" class="es">&lt;</span><span pos="30447" class="en">a</span><span pos="30448" class="atn"> href</span><span pos="30453" class="atneq">=</span><span pos="30454" class="z">"</span><span pos="30455" class="av">search.xqy?</span><span pos="30466" class="op">{</span><span class="variable">$qs</span><span pos="30470" class="op">}</span><span pos="30471" class="z">"</span><span pos="30472" class="z">&gt;</span><span pos="30473" class="txt">&#xD;
                        </span><span pos="30499" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
                        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$value</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
                         	</span><span class="parenthesis">(</span><span pos="30585" class="es">&lt;</span><span pos="30586" class="en">img</span><span pos="30589" class="atn"> src</span><span pos="30593" class="atneq">=</span><span pos="30594" class="z">"</span><span pos="30595" class="av">images/silk/bullet_go.png</span><span pos="30620" class="z">"</span><span pos="30621" class="atn"> class</span><span pos="30627" class="atneq">=</span><span pos="30628" class="z">"</span><span pos="30629" class="av">selected_icon</span><span pos="30642" class="z">"</span><span pos="30643" class="z">/&gt;</span><span class="open"></span><span class="op">,</span><span pos="30646" class="es">&lt;</span><span pos="30647" class="en">strong</span><span pos="30653" class="z">&gt;</span><span pos="30654" class="op">{</span><span class="variable">$link</span><span pos="30660" class="op">}</span><span pos="30661" class="sc">&lt;/</span><span pos="30663" class="cl">strong</span><span pos="30669" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$link</span><span class="whitespace">&#xD;
                        </span><span pos="30733" class="op">}</span><span pos="30734" class="txt">&#xD;
                    </span><span pos="30756" class="sc">&lt;/</span><span pos="30758" class="cl">a</span><span pos="30759" class="z">&gt;</span><span pos="30760" class="sc">&lt;/</span><span pos="30762" class="cl">div</span><span pos="30765" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span pos="30780" class="op">}</span><span pos="30781" class="txt">&#xD;
    		</span><span pos="30789" class="sc">&lt;/</span><span pos="30791" class="cl">div</span><span pos="30794" class="z">&gt;</span><span pos="30795" class="txt">&#xD;
        </span><span pos="30805" class="sc">&lt;/</span><span pos="30807" class="cl">div</span><span pos="30810" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">determine-heat</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$all-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$item-count</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="comment" pos="30966">(: With this formula, an item can range from 0-67% :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="comment" pos="31025">(: Lower ranges are wider than higher ranges :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$comp-num</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$all-count</span><span class="whitespace"> </span><span class="op">*</span><span class="whitespace"> </span><span class="numeric">.5</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$item-pct</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$item-count</span><span class="whitespace"> </span><span class="op">div</span><span class="whitespace"> </span><span class="variable">$comp-num</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$max-pct</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">div</span><span class="whitespace"> </span><span class="variable">$comp-num</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$item-pct</span><span class="whitespace"> </span><span class="op">div</span><span class="whitespace"> </span><span class="variable">$max-pct</span><span class="whitespace"> &#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    &#xD;
    </span><span class="comment" pos="31289">(: apply specific controls :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="comment" pos="31324">(: These are a hack for now. Will need to tune this later :)</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$item-count</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> &#xD;
        </span><span class="numeric">2</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$all-count</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$max-count</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$item-count</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">4</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace">&#xD;
    &#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">.25</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">1</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">.46</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">2</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">.63</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">3</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">.77</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">4</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xfrm-pct</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="numeric">.89</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="numeric">5</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">6</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">facet-item-sort</span><span class="parenthesis">(</span><span class="variable">$items</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:item</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="quantifier">?</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:item</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:lower-case</span><span class="parenthesis">(</span><span class="variable">$type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="31938">name-asc</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace">&#xD;
        </span><span class="type-op">order by</span><span class="whitespace"> </span><span class="node-type">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">ascending</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:lower-case</span><span class="parenthesis">(</span><span class="variable">$type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="32088">name-desc</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace">&#xD;
        </span><span class="type-op">order by</span><span class="whitespace"> </span><span class="node-type">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">descending</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:lower-case</span><span class="parenthesis">(</span><span class="variable">$type</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="32240">count</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace">&#xD;
        </span><span class="type-op">order by</span><span class="whitespace"> </span><span class="node-type">xs:integer</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">count</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">descending</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace">&#xD;
        </span><span class="variable">$items</span><span class="whitespace">        &#xD;
</span><span class="op">}</span><span class="whitespace"> &#xD;
&#xD;
</span><span class="comment" pos="32400">(: Highlighting functions :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="32432">(:~&#xD;
:&#xD;
: (Public) Will highlight a node based on the full-text search inside&#xD;
: a search-criteria. Compatible with the create-snippet and create-summary functions.&#xD;
:&#xD;
: @param $node The node to be highlighted&#xD;
: @param $query The search-criteria to be used to perform the highlighting.&#xD;
: @return The highlighted node. If not highlighting query can be built, then returns nothing.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">highlight</span><span class="parenthesis">(</span><span class="variable">$node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$query</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:search-criteria</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$highlight-query</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">create-highlight-query</span><span class="parenthesis">(</span><span class="variable">$query</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$highlight-query</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span class="function">cts:highlight</span><span class="parenthesis">(</span><span class="variable">$node</span><span class="op">,</span><span class="variable">$highlight-query</span><span class="op">,</span><span pos="33075" class="es">&lt;</span><span pos="33076" class="en">span</span><span pos="33080" class="atn"> class</span><span pos="33086" class="atneq">=</span><span pos="33087" class="z">"</span><span pos="33088" class="av">ml-highlight</span><span pos="33100" class="z">"</span><span pos="33101" class="z">&gt;</span><span pos="33102" class="op">{</span><span class="variable">$cts:text</span><span pos="33112" class="op">}</span><span pos="33113" class="sc">&lt;/</span><span pos="33115" class="cl">span</span><span pos="33119" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="33145">(:~&#xD;
:&#xD;
: (Public) Builds a cts:query from a search-criteria element suitable for highlighting a node. &#xD;
:&#xD;
: @param $query The search-criteria to be used to perform the highlighting.&#xD;
: @return The highlight query. If not highlighting query can be built, then returns nothing.&#xD;
:)</span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">create-highlight-query</span><span class="parenthesis">(</span><span class="variable">$query</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">search:search-criteria</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">cts:query</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="function">search:build-term-query</span><span class="parenthesis">(</span><span class="function">search:resolve</span><span class="parenthesis">(</span><span class="variable">$query</span><span class="step">/</span><span class="qname">search:term</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="33598">(: Search snippet functions :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="33632">(:~&#xD;
:&#xD;
: (Public) Renders a search result summary, which can be either the abstract of the document or&#xD;
: snippets of the document if it has been highlighted as a result of a full-text search.&#xD;
: If snippets are available, then a click-and-zoom link can also be enabled. To enable click-and-zoom&#xD;
: there must be a page that can handle a request in the format:&#xD;
: &#xD;
: request.xqy?action=show-section&amp;uri=[*]&amp;path=[*]&#xD;
: &#xD;
: The function sdis:show-section (below), can then be called to fullfil the request.&#xD;
:&#xD;
: @param $orig-node The original document. Should be an active reference to a node in the&#xD;
    repository and not dynamically constructed.&#xD;
: @param $snippet-node A highligted node, that contains the portions of the original&#xD;
    document that should be snippeted. A common design pattern is to pass only the body&#xD;
    of an article as the $snippet-node.&#xD;
: @param $default-summary If a snippet-node is not included, or nothing was highlighted,&#xD;
    then this variable will be used. This commonly is the first 1 or 2 paragraphs or the&#xD;
    abstract of a document.&#xD;
: @return A rendered HTML summary or snippet interface.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">create-summary</span><span class="parenthesis">(</span><span class="variable">$orig-node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$snippet-node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$default-summary</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type">item</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$do-zoom</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:boolean</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$uri</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">xdmp:node-uri</span><span class="parenthesis">(</span><span class="variable">$orig-node</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$snippets</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$snippet-node</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">create-snippets</span><span class="parenthesis">(</span><span class="variable">$snippet-node</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$summary</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
		</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:exists</span><span class="parenthesis">(</span><span class="variable">$snippets</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
			</span><span class="parenthesis">(</span><span pos="35098" class="es">&lt;</span><span pos="35099" class="en">p</span><span pos="35100" class="atn"> class</span><span pos="35106" class="atneq">=</span><span pos="35107" class="z">"</span><span pos="35108" class="av">summary</span><span pos="35115" class="z">"</span><span pos="35116" class="z">&gt;</span><span pos="35117" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
			</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$snippets</span><span class="step">/</span><span class="qname">span</span><span class="whitespace">&#xD;
			</span><span class="op">return</span><span class="whitespace"> &#xD;
			    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$do-zoom</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    			    </span><span pos="35210" class="es">&lt;</span><span pos="35211" class="en">span</span><span pos="35215" class="z">&gt;</span><span pos="35216" class="txt">&#xD;
    			    </span><span pos="35229" class="op">{</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">title</span><span pos="35242" class="op">}</span><span pos="35243" class="txt">&#xD;
    			    </span><span pos="35256" class="es">&lt;</span><span pos="35257" class="en">span</span><span pos="35261" class="z">&gt;</span><span pos="35262" class="txt">&#xD;
    			    </span><span pos="35275" class="op">{</span><span class="variable">$item</span><span class="step">/</span><span class="node">node(</span><span class="parenthesis">)</span><span pos="35288" class="op">}</span><span pos="35289" class="txt">&#xD;
    			    </span><span pos="35302" class="es">&lt;</span><span pos="35303" class="en">b</span><span pos="35304" class="z">&gt;</span><span pos="35305" class="txt">...</span><span pos="35308" class="sc">&lt;/</span><span pos="35310" class="cl">b</span><span pos="35311" class="z">&gt;</span><span pos="35312" class="txt">&amp;nbsp;&#xD;
    				</span><span pos="35328" class="sc">&lt;/</span><span pos="35330" class="cl">span</span><span pos="35334" class="z">&gt;</span><span pos="35335" class="txt">&#xD;
    				</span><span pos="35345" class="sc">&lt;/</span><span pos="35347" class="cl">span</span><span pos="35351" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
			    </span><span class="op">else</span><span class="whitespace">&#xD;
    			    </span><span pos="35378" class="es">&lt;</span><span pos="35379" class="en">a</span><span pos="35380" class="atn"> href</span><span pos="35385" class="atneq">=</span><span pos="35386" class="z">"</span><span pos="35387" class="av">javascript:void(0);</span><span pos="35406" class="z">"</span><span pos="35407" class="atn"> onmouseout</span><span pos="35418" class="atneq">=</span><span pos="35419" class="z">"</span><span pos="35420" class="av">$('abs_</span><span pos="35427" class="op">{</span><span class="variable">$uri</span><span pos="35432" class="op">}</span><span pos="35433" class="av">').addClassName(hideClass);</span><span pos="35460" class="z">"</span><span pos="35461" class="atn"> onclick</span><span pos="35469" class="atneq">=</span><span pos="35470" class="z">"</span><span pos="35471" class="av">toggleLoadedContent('abs_</span><span pos="35496" class="op">{</span><span class="function">fn:data</span><span class="parenthesis">(</span><span class="variable">$uri</span><span class="parenthesis">)</span><span pos="35510" class="op">}</span><span pos="35511" class="av">','request.xqy',{{method:'post',postBody:'action=show-section&amp;uri=</span><span pos="35577" class="op">{</span><span class="function">xdmp:url-encode</span><span class="parenthesis">(</span><span class="variable">$uri</span><span class="parenthesis">)</span><span pos="35599" class="op">}</span><span pos="35600" class="av">&amp;path=</span><span pos="35606" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">title</span><span class="parenthesis">)</span><span pos="35630" class="op">}</span><span pos="35631" class="av">',asynchronous:true},true);</span><span pos="35658" class="z">"</span><span pos="35659" class="z">&gt;</span><span pos="35660" class="txt">&#xD;
    			    </span><span pos="35673" class="op">{</span><span class="variable">$item</span><span class="step">/</span><span class="axis">@</span><span class="qname">title</span><span pos="35686" class="op">}</span><span pos="35687" class="txt">&#xD;
    			    </span><span pos="35700" class="es">&lt;</span><span pos="35701" class="en">span</span><span pos="35705" class="z">&gt;</span><span pos="35706" class="txt">&#xD;
    			    </span><span pos="35719" class="op">{</span><span class="variable">$item</span><span class="step">/</span><span class="node">node(</span><span class="parenthesis">)</span><span pos="35732" class="op">}</span><span pos="35733" class="txt">&#xD;
    			    </span><span pos="35746" class="es">&lt;</span><span pos="35747" class="en">b</span><span pos="35748" class="z">&gt;</span><span pos="35749" class="txt">...</span><span pos="35752" class="sc">&lt;/</span><span pos="35754" class="cl">b</span><span pos="35755" class="z">&gt;</span><span pos="35756" class="txt">&amp;nbsp;&#xD;
    				</span><span pos="35772" class="sc">&lt;/</span><span pos="35774" class="cl">span</span><span pos="35778" class="z">&gt;</span><span pos="35779" class="txt">&#xD;
    				</span><span pos="35789" class="sc">&lt;/</span><span pos="35791" class="cl">a</span><span pos="35792" class="z">&gt;</span><span class="whitespace">&#xD;
			</span><span pos="35798" class="op">}</span><span pos="35799" class="sc">&lt;/</span><span pos="35801" class="cl">p</span><span pos="35802" class="z">&gt;</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
		</span><span class="op">else</span><span class="whitespace">&#xD;
		   </span><span class="variable">$default-summary</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
		</span><span class="parenthesis">(</span><span pos="35852" class="es">&lt;</span><span pos="35853" class="en">div</span><span pos="35856" class="atn"> class</span><span pos="35862" class="atneq">=</span><span pos="35863" class="z">"</span><span pos="35864" class="av">summary</span><span pos="35871" class="z">"</span><span pos="35872" class="z">&gt;</span><span pos="35873" class="txt">&#xD;
		</span><span pos="35877" class="op">{</span><span class="open"></span><span class="variable">$summary</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="35888"> </span><span class="op">"</span><span pos="35891" class="op">}</span><span pos="35892" class="txt">&#xD;
		</span><span pos="35896" class="sc">&lt;/</span><span pos="35898" class="cl">div</span><span pos="35901" class="z">&gt;</span><span class="open"></span><span class="op">,</span><span class="whitespace">&#xD;
        </span><span pos="35913" class="es">&lt;</span><span pos="35914" class="en">div</span><span pos="35917" class="atn"> id</span><span pos="35920" class="atneq">=</span><span pos="35921" class="z">"</span><span pos="35922" class="av">abs_</span><span pos="35926" class="op">{</span><span class="variable">$uri</span><span pos="35931" class="op">}</span><span pos="35932" class="z">"</span><span pos="35933" class="atn"> class</span><span pos="35939" class="atneq">=</span><span pos="35940" class="z">"</span><span pos="35941" class="av">abstract hidden</span><span pos="35956" class="z">"</span><span pos="35957" class="z">&gt;</span><span pos="35958" class="txt">|</span><span pos="35959" class="sc">&lt;/</span><span pos="35961" class="cl">div</span><span pos="35964" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="35973">(:~&#xD;
:&#xD;
: (Public) Renders snippets based on a highlighted node. The element used for&#xD;
: highlighting should be &lt;span class="ml-highlight"&gt;. sdis:highlight is a great option&#xD;
: as a compatible highlighting function.&#xD;
:&#xD;
: @param $highlighted-node The node highlighted with &lt;span class="ml-highlight"&gt;&#xD;
: @return A &lt;div&gt; containing the rendered snippets.&#xD;
:)</span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">create-snippets</span><span class="parenthesis">(</span><span class="variable">$highlighted-node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace"> </span><span class="function">create-snippets</span><span class="parenthesis">(</span><span class="variable">$highlighted-node</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">4</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">11</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="36443">(:~&#xD;
:&#xD;
: (Public) Renders snippets based on a highlighted node. The element used for&#xD;
: highlighting should be &lt;span class="ml-highlight"&gt;. sdis:highlight is a great option&#xD;
: as a compatible highlighting function.&#xD;
:&#xD;
: @param $highlighted-node The node highlighted with &lt;span class="ml-highlight"&gt;&#xD;
: @param $max-snippet-matches The total number of snippets that are returned.&#xD;
: @param $truncate-words The total number of words a snippet will contain.&#xD;
: @return A &lt;div&gt; containing the rendered snippets.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">create-snippets</span><span class="parenthesis">(</span><span class="variable">$highlighted-node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$max-snippet-matches</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">div</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$matches</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$highlighted-node</span><span class="step">//</span><span class="qname">span</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="op">=</span><span class="op">"</span><span class="literal" pos="37158">ml-highlight</span><span class="op">"</span><span class="open"></span><span class="filter">]</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$max-snippet-matches</span><span class="filter">]</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$hits</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$hit</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="variable">$pos</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$matches</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span class="parenthesis">(</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$pos</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="37299"> ... </span><span class="op">"</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span pos="37316" class="es">&lt;</span><span pos="37317" class="en">span</span><span pos="37321" class="atn"> title</span><span pos="37327" class="atneq">=</span><span pos="37328" class="z">"</span><span pos="37329" class="op">{</span><span class="function">xpath</span><span class="parenthesis">(</span><span class="variable">$hit</span><span class="step">/</span><span class="axis">parent::</span><span class="qname">*</span><span class="parenthesis">)</span><span pos="37351" class="op">}</span><span pos="37352" class="z">"</span><span pos="37353" class="atn"> class</span><span pos="37359" class="atneq">=</span><span pos="37360" class="z">"</span><span pos="37361" class="av">ml-snippet</span><span pos="37371" class="z">"</span><span pos="37372" class="z">&gt;</span><span pos="37373" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
                </span><span class="function">truncate-text</span><span class="parenthesis">(</span><span pos="37406" class="es">&lt;</span><span pos="37407" class="en">span</span><span pos="37411" class="atn"> class</span><span pos="37417" class="atneq">=</span><span pos="37418" class="z">"</span><span pos="37419" class="av">ml-wrapper</span><span pos="37429" class="z">"</span><span pos="37430" class="z">&gt;</span><span pos="37431" class="op">{</span><span class="parenthesis">(</span><span class="variable">$hit</span><span class="step">/</span><span class="axis">preceding-sibling::</span><span class="node">node(</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$hit</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$hit</span><span class="step">/</span><span class="axis">following-sibling::</span><span class="node">node(</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span pos="37508" class="op">}</span><span pos="37509" class="sc">&lt;/</span><span pos="37511" class="cl">span</span><span pos="37515" class="z">&gt;</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="37548" class="op">}</span><span pos="37549" class="sc">&lt;/</span><span pos="37551" class="cl">span</span><span pos="37555" class="z">&gt;</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$hits</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span pos="37600" class="es">&lt;</span><span pos="37601" class="en">div</span><span pos="37604" class="atn"> class</span><span pos="37610" class="atneq">=</span><span pos="37611" class="z">"</span><span pos="37612" class="av">snippets</span><span pos="37620" class="z">"</span><span pos="37621" class="z">&gt;</span><span pos="37622" class="op">{</span><span class="variable">$hits</span><span pos="37628" class="op">}</span><span pos="37629" class="sc">&lt;/</span><span pos="37631" class="cl">div</span><span pos="37634" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="37664">(: In order for this function to work properly, you must declare all the&#xD;
namespaces used in your content at the top of this file :)</span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">xpath</span><span class="parenthesis">(</span><span class="variable">$node</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="function">xdmp:path</span><span class="parenthesis">(</span><span class="variable">$node</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="37868">(:~&#xD;
:&#xD;
: Returns the configured number of words before and after the highlight term.&#xD;
:&#xD;
: @param $x An item to be trucated.&#xD;
: @return The truncated text.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">truncate-text</span><span class="parenthesis">(</span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type">item</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:integer</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type">item</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$x</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace">&#xD;
       </span><span class="function">typeswitch</span><span class="parenthesis">(</span><span class="variable">$x</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
       </span><span class="axis">case</span><span class="whitespace"> </span><span class="node">text(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span class="comment" pos="38218">(: is there a highlight node before? :)</span><span class="open"></span><span class="whitespace">&#xD;
             </span><span class="parenthesis">(</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$x</span><span class="step">/</span><span class="axis">preceding-sibling::</span><span class="node">node(</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="filter">[</span><span class="axis">self::</span><span class="qname">span</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="38330">ml-highlight</span><span class="op">"</span><span class="open"></span><span class="filter">]</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                     </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="comment" pos="38376">(: if so, print the first $g_num words :)</span><span class="whitespace">&#xD;
                        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">cts:tokenize</span><span class="parenthesis">(</span><span class="variable">$x</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$truncateTokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&lt;</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="comment" pos="38612">(: &gt; :)</span><span class="whitespace">&#xD;
                                          </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="filter">]</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                        </span><span class="op">return</span><span class="whitespace">&#xD;
                        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&lt;</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="comment" pos="38851">(: &gt; :)</span><span class="open"></span><span class="whitespace">&#xD;
                        </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="comment" pos="38891">(: is there a highlight node after? :)</span><span class="open"></span><span class="whitespace">&#xD;
                              </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$x</span><span class="step">/</span><span class="axis">following-sibling::</span><span class="node">node(</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="filter">[</span><span class="axis">self::</span><span class="qname">span</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="39018">ml-highlight</span><span class="op">"</span><span class="open"></span><span class="filter">]</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                              </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="comment" pos="39074">(: if there is a highlight node after, we do&#xD;
                                        not want to double count it :)</span><span class="open"></span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                              </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace">&#xD;
                                </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
                   </span><span class="comment" pos="39295">(: If the first token is punctuation, then no space before :)</span><span class="open"></span><span class="whitespace">&#xD;
                                 </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="type-op">instance of</span><span class="whitespace"> </span><span class="type-name">cts:punctuation</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="39476"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="39520"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="39550"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                             </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
                     </span><span class="comment" pos="39655">(: If the first token is punctuation, then no space before :)</span><span class="open"></span><span class="whitespace">&#xD;
                                 </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$truncateTokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="type-op">instance of</span><span class="whitespace"> </span><span class="type-name">cts:punctuation</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="39844"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="39888"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$truncateTokens</span><span class="whitespace"> </span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="39928"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
                                      </span><span class="op">"</span><span class="literal" pos="39972"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                             </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                      </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
&#xD;
                     </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="40064"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
            </span><span class="comment" pos="40082">(: is there a highlight node after? :)</span><span class="open"></span><span class="whitespace">&#xD;
            </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$x</span><span class="step">/</span><span class="axis">following-sibling::</span><span class="node">node(</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="filter">[</span><span class="axis">self::</span><span class="qname">span</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="40191">ml-highlight</span><span class="op">"</span><span class="open"></span><span class="filter">]</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="comment" pos="40229">(: if so, print the last $g_num words :)</span><span class="whitespace">&#xD;
                     </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">cts:tokenize</span><span class="parenthesis">(</span><span class="variable">$x</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                     </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:count</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                     </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$truncateTokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&lt;</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">  </span><span class="comment" pos="40456">(: &gt; :)</span><span class="whitespace">&#xD;
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="function">fn:last</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="function">fn:last</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                     </span><span class="op">return</span><span class="whitespace">&#xD;
                     </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$count</span><span class="whitespace"> </span><span class="op">&lt;</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="comment" pos="40691">(: &gt; :)</span><span class="open"></span><span class="whitespace">&#xD;
                     </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="40762"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
                  </span><span class="comment" pos="40786">(: If the last token is not punctuation, then add space after :)</span><span class="open"></span><span class="whitespace">&#xD;
                               </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="function">fn:last</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="type-op">instance of</span><span class="whitespace"> </span><span class="type-name">cts:punctuation</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                               </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="40982"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                               </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="41025"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                           </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                     </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="whitespace"> </span><span class="variable">$truncateTokens</span><span class="whitespace"> </span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="41134"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
                  </span><span class="comment" pos="41158">(: If the last token is not punctuation, then add space after :)</span><span class="open"></span><span class="whitespace">&#xD;
                               </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="function">fn:last</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="type-op">instance of</span><span class="whitespace"> </span><span class="type-name">cts:punctuation</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                               </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="41354"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                               </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="41397"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                           </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                   </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
              </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="41476"></span><span class="op">"</span><span class="open"></span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
               </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
       </span><span class="axis">case</span><span class="whitespace"> </span><span class="qname">element</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="qname">span</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$x</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="41550">ml-highlight</span><span class="op">"</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$z</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$x</span><span class="step">/</span><span class="node">node(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">truncate-text</span><span class="parenthesis">(</span><span class="variable">$z</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
       </span><span class="axis">default</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$z</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$x</span><span class="step">/</span><span class="node">node(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="function">truncate-text</span><span class="parenthesis">(</span><span class="variable">$z</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$truncate-words</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="41732">(:~&#xD;
:&#xD;
: (Public) Returns a string version of any xpath in a document&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @return The string version of any xpath in a document.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">show-section</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$uri</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">uri</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$path</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">path</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$nodeInstr</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="function">search:construct-prolog</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="42090"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace">&#xD;
							</span><span class="op">"</span><span class="literal" pos="42103"> fn:doc('</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$uri</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="42120">')</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="variable">$path</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$node</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">xdmp:eval</span><span class="parenthesis">(</span><span class="variable">$nodeInstr</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$preview</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
		</span><span class="if">if(</span><span class="function">fn:exists</span><span class="parenthesis">(</span><span class="variable">$node</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
			</span><span class="variable">$node</span><span class="whitespace">&#xD;
		</span><span class="op">else</span><span class="whitespace">&#xD;
			</span><span class="op">"</span><span class="literal" pos="42238">No preview available.</span><span class="op">"</span><span class="whitespace">&#xD;
	</span><span class="op">return</span><span class="whitespace">&#xD;
		</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$preview</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="42300">(: Search Widgets :)</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="42324">(:~&#xD;
:&#xD;
: (Public) A description of the query being displayed that will also&#xD;
: allow users to remove individual items from their search. &#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @return An HTML rendered, interactive description of the user's search.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">query-description</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">!=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="42714"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    </span><span pos="42728" class="es">&lt;</span><span pos="42729" class="en">div</span><span pos="42732" class="atn"> class</span><span pos="42738" class="atneq">=</span><span pos="42739" class="z">"</span><span pos="42740" class="av">query_description</span><span pos="42757" class="z">"</span><span pos="42758" class="z">&gt;</span><span pos="42759" class="txt">&#xD;
        </span><span pos="42769" class="op">{</span><span class="open"></span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="42771">Results </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span pos="42782" class="es">&lt;</span><span pos="42783" class="en">span</span><span pos="42787" class="z">&gt;</span><span pos="42788" class="txt">for </span><span pos="42792" class="es">&lt;</span><span pos="42793" class="en">b</span><span pos="42794" class="z">&gt;</span><span pos="42795" class="op">{</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span pos="42805" class="op">}</span><span pos="42806" class="sc">&lt;/</span><span pos="42808" class="cl">b</span><span pos="42809" class="z">&gt;</span><span pos="42810" class="sc">&lt;/</span><span pos="42812" class="cl">span</span><span pos="42816" class="z">&gt;</span><span class="open"></span><span class="op">,</span><span class="op">"</span><span class="literal" pos="42818"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span pos="42867" class="es">&lt;</span><span pos="42868" class="en">span</span><span pos="42872" class="z">&gt;</span><span pos="42873" class="txt">in </span><span pos="42876" class="es">&lt;</span><span pos="42877" class="en">i</span><span pos="42878" class="z">&gt;</span><span pos="42879" class="op">{</span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span pos="42893" class="op">}</span><span pos="42894" class="sc">&lt;/</span><span pos="42896" class="cl">i</span><span pos="42897" class="z">&gt;</span><span pos="42898" class="sc">&lt;/</span><span pos="42900" class="cl">span</span><span pos="42904" class="z">&gt;</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> &#xD;
        </span><span pos="42925" class="es">&lt;</span><span pos="42926" class="en">a</span><span pos="42927" class="atn"> href</span><span pos="42932" class="atneq">=</span><span pos="42933" class="z">"</span><span pos="42934" class="av">search.xqy?</span><span pos="42945" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="42978">q</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="42983" class="op">}</span><span pos="42984" class="z">"</span><span pos="42985" class="z">&gt;</span><span pos="42986" class="txt">[x]</span><span pos="42989" class="sc">&lt;/</span><span pos="42991" class="cl">a</span><span pos="42992" class="z">&gt;</span><span class="parenthesis">)</span><span pos="42994" class="op">}</span><span pos="42995" class="txt">&#xD;
    </span><span pos="43001" class="sc">&lt;/</span><span pos="43003" class="cl">div</span><span pos="43006" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="function">filter-description</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
&#xD;
</span><span class="comment" pos="43063">(:~&#xD;
:&#xD;
: (Public) Information on the quanity of results and the time to render the results.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @param $query-time The amount of time required to execute the search.&#xD;
: @param $page-info The pagination element created by lib-uitools.&#xD;
: @return A rendered HTML &lt;div&gt; containing information on the quanity of results and the time to render the results.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">results-info</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$query-time</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:duration</span><span class="op">,</span><span class="whitespace">&#xD;
	</span><span class="variable">$page-info</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">pagination</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$time</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$query-time</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$time</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:substring</span><span class="parenthesis">(</span><span class="variable">$time</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">3</span><span class="op">,</span><span class="whitespace"> </span><span class="function">fn:string-length</span><span class="parenthesis">(</span><span class="variable">$time</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    </span><span pos="43760" class="es">&lt;</span><span pos="43761" class="en">div</span><span pos="43764" class="atn"> class</span><span pos="43770" class="atneq">=</span><span pos="43771" class="z">"</span><span pos="43772" class="av">results_info</span><span pos="43784" class="z">"</span><span pos="43785" class="z">&gt;</span><span pos="43786" class="txt">&#xD;
	    </span><span pos="43793" class="es">&lt;</span><span pos="43794" class="en">span</span><span pos="43798" class="z">&gt;</span><span pos="43799" class="txt">Displaying </span><span pos="43810" class="es">&lt;</span><span pos="43811" class="en">strong</span><span pos="43817" class="z">&gt;</span><span pos="43818" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page-info</span><span class="step">/</span><span class="qname">start</span><span class="parenthesis">)</span><span pos="43846" class="op">}</span><span pos="43847" class="txt"> to </span><span pos="43851" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page-info</span><span class="step">/</span><span class="qname">end</span><span class="parenthesis">)</span><span pos="43877" class="op">}</span><span pos="43878" class="sc">&lt;/</span><span pos="43880" class="cl">strong</span><span pos="43886" class="z">&gt;</span><span pos="43887" class="txt"> of about </span><span pos="43897" class="es">&lt;</span><span pos="43898" class="en">strong</span><span pos="43904" class="z">&gt;</span><span pos="43905" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page-info</span><span class="step">/</span><span class="qname">count</span><span class="parenthesis">)</span><span pos="43933" class="op">}</span><span pos="43934" class="sc">&lt;/</span><span pos="43936" class="cl">strong</span><span pos="43942" class="z">&gt;</span><span pos="43943" class="txt"> results. Searched in </span><span pos="43965" class="es">&lt;</span><span pos="43966" class="en">strong</span><span pos="43972" class="z">&gt;</span><span pos="43973" class="op">{</span><span class="variable">$time</span><span pos="43979" class="op">}</span><span pos="43980" class="txt">s</span><span pos="43981" class="sc">&lt;/</span><span pos="43983" class="cl">strong</span><span pos="43989" class="z">&gt;</span><span pos="43990" class="txt">.</span><span pos="43991" class="sc">&lt;/</span><span pos="43993" class="cl">span</span><span pos="43997" class="z">&gt;</span><span pos="43998" class="txt"> </span><span pos="43999" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">*</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="44021"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span pos="44025" class="es">&lt;</span><span pos="44026" class="en">a</span><span pos="44027" class="atn"> href</span><span pos="44032" class="atneq">=</span><span pos="44033" class="z">"</span><span pos="44034" class="av">search.xqy</span><span pos="44044" class="z">"</span><span pos="44045" class="z">&gt;</span><span pos="44046" class="txt">[Reset Search]</span><span pos="44060" class="sc">&lt;/</span><span pos="44062" class="cl">a</span><span pos="44063" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="44073" class="op">}</span><span pos="44074" class="sc">&lt;/</span><span pos="44076" class="cl">div</span><span pos="44079" class="z">&gt;</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="44087">(:~&#xD;
:&#xD;
: (Public) A widget which is meant to be displayed on the sidebar&#xD;
: and will allow the user to choose a sort order for their results.&#xD;
: Appears only when there is a full-text search. Default browse&#xD;
: sort-order is used otherwise.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @return A select box which will allow the user to select the sort order.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">sort</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
    </span><span pos="44575" class="es">&lt;</span><span pos="44576" class="en">div</span><span pos="44579" class="atn"> style</span><span pos="44585" class="atneq">=</span><span pos="44586" class="z">"</span><span pos="44587" class="av">margin: 7px 0 5px 0;</span><span pos="44607" class="z">"</span><span pos="44608" class="z">&gt;</span><span pos="44609" class="txt">&#xD;
    	</span><span pos="44616" class="es">&lt;</span><span pos="44617" class="en">form</span><span pos="44621" class="atn"> method</span><span pos="44628" class="atneq">=</span><span pos="44629" class="z">"</span><span pos="44630" class="av">get</span><span pos="44633" class="z">"</span><span pos="44634" class="atn"> action</span><span pos="44641" class="atneq">=</span><span pos="44642" class="z">"</span><span pos="44643" class="av">search.xqy</span><span pos="44653" class="z">"</span><span pos="44654" class="z">&gt;</span><span pos="44655" class="txt">&#xD;
            </span><span pos="44669" class="es">&lt;</span><span pos="44670" class="en">select</span><span pos="44676" class="atn"> name</span><span pos="44681" class="atneq">=</span><span pos="44682" class="z">"</span><span pos="44683" class="av">sort</span><span pos="44687" class="z">"</span><span pos="44688" class="atn"> onchange</span><span pos="44697" class="atneq">=</span><span pos="44698" class="z">"</span><span pos="44699" class="av">this.form.submit();</span><span pos="44718" class="z">"</span><span pos="44719" class="z">&gt;</span><span pos="44720" class="txt">&#xD;
            </span><span pos="44734" class="es">&lt;</span><span pos="44735" class="en">option</span><span pos="44741" class="atn"> value</span><span pos="44747" class="atneq">=</span><span pos="44748" class="z">"</span><span pos="44749" class="av">rel</span><span pos="44752" class="z">"</span><span pos="44753" class="z">&gt;</span><span pos="44754" class="txt">&#xD;
                </span><span pos="44772" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:empty</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">sort</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">sort</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="44819">rel</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="44826"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="44856">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="44875" class="op">}</span><span pos="44876" class="txt">&#xD;
                Sort by Relevence&#xD;
            </span><span pos="44925" class="sc">&lt;/</span><span pos="44927" class="cl">option</span><span pos="44933" class="z">&gt;</span><span pos="44934" class="txt">&#xD;
            </span><span pos="44948" class="es">&lt;</span><span pos="44949" class="en">option</span><span pos="44955" class="atn"> value</span><span pos="44961" class="atneq">=</span><span pos="44962" class="z">"</span><span pos="44963" class="av">date</span><span pos="44967" class="z">"</span><span pos="44968" class="z">&gt;</span><span pos="44969" class="txt">&#xD;
                </span><span pos="44987" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">sort</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="45008">date</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="45042">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="45061" class="op">}</span><span pos="45062" class="txt">&#xD;
                Sort by Date&#xD;
            </span><span pos="45106" class="sc">&lt;/</span><span pos="45108" class="cl">option</span><span pos="45114" class="z">&gt;</span><span pos="45115" class="txt">&#xD;
            </span><span pos="45129" class="sc">&lt;/</span><span pos="45131" class="cl">select</span><span pos="45137" class="z">&gt;</span><span pos="45138" class="txt">&#xD;
    		</span><span pos="45146" class="op">{</span><span class="open"></span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$param</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="45192">sort</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="step">/</span><span class="qname">*</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span pos="45227" class="es">&lt;</span><span pos="45228" class="en">input</span><span pos="45233" class="atn"> type</span><span pos="45238" class="atneq">=</span><span pos="45239" class="z">"</span><span pos="45240" class="av">hidden</span><span pos="45246" class="z">"</span><span pos="45247" class="atn"> name</span><span pos="45252" class="atneq">=</span><span pos="45253" class="z">"</span><span pos="45254" class="op">{</span><span class="function">fn:local-name</span><span class="parenthesis">(</span><span class="variable">$param</span><span class="parenthesis">)</span><span pos="45276" class="op">}</span><span pos="45277" class="z">"</span><span pos="45278" class="atn"> class</span><span pos="45284" class="atneq">=</span><span pos="45285" class="z">"</span><span pos="45286" class="av">hide</span><span pos="45290" class="z">"</span><span pos="45291" class="atn"> value</span><span pos="45297" class="atneq">=</span><span pos="45298" class="z">"</span><span pos="45299" class="op">{</span><span class="variable">$param</span><span pos="45306" class="op">}</span><span pos="45307" class="z">"</span><span pos="45308" class="atn"> </span><span pos="45309" class="z">/&gt;</span><span pos="45311" class="op">}</span><span pos="45312" class="txt">&#xD;
    	</span><span pos="45319" class="sc">&lt;/</span><span pos="45321" class="cl">form</span><span pos="45325" class="z">&gt;</span><span pos="45326" class="txt">&#xD;
    </span><span pos="45332" class="sc">&lt;/</span><span pos="45334" class="cl">div</span><span pos="45337" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="45358">(:~&#xD;
:&#xD;
: (Public) A widget meant for the sidebar that includes a search box and&#xD;
: field select box which a user can modify their current full-text search parameters.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @return A search filter widget.&#xD;
:)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">search-filter</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">?</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$hparams</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="45745">q</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    	</span><span pos="45772" class="es">&lt;</span><span pos="45773" class="en">form</span><span pos="45777" class="atn"> method</span><span pos="45784" class="atneq">=</span><span pos="45785" class="z">"</span><span pos="45786" class="av">get</span><span pos="45789" class="z">"</span><span pos="45790" class="atn"> action</span><span pos="45797" class="atneq">=</span><span pos="45798" class="z">"</span><span pos="45799" class="av">search.xqy</span><span pos="45809" class="z">"</span><span pos="45810" class="z">&gt;</span><span pos="45811" class="txt">&#xD;
    		</span><span pos="45819" class="es">&lt;</span><span pos="45820" class="en">input</span><span pos="45825" class="atn"> type</span><span pos="45830" class="atneq">=</span><span pos="45831" class="z">"</span><span pos="45832" class="av">text</span><span pos="45836" class="z">"</span><span pos="45837" class="atn"> name</span><span pos="45842" class="atneq">=</span><span pos="45843" class="z">"</span><span pos="45844" class="av">q</span><span pos="45845" class="z">"</span><span pos="45846" class="atn"> style</span><span pos="45852" class="atneq">=</span><span pos="45853" class="z">"</span><span pos="45854" class="av">width:95%;</span><span pos="45864" class="z">"</span><span pos="45865" class="atn"> id</span><span pos="45868" class="atneq">=</span><span pos="45869" class="z">"</span><span pos="45870" class="av">quicksearch_q</span><span pos="45883" class="z">"</span><span pos="45884" class="atn"> class</span><span pos="45890" class="atneq">=</span><span pos="45891" class="z">"</span><span pos="45892" class="av">textbox</span><span pos="45899" class="z">"</span><span pos="45900" class="atn"> value</span><span pos="45906" class="atneq">=</span><span pos="45907" class="z">"</span><span pos="45908" class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">q</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="45968" class="op">}</span><span pos="45969" class="z">"</span><span pos="45970" class="atn"> </span><span pos="45971" class="z">/&gt;</span><span pos="45973" class="op">{</span><span class="op">"</span><span class="literal" pos="45974"> </span><span class="op">"</span><span pos="45977" class="op">}</span><span pos="45978" class="txt">&#xD;
    		</span><span pos="45986" class="op">{</span><span class="open"></span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$SEARCH-FIELDS</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
	            </span><span pos="46027" class="es">&lt;</span><span pos="46028" class="en">select</span><span pos="46034" class="atn"> name</span><span pos="46039" class="atneq">=</span><span pos="46040" class="z">"</span><span pos="46041" class="av">field</span><span pos="46046" class="z">"</span><span pos="46047" class="atn"> style</span><span pos="46053" class="atneq">=</span><span pos="46054" class="z">"</span><span pos="46055" class="av">display:inline;margin:3px 3px 0 0;</span><span pos="46089" class="z">"</span><span pos="46090" class="z">&gt;</span><span pos="46091" class="txt">&#xD;
	            	</span><span pos="46107" class="op">{</span><span class="open"></span><span class="whitespace">     &#xD;
	    			</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$option</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$SEARCH-FIELDS</span><span class="whitespace">&#xD;
	    			</span><span class="op">return</span><span class="whitespace">&#xD;
						</span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">fn:tokenize</span><span class="parenthesis">(</span><span class="variable">$option</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="46211">\|</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
						</span><span class="op">return</span><span class="whitespace"> &#xD;
							</span><span class="axis">element</span><span class="whitespace"> </span><span class="qname">option</span><span class="whitespace"> </span><span class="op">{</span><span class="whitespace">&#xD;
								</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">value</span><span class="whitespace"> </span><span class="op">{</span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="op">,</span><span class="whitespace">&#xD;
								</span><span class="if">if(</span><span class="parenthesis">(</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="46346"></span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">field</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> &#xD;
									</span><span class="axis">attribute</span><span class="whitespace"> </span><span class="qname">selected</span><span class="whitespace"> </span><span class="op">{</span><span class="op">"</span><span class="literal" pos="46417">selected</span><span class="op">"</span><span class="op">}</span><span class="whitespace">&#xD;
								</span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
								</span><span class="variable">$items</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace">&#xD;
							</span><span class="op">}</span><span class="whitespace">&#xD;
	    			</span><span pos="46485" class="op">}</span><span pos="46486" class="txt">&#xD;
			    </span><span pos="46495" class="sc">&lt;/</span><span pos="46497" class="cl">select</span><span pos="46503" class="z">&gt;</span><span class="whitespace">&#xD;
			    </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span pos="46521" class="op">}</span><span pos="46522" class="txt">&#xD;
    		</span><span pos="46530" class="es">&lt;</span><span pos="46531" class="en">input</span><span pos="46536" class="atn"> type</span><span pos="46541" class="atneq">=</span><span pos="46542" class="z">"</span><span pos="46543" class="av">submit</span><span pos="46549" class="z">"</span><span pos="46550" class="atn"> value</span><span pos="46556" class="atneq">=</span><span pos="46557" class="z">"</span><span pos="46558" class="av">Filter</span><span pos="46564" class="z">"</span><span pos="46565" class="atn"> class</span><span pos="46571" class="atneq">=</span><span pos="46572" class="z">"</span><span pos="46573" class="av">button</span><span pos="46579" class="z">"</span><span pos="46580" class="atn"> </span><span pos="46581" class="z">/&gt;</span><span pos="46583" class="txt">&#xD;
    		</span><span pos="46591" class="op">{</span><span class="open"></span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$param</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">*</span><span class="filter">[</span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="function">fn:local-name</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="46643">q</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="46648">field</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">&#xD;
            </span><span pos="46679" class="es">&lt;</span><span pos="46680" class="en">input</span><span pos="46685" class="atn"> type</span><span pos="46690" class="atneq">=</span><span pos="46691" class="z">"</span><span pos="46692" class="av">hidden</span><span pos="46698" class="z">"</span><span pos="46699" class="atn"> name</span><span pos="46704" class="atneq">=</span><span pos="46705" class="z">"</span><span pos="46706" class="op">{</span><span class="function">fn:local-name</span><span class="parenthesis">(</span><span class="variable">$param</span><span class="parenthesis">)</span><span pos="46728" class="op">}</span><span pos="46729" class="z">"</span><span pos="46730" class="atn"> class</span><span pos="46736" class="atneq">=</span><span pos="46737" class="z">"</span><span pos="46738" class="av">hide</span><span pos="46742" class="z">"</span><span pos="46743" class="atn"> value</span><span pos="46749" class="atneq">=</span><span pos="46750" class="z">"</span><span pos="46751" class="op">{</span><span class="variable">$param</span><span pos="46758" class="op">}</span><span pos="46759" class="z">"</span><span pos="46760" class="atn"> </span><span pos="46761" class="z">/&gt;</span><span pos="46763" class="op">}</span><span pos="46764" class="txt">&#xD;
    	</span><span pos="46771" class="sc">&lt;/</span><span pos="46773" class="cl">form</span><span pos="46777" class="z">&gt;</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="comment" pos="46785">(:~&#xD;
:&#xD;
: (Public) Pagination controls for a page.&#xD;
:&#xD;
: @param $params The parameters from the page request.&#xD;
: @param $page-info The pagination element created by lib-uitools.&#xD;
: @return A fully functional pagination control&#xD;
  Disclaimer: We acknowledge that this function is seriously lacking, so&#xD;
   if you have the time and desire, please do. :)</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">pagination</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
	</span><span class="variable">$page-info</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">pagination</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">xs:integer</span><span class="parenthesis">(</span><span class="variable">$page-info</span><span class="step">/</span><span class="qname">page</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">xs:integer</span><span class="parenthesis">(</span><span class="variable">$page-info</span><span class="step">/</span><span class="qname">pages</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
	</span><span class="op">return</span><span class="whitespace">&#xD;
	</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
        </span><span pos="47372" class="es">&lt;</span><span pos="47373" class="en">div</span><span pos="47376" class="atn"> class</span><span pos="47382" class="atneq">=</span><span pos="47383" class="z">"</span><span pos="47384" class="av">pages</span><span pos="47389" class="z">"</span><span pos="47390" class="z">&gt;</span><span pos="47391" class="txt">&#xD;
            </span><span pos="47405" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="47439" class="es">&lt;</span><span pos="47440" class="en">a</span><span pos="47441" class="atn"> class</span><span pos="47447" class="atneq">=</span><span pos="47448" class="z">"</span><span pos="47449" class="av">nextprev</span><span pos="47457" class="z">"</span><span pos="47458" class="atn"> title</span><span pos="47464" class="atneq">=</span><span pos="47465" class="z">"</span><span pos="47466" class="av">Go to Previous Page</span><span pos="47485" class="z">"</span><span pos="47486" class="atn"> href</span><span pos="47491" class="atneq">=</span><span pos="47492" class="z">"</span><span pos="47493" class="av">search.xqy?</span><span pos="47504" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="47537">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="47542" class="op">}</span><span pos="47543" class="av">&amp;p=</span><span pos="47546" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span pos="47556" class="op">}</span><span pos="47557" class="z">"</span><span pos="47558" class="z">&gt;</span><span pos="47559" class="txt">&amp;laquo; Previous Page</span><span pos="47580" class="sc">&lt;/</span><span pos="47582" class="cl">a</span><span pos="47583" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="47619" class="op">}</span><span pos="47620" class="txt">&#xD;
            </span><span pos="47634" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">4</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="47695" class="es">&lt;</span><span pos="47696" class="en">a</span><span pos="47697" class="atn"> class</span><span pos="47703" class="atneq">=</span><span pos="47704" class="z">"</span><span pos="47705" class="av">lastpage</span><span pos="47713" class="z">"</span><span pos="47714" class="atn"> title</span><span pos="47720" class="atneq">=</span><span pos="47721" class="z">"</span><span pos="47722" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span pos="47743" class="op">}</span><span pos="47744" class="z">"</span><span pos="47745" class="atn"> href</span><span pos="47750" class="atneq">=</span><span pos="47751" class="z">"</span><span pos="47752" class="av">search.xqy?</span><span pos="47763" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="47796">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="47801" class="op">}</span><span pos="47802" class="av">&amp;p=</span><span pos="47805" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">4</span><span pos="47815" class="op">}</span><span pos="47816" class="z">"</span><span pos="47817" class="z">&gt;</span><span pos="47818" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span pos="47839" class="op">}</span><span pos="47840" class="sc">&lt;/</span><span pos="47842" class="cl">a</span><span pos="47843" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="47879" class="op">}</span><span pos="47880" class="txt">&#xD;
            </span><span pos="47894" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="47981" class="es">&lt;</span><span pos="47982" class="en">a</span><span pos="47983" class="atn"> class</span><span pos="47989" class="atneq">=</span><span pos="47990" class="z">"</span><span pos="47991" class="av">lastpage</span><span pos="47999" class="z">"</span><span pos="48000" class="atn"> title</span><span pos="48006" class="atneq">=</span><span pos="48007" class="z">"</span><span pos="48008" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span pos="48029" class="op">}</span><span pos="48030" class="z">"</span><span pos="48031" class="atn"> href</span><span pos="48036" class="atneq">=</span><span pos="48037" class="z">"</span><span pos="48038" class="av">search.xqy?</span><span pos="48049" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="48082">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="48087" class="op">}</span><span pos="48088" class="av">&amp;p=</span><span pos="48091" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span pos="48101" class="op">}</span><span pos="48102" class="z">"</span><span pos="48103" class="z">&gt;</span><span pos="48104" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span pos="48125" class="op">}</span><span pos="48126" class="sc">&lt;/</span><span pos="48128" class="cl">a</span><span pos="48129" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="48165" class="op">}</span><span pos="48166" class="txt">&#xD;
            </span><span pos="48180" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="48267" class="es">&lt;</span><span pos="48268" class="en">a</span><span pos="48269" class="atn"> class</span><span pos="48275" class="atneq">=</span><span pos="48276" class="z">"</span><span pos="48277" class="av">lastpage</span><span pos="48285" class="z">"</span><span pos="48286" class="atn"> title</span><span pos="48292" class="atneq">=</span><span pos="48293" class="z">"</span><span pos="48294" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span pos="48315" class="op">}</span><span pos="48316" class="z">"</span><span pos="48317" class="atn"> href</span><span pos="48322" class="atneq">=</span><span pos="48323" class="z">"</span><span pos="48324" class="av">search.xqy?</span><span pos="48335" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="48368">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="48373" class="op">}</span><span pos="48374" class="av">&amp;p=</span><span pos="48377" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span pos="48387" class="op">}</span><span pos="48388" class="z">"</span><span pos="48389" class="z">&gt;</span><span pos="48390" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span pos="48411" class="op">}</span><span pos="48412" class="sc">&lt;/</span><span pos="48414" class="cl">a</span><span pos="48415" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="48451" class="op">}</span><span pos="48452" class="txt">&#xD;
            </span><span pos="48466" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="48522" class="es">&lt;</span><span pos="48523" class="en">a</span><span pos="48524" class="atn"> class</span><span pos="48530" class="atneq">=</span><span pos="48531" class="z">"</span><span pos="48532" class="av">lastpage</span><span pos="48540" class="z">"</span><span pos="48541" class="atn"> title</span><span pos="48547" class="atneq">=</span><span pos="48548" class="z">"</span><span pos="48549" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span pos="48570" class="op">}</span><span pos="48571" class="z">"</span><span pos="48572" class="atn"> href</span><span pos="48577" class="atneq">=</span><span pos="48578" class="z">"</span><span pos="48579" class="av">search.xqy?</span><span pos="48590" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="48623">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="48628" class="op">}</span><span pos="48629" class="av">&amp;p=</span><span pos="48632" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span pos="48642" class="op">}</span><span pos="48643" class="z">"</span><span pos="48644" class="z">&gt;</span><span pos="48645" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span pos="48666" class="op">}</span><span pos="48667" class="sc">&lt;/</span><span pos="48669" class="cl">a</span><span pos="48670" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="48706" class="op">}</span><span pos="48707" class="txt">&#xD;
            </span><span pos="48721" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="48761" class="es">&lt;</span><span pos="48762" class="en">a</span><span pos="48763" class="atn"> class</span><span pos="48769" class="atneq">=</span><span pos="48770" class="z">"</span><span pos="48771" class="av">thispage</span><span pos="48779" class="z">"</span><span pos="48780" class="atn"> title</span><span pos="48786" class="atneq">=</span><span pos="48787" class="z">"</span><span pos="48788" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="parenthesis">)</span><span pos="48805" class="op">}</span><span pos="48806" class="z">"</span><span pos="48807" class="atn"> href</span><span pos="48812" class="atneq">=</span><span pos="48813" class="z">"</span><span pos="48814" class="av">search.xqy?</span><span pos="48825" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="48858">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="48863" class="op">}</span><span pos="48864" class="av">&amp;p=</span><span pos="48867" class="op">{</span><span class="variable">$page</span><span pos="48873" class="op">}</span><span pos="48874" class="z">"</span><span pos="48875" class="z">&gt;</span><span pos="48876" class="es">&lt;</span><span pos="48877" class="en">strong</span><span pos="48883" class="z">&gt;</span><span pos="48884" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="parenthesis">)</span><span pos="48901" class="op">}</span><span pos="48902" class="sc">&lt;/</span><span pos="48904" class="cl">strong</span><span pos="48910" class="z">&gt;</span><span pos="48911" class="sc">&lt;/</span><span pos="48913" class="cl">a</span><span pos="48914" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="48950" class="op">}</span><span pos="48951" class="txt">&#xD;
            </span><span pos="48965" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="49009" class="es">&lt;</span><span pos="49010" class="en">a</span><span pos="49011" class="atn"> class</span><span pos="49017" class="atneq">=</span><span pos="49018" class="z">"</span><span pos="49019" class="av">nextpage</span><span pos="49027" class="z">"</span><span pos="49028" class="atn"> title</span><span pos="49034" class="atneq">=</span><span pos="49035" class="z">"</span><span pos="49036" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span pos="49057" class="op">}</span><span pos="49058" class="z">"</span><span pos="49059" class="atn"> href</span><span pos="49064" class="atneq">=</span><span pos="49065" class="z">"</span><span pos="49066" class="av">search.xqy?</span><span pos="49077" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="49110">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="49115" class="op">}</span><span pos="49116" class="av">&amp;p=</span><span pos="49119" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span pos="49129" class="op">}</span><span pos="49130" class="z">"</span><span pos="49131" class="z">&gt;</span><span pos="49132" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span pos="49153" class="op">}</span><span pos="49154" class="sc">&lt;/</span><span pos="49156" class="cl">a</span><span pos="49157" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="49193" class="op">}</span><span pos="49194" class="txt">&#xD;
            </span><span pos="49208" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="49252" class="es">&lt;</span><span pos="49253" class="en">a</span><span pos="49254" class="atn"> class</span><span pos="49260" class="atneq">=</span><span pos="49261" class="z">"</span><span pos="49262" class="av">nextpage2</span><span pos="49271" class="z">"</span><span pos="49272" class="atn"> title</span><span pos="49278" class="atneq">=</span><span pos="49279" class="z">"</span><span pos="49280" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span pos="49301" class="op">}</span><span pos="49302" class="z">"</span><span pos="49303" class="atn"> href</span><span pos="49308" class="atneq">=</span><span pos="49309" class="z">"</span><span pos="49310" class="av">search.xqy?</span><span pos="49321" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="49354">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="49359" class="op">}</span><span pos="49360" class="av">&amp;p=</span><span pos="49363" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span pos="49373" class="op">}</span><span pos="49374" class="z">"</span><span pos="49375" class="z">&gt;</span><span pos="49376" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span pos="49397" class="op">}</span><span pos="49398" class="sc">&lt;/</span><span pos="49400" class="cl">a</span><span pos="49401" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="49437" class="op">}</span><span pos="49438" class="txt">&#xD;
            </span><span pos="49452" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="49496" class="es">&lt;</span><span pos="49497" class="en">a</span><span pos="49498" class="atn"> class</span><span pos="49504" class="atneq">=</span><span pos="49505" class="z">"</span><span pos="49506" class="av">nextpage3</span><span pos="49515" class="z">"</span><span pos="49516" class="atn"> title</span><span pos="49522" class="atneq">=</span><span pos="49523" class="z">"</span><span pos="49524" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span pos="49545" class="op">}</span><span pos="49546" class="z">"</span><span pos="49547" class="atn"> href</span><span pos="49552" class="atneq">=</span><span pos="49553" class="z">"</span><span pos="49554" class="av">search.xqy?</span><span pos="49565" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="49598">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="49603" class="op">}</span><span pos="49604" class="av">&amp;p=</span><span pos="49607" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span pos="49617" class="op">}</span><span pos="49618" class="z">"</span><span pos="49619" class="z">&gt;</span><span pos="49620" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="parenthesis">)</span><span pos="49641" class="op">}</span><span pos="49642" class="sc">&lt;/</span><span pos="49644" class="cl">a</span><span pos="49645" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="49681" class="op">}</span><span pos="49682" class="txt">&#xD;
            </span><span pos="49696" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">4</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="49740" class="es">&lt;</span><span pos="49741" class="en">a</span><span pos="49742" class="atn"> class</span><span pos="49748" class="atneq">=</span><span pos="49749" class="z">"</span><span pos="49750" class="av">nextpage4</span><span pos="49759" class="z">"</span><span pos="49760" class="atn"> title</span><span pos="49766" class="atneq">=</span><span pos="49767" class="z">"</span><span pos="49768" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span pos="49789" class="op">}</span><span pos="49790" class="z">"</span><span pos="49791" class="atn"> href</span><span pos="49796" class="atneq">=</span><span pos="49797" class="z">"</span><span pos="49798" class="av">search.xqy?</span><span pos="49809" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="49842">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="49847" class="op">}</span><span pos="49848" class="av">&amp;p=</span><span pos="49851" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">4</span><span pos="49861" class="op">}</span><span pos="49862" class="z">"</span><span pos="49863" class="z">&gt;</span><span pos="49864" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span pos="49885" class="op">}</span><span pos="49886" class="sc">&lt;/</span><span pos="49888" class="cl">a</span><span pos="49889" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="49925" class="op">}</span><span pos="49926" class="txt">&#xD;
            </span><span pos="49940" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">5</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="49984" class="es">&lt;</span><span pos="49985" class="en">a</span><span pos="49986" class="atn"> class</span><span pos="49992" class="atneq">=</span><span pos="49993" class="z">"</span><span pos="49994" class="av">nextpage5</span><span pos="50003" class="z">"</span><span pos="50004" class="atn"> title</span><span pos="50010" class="atneq">=</span><span pos="50011" class="z">"</span><span pos="50012" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">5</span><span class="parenthesis">)</span><span pos="50033" class="op">}</span><span pos="50034" class="z">"</span><span pos="50035" class="atn"> href</span><span pos="50040" class="atneq">=</span><span pos="50041" class="z">"</span><span pos="50042" class="av">search.xqy?</span><span pos="50053" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="50086">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="50091" class="op">}</span><span pos="50092" class="av">&amp;p=</span><span pos="50095" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">5</span><span pos="50105" class="op">}</span><span pos="50106" class="z">"</span><span pos="50107" class="z">&gt;</span><span pos="50108" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">5</span><span class="parenthesis">)</span><span pos="50129" class="op">}</span><span pos="50130" class="sc">&lt;/</span><span pos="50132" class="cl">a</span><span pos="50133" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="50169" class="op">}</span><span pos="50170" class="txt">&#xD;
            </span><span pos="50184" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">6</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="50228" class="es">&lt;</span><span pos="50229" class="en">a</span><span pos="50230" class="atn"> class</span><span pos="50236" class="atneq">=</span><span pos="50237" class="z">"</span><span pos="50238" class="av">nextpage6</span><span pos="50247" class="z">"</span><span pos="50248" class="atn"> title</span><span pos="50254" class="atneq">=</span><span pos="50255" class="z">"</span><span pos="50256" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">6</span><span class="parenthesis">)</span><span pos="50277" class="op">}</span><span pos="50278" class="z">"</span><span pos="50279" class="atn"> href</span><span pos="50284" class="atneq">=</span><span pos="50285" class="z">"</span><span pos="50286" class="av">search.xqy?</span><span pos="50297" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="50330">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="50335" class="op">}</span><span pos="50336" class="av">&amp;p=</span><span pos="50339" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">6</span><span pos="50349" class="op">}</span><span pos="50350" class="z">"</span><span pos="50351" class="z">&gt;</span><span pos="50352" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">6</span><span class="parenthesis">)</span><span pos="50373" class="op">}</span><span pos="50374" class="sc">&lt;/</span><span pos="50376" class="cl">a</span><span pos="50377" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="50413" class="op">}</span><span pos="50414" class="txt">&#xD;
            </span><span pos="50428" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">7</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="50472" class="es">&lt;</span><span pos="50473" class="en">a</span><span pos="50474" class="atn"> class</span><span pos="50480" class="atneq">=</span><span pos="50481" class="z">"</span><span pos="50482" class="av">nextpage7</span><span pos="50491" class="z">"</span><span pos="50492" class="atn"> title</span><span pos="50498" class="atneq">=</span><span pos="50499" class="z">"</span><span pos="50500" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">7</span><span class="parenthesis">)</span><span pos="50521" class="op">}</span><span pos="50522" class="z">"</span><span pos="50523" class="atn"> href</span><span pos="50528" class="atneq">=</span><span pos="50529" class="z">"</span><span pos="50530" class="av">search.xqy?</span><span pos="50541" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="50574">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="50579" class="op">}</span><span pos="50580" class="av">&amp;p=</span><span pos="50583" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">7</span><span pos="50593" class="op">}</span><span pos="50594" class="z">"</span><span pos="50595" class="z">&gt;</span><span pos="50596" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">7</span><span class="parenthesis">)</span><span pos="50617" class="op">}</span><span pos="50618" class="sc">&lt;/</span><span pos="50620" class="cl">a</span><span pos="50621" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="50657" class="op">}</span><span pos="50658" class="txt">&#xD;
            </span><span pos="50672" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">8</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="50716" class="es">&lt;</span><span pos="50717" class="en">a</span><span pos="50718" class="atn"> class</span><span pos="50724" class="atneq">=</span><span pos="50725" class="z">"</span><span pos="50726" class="av">nextpage8</span><span pos="50735" class="z">"</span><span pos="50736" class="atn"> title</span><span pos="50742" class="atneq">=</span><span pos="50743" class="z">"</span><span pos="50744" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">8</span><span class="parenthesis">)</span><span pos="50765" class="op">}</span><span pos="50766" class="z">"</span><span pos="50767" class="atn"> href</span><span pos="50772" class="atneq">=</span><span pos="50773" class="z">"</span><span pos="50774" class="av">search.xqy?</span><span pos="50785" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="50818">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="50823" class="op">}</span><span pos="50824" class="av">&amp;p=</span><span pos="50827" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">8</span><span pos="50837" class="op">}</span><span pos="50838" class="z">"</span><span pos="50839" class="z">&gt;</span><span pos="50840" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">8</span><span class="parenthesis">)</span><span pos="50861" class="op">}</span><span pos="50862" class="sc">&lt;/</span><span pos="50864" class="cl">a</span><span pos="50865" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="50901" class="op">}</span><span pos="50902" class="txt">&#xD;
            </span><span pos="50916" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">9</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="50978" class="es">&lt;</span><span pos="50979" class="en">a</span><span pos="50980" class="atn"> class</span><span pos="50986" class="atneq">=</span><span pos="50987" class="z">"</span><span pos="50988" class="av">nextpage9</span><span pos="50997" class="z">"</span><span pos="50998" class="atn"> title</span><span pos="51004" class="atneq">=</span><span pos="51005" class="z">"</span><span pos="51006" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">9</span><span class="parenthesis">)</span><span pos="51027" class="op">}</span><span pos="51028" class="z">"</span><span pos="51029" class="atn"> href</span><span pos="51034" class="atneq">=</span><span pos="51035" class="z">"</span><span pos="51036" class="av">search.xqy?</span><span pos="51047" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="51080">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="51085" class="op">}</span><span pos="51086" class="av">&amp;p=</span><span pos="51089" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">9</span><span pos="51099" class="op">}</span><span pos="51100" class="z">"</span><span pos="51101" class="z">&gt;</span><span pos="51102" class="op">{</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">9</span><span class="parenthesis">)</span><span pos="51123" class="op">}</span><span pos="51124" class="sc">&lt;/</span><span pos="51126" class="cl">a</span><span pos="51127" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="51163" class="op">}</span><span pos="51164" class="txt">&#xD;
            </span><span pos="51178" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">&lt;=</span><span class="whitespace"> </span><span class="variable">$pages</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span pos="51222" class="es">&lt;</span><span pos="51223" class="en">a</span><span pos="51224" class="atn"> class</span><span pos="51230" class="atneq">=</span><span pos="51231" class="z">"</span><span pos="51232" class="av">nextpage</span><span pos="51240" class="z">"</span><span pos="51241" class="atn"> title</span><span pos="51247" class="atneq">=</span><span pos="51248" class="z">"</span><span pos="51249" class="av">Go to Next Page</span><span pos="51264" class="z">"</span><span pos="51265" class="atn"> href</span><span pos="51270" class="atneq">=</span><span pos="51271" class="z">"</span><span pos="51272" class="av">search.xqy?</span><span pos="51283" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="51316">p</span><span class="op">"</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="51321" class="op">}</span><span pos="51322" class="av">&amp;p=</span><span pos="51325" class="op">{</span><span class="variable">$page</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span pos="51335" class="op">}</span><span pos="51336" class="z">"</span><span pos="51337" class="z">&gt;</span><span pos="51338" class="txt">Next Page &amp;raquo;</span><span pos="51355" class="sc">&lt;/</span><span pos="51357" class="cl">a</span><span pos="51358" class="z">&gt;</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="51394" class="op">}</span><span pos="51395" class="txt">&#xD;
        </span><span pos="51405" class="sc">&lt;/</span><span pos="51407" class="cl">div</span><span pos="51410" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
	</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">filter-description</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="quantifier">*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$search-items</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">report-on-search-items</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$search-items</span><span class="step">/</span><span class="qname">param</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
        </span><span pos="51620" class="es">&lt;</span><span pos="51621" class="en">div</span><span pos="51624" class="atn"> class</span><span pos="51630" class="atneq">=</span><span pos="51631" class="z">"</span><span pos="51632" class="av">query_description</span><span pos="51649" class="z">"</span><span pos="51650" class="z">&gt;</span><span pos="51651" class="txt">&#xD;
            Filters </span><span pos="51673" class="es">&lt;</span><span pos="51674" class="en">span</span><span pos="51678" class="z">&gt;</span><span pos="51679" class="txt">for</span><span pos="51682" class="sc">&lt;/</span><span pos="51684" class="cl">span</span><span pos="51688" class="z">&gt;</span><span pos="51689" class="op">{</span><span class="op">"</span><span class="literal" pos="51690"> </span><span class="op">"</span><span pos="51693" class="op">}</span><span pos="51694" class="txt">&#xD;
            </span><span pos="51708" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
            </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$type</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="variable">$tpos</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$search-items</span><span class="step">/</span><span class="qname">param</span><span class="step">/</span><span class="qname">type</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$type</span><span class="step">/</span><span class="axis">parent::</span><span class="qname">param</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$type-name</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="variable">$type</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="whitespace">&#xD;
            </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">get-search-items-of-type</span><span class="parenthesis">(</span><span class="variable">$param-name</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type-name</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">return</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">(</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$tpos</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52043">, </span><span class="op">"</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
                </span><span pos="52074" class="es">&lt;</span><span pos="52075" class="en">span</span><span pos="52079" class="z">&gt;</span><span pos="52080" class="op">{</span><span class="variable">$type-name</span><span pos="52091" class="op">}</span><span pos="52092" class="txt"> = &#xD;
                </span><span pos="52113" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
                    </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="qname">at</span><span class="whitespace"> </span><span class="variable">$ipos</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$items</span><span class="whitespace">&#xD;
                    </span><span class="op">return</span><span class="whitespace">&#xD;
                        </span><span class="parenthesis">(</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$ipos</span><span class="whitespace"> </span><span class="op">&gt;</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52239"> OR </span><span class="op">"</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span pos="52255" class="es">&lt;</span><span pos="52256" class="en">b</span><span pos="52257" class="z">&gt;</span><span pos="52258" class="op">{</span><span class="function">capitalize-first-chars</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="parenthesis">)</span><span pos="52288" class="op">}</span><span pos="52289" class="sc">&lt;/</span><span pos="52291" class="cl">b</span><span pos="52292" class="z">&gt;</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52295"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace">&#xD;
                        </span><span pos="52325" class="es">&lt;</span><span pos="52326" class="en">a</span><span pos="52327" class="atn"> href</span><span pos="52332" class="atneq">=</span><span pos="52333" class="z">"</span><span pos="52334" class="av">search.xqy?</span><span pos="52345" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="op">,</span><span class="whitespace"> </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="variable">$type-name</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="52432">:</span><span class="op">"</span><span class="op">,</span><span class="variable">$item</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="52448" class="op">}</span><span pos="52449" class="z">"</span><span pos="52450" class="z">&gt;</span><span pos="52451" class="txt">[x]</span><span pos="52454" class="sc">&lt;/</span><span pos="52456" class="cl">a</span><span pos="52457" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
                </span><span pos="52477" class="op">}</span><span pos="52478" class="txt">&#xD;
                </span><span pos="52496" class="sc">&lt;/</span><span pos="52498" class="cl">span</span><span pos="52502" class="z">&gt;</span><span class="whitespace">&#xD;
                </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span pos="52536" class="op">}</span><span pos="52537" class="txt">&#xD;
            </span><span pos="52551" class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">&#xD;
            </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="52591"> during the last </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span pos="52612" class="es">&lt;</span><span pos="52613" class="en">b</span><span pos="52614" class="z">&gt;</span><span pos="52615" class="op">{</span><span class="open"></span><span class="function">fn:translate</span><span class="parenthesis">(</span><span class="function">fn:string</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52656">PD</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52662"></span><span class="op">"</span><span class="parenthesis">)</span><span pos="52665" class="op">}</span><span pos="52666" class="txt"></span><span pos="52666" class="op">{</span><span class="op">"</span><span class="literal" pos="52667"> days</span><span class="op">"</span><span pos="52674" class="op">}</span><span pos="52675" class="sc">&lt;/</span><span pos="52677" class="cl">b</span><span pos="52678" class="z">&gt;</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52681"> </span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace">&#xD;
            </span><span pos="52699" class="es">&lt;</span><span pos="52700" class="en">a</span><span pos="52701" class="atn"> href</span><span pos="52706" class="atneq">=</span><span pos="52707" class="z">"</span><span pos="52708" class="av">search.xqy?</span><span pos="52719" class="op">{</span><span class="open"></span><span class="function">uit:build-querystring</span><span class="parenthesis">(</span><span class="function">uit:modify-param-set</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="52772">dur</span><span class="op">"</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">dur</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span pos="52799" class="op">}</span><span pos="52800" class="z">"</span><span pos="52801" class="z">&gt;</span><span pos="52802" class="txt">[x]</span><span pos="52805" class="sc">&lt;/</span><span pos="52807" class="cl">a</span><span pos="52808" class="z">&gt;</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span pos="52831" class="op">}</span><span pos="52832" class="txt">&#xD;
        </span><span pos="52842" class="sc">&lt;/</span><span pos="52844" class="cl">div</span><span pos="52847" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
        </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="qname">get-search-items-of-type</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="whitespace">&#xD;
    </span><span class="variable">$param-name</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$type-name</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="op">,</span><span class="whitespace">&#xD;
    </span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string*</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">*</span><span class="filter">[</span><span class="function">fn:local-name</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$param-name</span><span class="filter">]</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$i</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">where</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$type-name</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">report-on-search-items</span><span class="parenthesis">(</span><span class="variable">$params</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="node-type">element</span><span class="parenthesis">(</span><span class="qname">params</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span pos="53264" class="es">&lt;</span><span pos="53265" class="en">search-item-types</span><span pos="53282" class="z">&gt;</span><span pos="53283" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">"</span><span class="literal" pos="53301">hval</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="53309">val</span><span class="op">"</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="53316">col</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$types</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace">&#xD;
        </span><span class="function">fn:distinct-values</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$item</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$params</span><span class="step">/</span><span class="qname">*</span><span class="filter">[</span><span class="function">fn:local-name</span><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$i</span><span class="filter">]</span><span class="whitespace">&#xD;
        </span><span class="higher">let</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="whitespace"> </span><span class="op">:=</span><span class="whitespace"> </span><span class="function">split-search-item</span><span class="parenthesis">(</span><span class="variable">$item</span><span class="parenthesis">)</span><span class="whitespace"> &#xD;
        </span><span class="op">where</span><span class="whitespace"> </span><span class="function">fn:not</span><span class="parenthesis">(</span><span class="function">fn:lower-case</span><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">"</span><span class="literal" pos="53526">all</span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">&#xD;
        </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace">&#xD;
        </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
    </span><span class="op">where</span><span class="whitespace"> </span><span class="variable">$types</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
    </span><span pos="53606" class="es">&lt;</span><span pos="53607" class="en">param</span><span pos="53612" class="atn"> value</span><span pos="53618" class="atneq">=</span><span pos="53619" class="z">"</span><span pos="53620" class="op">{</span><span class="variable">$i</span><span pos="53623" class="op">}</span><span pos="53624" class="z">"</span><span pos="53625" class="z">&gt;</span><span pos="53626" class="op">{</span><span class="open"></span><span class="whitespace">&#xD;
    </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$type</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$types</span><span class="whitespace">&#xD;
    </span><span class="op">return</span><span class="whitespace">&#xD;
        </span><span pos="53674" class="es">&lt;</span><span pos="53675" class="en">type</span><span pos="53679" class="atn"> value</span><span pos="53685" class="atneq">=</span><span pos="53686" class="z">"</span><span pos="53687" class="op">{</span><span class="variable">$type</span><span pos="53693" class="op">}</span><span pos="53694" class="z">"</span><span pos="53695" class="z">/&gt;</span><span class="whitespace">&#xD;
    </span><span pos="53703" class="op">}</span><span pos="53704" class="sc">&lt;/</span><span pos="53706" class="cl">param</span><span pos="53711" class="z">&gt;</span><span class="whitespace">&#xD;
    </span><span pos="53718" class="op">}</span><span pos="53719" class="sc">&lt;/</span><span pos="53721" class="cl">search-item-types</span><span pos="53738" class="z">&gt;</span><span class="open"></span><span class="whitespace">&#xD;
</span><span class="op">}</span><span class="whitespace">&#xD;
&#xD;
</span><span class="qname">define</span><span class="whitespace"> </span><span class="qname">function</span><span class="whitespace"> </span><span class="function">capitalize-first-chars</span><span class="parenthesis">(</span><span class="variable">$text</span><span class="whitespace"> </span><span class="op">as</span><span class="whitespace"> </span><span class="type-name">xs:string</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">{</span><span class="whitespace">&#xD;
    </span><span class="function">fn:string-join</span><span class="parenthesis">(</span><span class="whitespace">&#xD;
        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$tok</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="function">fn:tokenize</span><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="op">"</span><span class="literal" pos="53868"> </span><span class="op">"</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> &#xD;
        </span><span class="op">return</span><span class="whitespace"> &#xD;
            </span><span class="function">fn:concat</span><span class="parenthesis">(</span><span class="whitespace"> &#xD;
                </span><span class="function">fn:upper-case</span><span class="parenthesis">(</span><span class="function">fn:substring</span><span class="parenthesis">(</span><span class="variable">$tok</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
                </span><span class="function">fn:substring</span><span class="parenthesis">(</span><span class="variable">$tok</span><span class="op">,</span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace">&#xD;
            </span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">&#xD;
        </span><span class="op">"</span><span class="literal" pos="54035"> </span><span class="op">"</span><span class="whitespace">&#xD;
    </span><span class="parenthesis">)</span><span class="whitespace">&#xD;
</span><span class="op">}</span></pre></div></body></html>