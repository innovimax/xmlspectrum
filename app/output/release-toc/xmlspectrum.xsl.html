<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>xmlspectrum.xsl</title><link rel="stylesheet" type="text/css" href="theme.css"></link></head><body><div><pre class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="utf-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="z">&lt;!--</span><span class="cm">
     XMLSpectrum by Phil Fearon Qutoric Limited 2012 (c)
     http://qutoric.com
     License: Apache 2.0 http://www.apache.org/licenses/LICENSE-2.0.html
     
     Purpose: Syntax highlighter for XPath (text), XML, XSLT and XSD 1.1 file formats
     
     Interface Functions:
     ====================
     f:render(xml-content, is-xml, root-prefix)
     loc:showXPath(text-content)
     f:get-css(color-theme)
     f:indent(spans, char-width)
     f:link(spans, paths, location)
     
     Interface Templates:
     ====================
     &lt;xsl:template match="span" mode="markup"&gt;
     
     Global Variables (for overriding)
     =================================
     w3c-xpath-functions-uri: location of resource proxy
     font-name:               abbreviated font name [std|scp] default
                              is std for standard monospace - override
                              with 'scp' for 'Souce Code Pro'
                              font-family
     
</span><span class="z">--&gt;</span><span class="txt">

</span><span class="ww" id="w9"><span class="es">&lt;</span><a class="solar" href="index.html"><span class="enxsl" id="e?{http://www.w3.org/1999/XSL/Transform}stylesheet">xsl:stylesheet</span></a><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:loc</span><span class="atneq">=</span><span class="z">"</span><span class="av">com.qutoric.sketchpath.functions</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:css</span><span class="atneq">=</span><span class="z">"</span><span class="av">css-defs.com</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:dt</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://qutoric.com.xmlspectrum.document-types</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">loc f xs css c qf dt</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:c</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://xmlspectrum.colors.org</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xpath-default-namespace</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:qf</span><span class="atneq">=</span><span class="z">"</span><span class="av">urn:xq.internal-function</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">internal</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  </span><span class="ww" id="w85"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html" class="solar"><span class="href">doctype-functions.xsl</span></a><span class="z">"</span><span id="wx93" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w95"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html" class="solar"><span class="href">xq-spectrum.xsl</span></a><span class="z">"</span><span id="wx103" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w105"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xslt-formatting-functions.xsl.html" class="solar"><span class="href">xslt-formatting-functions.xsl</span></a><span class="z">"</span><span id="wx113" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w115"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?color-theme">color-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="z">"</span><span id="wx131" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w133"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?force-newline">force-newline</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx149" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w151"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?format-mixed-content">format-mixed-content</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx167" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w169"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?ignore-mc">ignore-mc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="highlight-file.xsl.html#p?format-mixed-content" class="solar"><span class="variable">$format-mixed-content</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="z">"</span><span id="wx196" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w198"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?insert-newlines">insert-newlines</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="xmlspectrum.xsl.html#p?force-newline" class="solar"><span class="variable">$force-newline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx225" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w227"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?max-newline-length">max-newline-length</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">80</span><span class="z">"</span><span id="wx247" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w249"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?resolved-theme">resolved-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">light</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-light</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-dark</span><span class="op">'</span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="z">"</span><span id="wx313" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="z">&lt;!--</span><span class="cm"> override these variables </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w319"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?w3c-xpath-functions-uri">w3c-xpath-functions-uri</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">http://www.w3.org/TR/xpath-functions/</span><span class="op">'</span><span class="z">"</span><span id="wx335" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w337"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?font-name">font-name</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">std</span><span class="op">'</span><span class="z">"</span><span id="wx353" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w355"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?theme-doc-uri">theme-doc-uri</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">data/color-themes.xml</span><span class="op">'</span><span class="z">"</span><span id="wx371" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w373"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-inline">css-inline</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx389" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w391"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-doc">css-doc</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function">doc</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-resolve-uri" class="solar"><span class="function">resolve-uri</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?theme-doc-uri" class="solar"><span class="variable">$theme-doc-uri</span></a><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-static-base-uri" class="solar"><span class="function">static-base-uri</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx416" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w418"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-theme-data">color-theme-data</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:theme)</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">c:theme</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#f?{internal}get-theme" class="solar"><span class="function">f:get-theme</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?resolved-theme" class="solar"><span class="variable">$resolved-theme</span></a><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx453" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w455"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-modes">color-modes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(colors)*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}get-inline-colors" class="solar"><span class="function">f:get-inline-colors</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx478" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w480"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?document-type">document-type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx496" class="sc">/&gt;</span></span><span class="txt">
  
  
  </span><span class="z">&lt;!--</span><span class="cm">
       signature:
           f:render(xml-content, is-xml, root-prefix)
       
       description:
           Converts the xml content string to a sequence of span elements. with each
           containing a class attribute used for coloring with CSS. 
       
       params:
           xml-content: string containing well-balanced XML extract - namespace and prefix
                        declarations not required
           is-xsl:      boolean specifying whether coloring is for XSLT, if this is false
                        then XSD 1.1 coloring scheme is used instead
           root-prefix: string prefix used for elements requiring special coloring for XSLT
                        or XSD 1.1 - often 'xsl' and 'xs' respectively
  </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="ww" id="w502"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}render">f:render</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w512"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xmlText">xmlText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx526" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w528"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx542" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w544"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix-a">root-prefix-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx558" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w560"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> 
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx611" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w613"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens-a">tokens-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$xmlText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx642" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w644"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w648"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">doctype: </span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx654" class="ec">&gt;</span></span><span class="txt"></span><span class="ww" id="w656"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx664" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w666"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">rendering </span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx672" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w674"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string" class="solar"><span class="function">string</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">'</span><span class="literal"> </span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx696" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w698"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx706" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w708"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt"> tokens ...</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx714" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx718" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w720"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$tokens-a</span><span class="z">"</span><span id="wx765" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w767"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="xmlspectrum.xsl.html#f?{internal}iterateTokens" class="solar"><span class="function">f:iterateTokens</span></a><span class="parenthesis">(</span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="op">,</span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx816" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w818"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w822"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="highlight-file.xsl.html#p?css-inline" class="solar"><span class="variable">$css-inline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w839"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span id="wx847" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx851" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w853"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w857"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}style-spans" class="solar"><span class="function">f:style-spans</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx868" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx872" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx876" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx880" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       XSLT function signature: 
           f:get-css()
       
       description:
       
           Generates a CSS file used to colorise span elements generates by the previous 2 functions
           The colors generated depend on the theme specified with the color-theme
           parameter. The color theme uses the 'Solarized' color points specified at: http://ethanschoonover.com/solarized
       
       params:
           color-theme: xs:string - name of color theme to use 
       
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w886"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-theme">f:get-theme</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w896"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?input-theme">input-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx910" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w912"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$input-theme</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">light</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-light</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$input-theme</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-dark</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$input-theme</span><span class="z">"</span><span id="wx964" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx968" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w970"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-css">f:get-css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w980"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx998" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1002" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1004"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-css-font">f:get-css-font</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1014"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:font</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1034" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1038" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1040"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}inline-css-main">f:inline-css-main</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1056"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-text">css-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1072"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:main</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1092" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx1096" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1098"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$css-text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1115" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1119" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1121"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}inline-css-toc">f:inline-css-toc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1137"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-text">css-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1153"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:toc</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1173" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx1177" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1179"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$css-text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1196" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1200" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1202"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:font</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1218"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?font-name" class="solar"><span class="variable">$font-name</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scp</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">scp</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx1249" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1253" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1255"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:map</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1271"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?element">element</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">element</span><span class="z">"</span><span id="wx1286" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1288"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="qname">c:color</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1300"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1315" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1317"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-value">color-value</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">value</span><span class="z">"</span><span id="wx1332" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1334"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-selectors">color-selectors</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color)</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="context">..</span><span class="step">/</span><span class="qname">c:color-map</span><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color</span><span class="filter">]</span><span class="z">"</span><span id="wx1368" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1370"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-prop">css-prop</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="parenthesis">(</span><span class="variable">$color-selectors</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">color</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx1398" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1400"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selectors">selectors</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$color-selectors</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1417" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1419"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selector-tokens">selector-tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$selectors</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string+</span><span class="z">"</span><span id="wx1448" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1450"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?qselector-tokens">qselector-tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$selector-tokens</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                                                    </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$element</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">.</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$s</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1486" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1488"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selector-string">selector-string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$qselector-tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">, </span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1511" class="sc">/&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w1513"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="whitespace">
                            </span><span class="variable">$selector-string</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal"> {</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$css-prop</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal">: #</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$color-value</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal">; }</span><span class="op">'</span><span class="whitespace">
                            </span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1550" class="sc">/&gt;</span></span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1554" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1558" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       Sample output:
       &lt;colors&gt;
       &lt;color name="yellow" value="b58900" property="background-color"&gt;
       &lt;class&gt;yellow&lt;/class&gt;
       &lt;class&gt;op&lt;/class&gt;
       &lt;class&gt;type-op&lt;/class&gt;
       &lt;/color&gt;
       ...
       &lt;/colors&gt;
       
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w1564"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-inline-colors">f:get-inline-colors</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(colors)+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1580"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?theme">theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:theme)</span><span class="z">"</span><span id="wx1594" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1596"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-map">color-map</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$theme</span><span class="step">/</span><span class="context">..</span><span class="step">/</span><span class="qname">c:color-map</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color-map)</span><span class="z">"</span><span id="wx1620" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1622"><span class="es">&lt;</span><span class="en">colors</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1626"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$theme</span><span class="step">/</span><span class="qname">c:color</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1638"><span class="es">&lt;</span><span class="en">color</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1642"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="z">"</span><span id="wx1651" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1653"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-key">color-key</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1668" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1670"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color)</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color-map</span><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color-key</span><span class="filter">]</span><span class="z">"</span><span id="wx1700" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1702"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1715"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">property</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="z">"</span><span id="wx1732" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx1736" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1738"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$color</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1760"><span class="es">&lt;</span><span class="en">class</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w1764"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx1772" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">class</span><span id="wx1776" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1780" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">color</span><span id="wx1784" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1788" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="cl">colors</span><span id="wx1792" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1796" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1798"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:color</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1814"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1829" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1831"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">#</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1861" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1865" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1867"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getTagType">f:getTagType</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1877"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?token">token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx1891" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1893"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t">t</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span id="wx1907" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1909"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1930" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1932"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t2">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1953" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1955"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1959"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w1976"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">pi</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span id="wx1991" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1995" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1997"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2025"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cm</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">!--</span><span class="op">'</span><span class="z">"</span><span id="wx2040" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2044" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2046"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2074"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cd</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">![CDATA[</span><span class="op">'</span><span class="z">"</span><span id="wx2089" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2093" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2095"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2112"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">dt</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span id="wx2127" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2131" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2133"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2150"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span id="wx2165" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2169" class="ec">&gt;</span></span><span class="txt">
      </span><span class="z">&lt;!--</span><span class="cm"> open tag (may be  self-closing) </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="ww" id="w2175"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2179"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">tg</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx2194" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2198" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2202" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2206" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2208"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}expected-offset">f:expected-offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2224"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?in">in</span><span class="z">"</span><span id="wx2232" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2234"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?&amp;gt;</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">--&amp;gt;</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]]&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">9</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx2299" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2303" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2305"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}iterateTokens">f:iterateTokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2321"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?counter">counter</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2335" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2337"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span id="wx2351" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2353"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2367" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2369"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expected">expected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2383" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2385"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?beganAt">beganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2399" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2401"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2415" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2417"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2431" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2433"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2447" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2449"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expand-text-stack">expand-text-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx2463" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2465"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$doctype</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xslt</span><span class="op">'</span><span class="z">"</span><span id="wx2492" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2494"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2517" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2519"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?token">token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2542" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2544"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prevToken">prevToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2571" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2573"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextToken">nextToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2600" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2602"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$expected</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2629" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2631"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expand-text">expand-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx2656" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;trace&gt;
         token: &lt;xsl:value-of select="$token"/&gt;
         expected: &lt;xsl:value-of select="$expected"/&gt;
         index: &lt;xsl:value-of select="$index"/&gt;
         &lt;/trace&gt;
    </span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w2662"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expectedOutput">expectedOutput</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2678"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">  looking to close an open tag </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm"> consider: &lt;!DOCTYPE person [&lt;!ELEMENT ... ]&gt; as well as reference only </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w2696"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?beforeFind">beforeFind</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2716" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2718"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?found">found</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                              </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2765" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2767"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$found</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2777"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}expected-offset" class="solar"><span class="function">f:expected-offset</span></a><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2800" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2802"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?begin-token">begin-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="z">"</span><span id="wx2819" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2821"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2831"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2856" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2860" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2862"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part-token">part-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2886" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2888"><span class="es">&lt;</span><span class="en">span</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2892"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getTagType" class="solar"><span class="function">f:getTagType</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx2915" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2917"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> 
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="whitespace">
                        </span><span class="parenthesis">(</span><span class="variable">$part-token</span><span class="op">,</span><span class="whitespace">
                        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                        </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$x</span><span class="filter">]</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="z">"</span><span id="wx2984" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2988" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2990"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w3000"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expected</span><span class="z">"</span><span id="wx3008" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3012" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3014"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3054" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3056"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w3060"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3070"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3081" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3085" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3087"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3091"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w3101"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx3109" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3113" class="ec">&gt;</span></span><span class="txt">
              
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx3117" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3121" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx3125" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx3129" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3133" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3135"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char1">char1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3162" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3164"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-element-start">is-element-start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3213" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3215"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-root-element">is-root-element</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$counter</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$is-element-start</span><span class="z">"</span><span id="wx3243" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> if root-prefix not initially supplied, get this from the first element name </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w3249"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?new-root-prefix">new-root-prefix</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-root-element</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace">
                          </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> 
                          </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$x</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                              </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$s</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="z">"</span><span id="wx3366" class="sc">/&gt;</span></span><span class="txt">
    
    
    </span><span class="z">&lt;!--</span><span class="cm"> return 2 strings if required close found - that befoe and that after (even if empty string)
         if no required close found - just return the required close</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w3372"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3388"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3401"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?requiredClose">requiredClose</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3417"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char2">char2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3444" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3446"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w3450"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">?&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3469" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3471"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">--&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3501" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3503"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">]]&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3533" class="ec">&gt;</span></span><span class="txt"> </span><span class="z">&lt;!--</span><span class="cm"> assume cdata: &lt;![CDATA[]]&gt; </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="ww" id="w3539"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3556"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-contains" class="solar"><span class="function">contains</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]&gt;</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="z">"</span><span id="wx3590" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3594" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3596"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx3602" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3606" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3610" class="ec">&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w3612"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?beforeClose">beforeClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx3638" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w3640"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3644"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
                 &lt;x/&gt;
            </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3667" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3669"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-element-start</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm"> cdata, dtd, pi, comment, or close-tag </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="ww" id="w3686"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?foundClose">foundClose</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                                  </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                                  </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                          </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx3733" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3735"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3739"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$foundClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w3749"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagType">tagType</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getTagType" class="solar"><span class="function">f:getTagType</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string+</span><span class="z">"</span><span id="wx3772" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3774"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagStart">tagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx3791" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3793"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isElementClose">isElementClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span id="wx3814" class="sc">/&gt;</span></span><span class="txt">
                
                </span><span class="ww" id="w3816"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ez</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w3846"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3862" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3866" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3868"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagContent">tagContent</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3895" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3897"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?with-prefix">with-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$tagContent</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx3923" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3925"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w3929"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w3939"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="whitespace">
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace">
                                 </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$tagContent</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-fnames" class="solar"><span class="function">f:get-xsd-fnames</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="step">/</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace">
                                 </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4014"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span id="wx4022" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4026" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4030" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4032"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4036"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4051"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span id="wx4059" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4063" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4067" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4071" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4073"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ec</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4103"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="z">&lt;!--</span><span class="cm">
                         &lt;xsl:attribute name="id" select="js:stackPop()"/&gt;
                    </span><span class="z">--&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4119" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4121"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span id="wx4129" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4133" class="ec">&gt;</span></span><span class="txt">
                
                </span><span class="ww" id="w4135"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4175" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4177"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4181"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4191"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4202" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4206" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4208"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4212"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4222"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx4230" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4234" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4238" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4242" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4246" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ww" id="w4248"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w4252"><span class="es">&lt;</span><span class="en">required</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4256"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span id="wx4264" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="cl">required</span><span id="wx4268" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4272" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4276" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4280" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w4282"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            
            </span><span class="ww" id="w4286"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?parts">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w4302"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">&amp;quot;.*?&amp;quot;|'.*?'|[^'&amp;quot;]+|['&amp;quot;]</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w4324"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4328"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx4336" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx4340" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4342"><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4346"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx4354" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span id="wx4358" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx4362" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4366" class="ec">&gt;</span></span><span class="txt">
            
            </span><span class="ww" id="w4368"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="xmlspectrum.xsl.html#f?{internal}getAttributes" class="solar"><span class="function">f:getAttributes</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$new-root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4408" class="sc">/&gt;</span></span><span class="txt">
            
            </span><span class="z">&lt;!--</span><span class="cm"> must be an open tag, so check for attributes </span><span class="z">--&gt;</span><span class="txt">
            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4416" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4420" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4424" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4428" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4430"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span id="wx4450" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w4452"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newCounter">newCounter</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-element-start</span><span class="parenthesis">)</span><span class="whitespace">
                                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$counter</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$counter</span><span class="z">"</span><span id="wx4482" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4484"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?stillAwaiting">stillAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$expectedOutput</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4511" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4513"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-name" class="solar"><span class="function">name</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">required</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4539"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parseStrings</span><span class="z">"</span><span id="wx4547" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4551" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4553"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expectedOutput</span><span class="z">"</span><span id="wx4561" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4563"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newExpected">newExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$parseStrings</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span id="wx4636" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4638"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newBeganAt">newBeganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$index</span><span class="z">"</span><span id="wx4670" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4672"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4689"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}iterateTokens" class="solar"><span class="function">f:iterateTokens</span></a><span class="parenthesis">(</span><span class="variable">$newCounter</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$newExpected</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newBeganAt</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$new-root-prefix</span><span class="op">,</span><span class="whitespace"> 
                            </span><a href="xmlspectrum.xsl.html#f?{internal}getNewExpandStack" class="solar"><span class="function">f:getNewExpandStack</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text-stack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4735" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4739" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx4743" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w4745"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getNewExpandStack">f:getNewExpandStack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w4761"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx4775" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w4777"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expandStack">expandStack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx4791" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> don't and empty tag value to stack </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4797"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?startXslTag">startXslTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="open"></span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">sc</span><span class="op">'</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4849" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w4851"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?closeXslTag">closeXslTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4885" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w4887"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getExpandTextValue" class="solar"><span class="function">f:getExpandTextValue</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4910" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4912"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$startXslTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expandStack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$closeXslTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="variable">$expandStack</span><span class="z">"</span><span id="wx4989" class="sc">/&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx4993" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w4995"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getExpandTextValue">f:getExpandTextValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5011"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5025" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5027"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="open"></span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                          </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="variable">$i</span><span class="filter">]</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">expand-text</span><span class="op">'</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="filter">]</span><span class="step">/</span><span class="node-type">text</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5138" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5140"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$expandValue</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5167" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5171" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5173"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}checkExpandSpans">f:checkExpandSpans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5189"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5203" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5205"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?existing-expand-state">existing-expand-state</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx5219" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5221"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                          </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="filter">]</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">expand-text</span><span class="op">'</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="filter">]</span><span class="step">/</span><span class="node-type">text</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5306" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5308"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$expandValue</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$existing-expand-state</span><span class="z">"</span><span id="wx5334" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5338" class="ec">&gt;</span></span><span class="txt">
  
  
  </span><span class="ww" id="w5340"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getAttributes">f:getAttributes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5356"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?attToken">attToken</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5370" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5372"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5386" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5388"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parts">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span id="wx5402" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5404"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5418" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5420"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5434" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5436"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5450" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5452"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?ename">ename</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5466" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5468"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expand-text">expand-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5482" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5484"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$doctype</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xslt</span><span class="op">'</span><span class="z">"</span><span id="wx5511" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5513"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5536" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5538"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part1">part1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx5561" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5563"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part2">part2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx5590" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5592"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?elementName">elementName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$ename</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;|\s+|/</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$ename</span><span class="z">"</span><span id="wx5643" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5645"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?with-prefix">with-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5665" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5667"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl-element">is-xsl-element</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$with-prefix</span><span class="z">"</span><span id="wx5685" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5687"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w5701"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">es</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx5713" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w5715"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-fnames" class="solar"><span class="function">f:get-xsd-fnames</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="step">/</span><span class="axis">@</span><span class="qname">name</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="open"></span><span class="whitespace"> 
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">
             id="{js:stackPush($elementName)}"&gt;
        </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w5825"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$elementName</span><span class="z">"</span><span id="wx5833" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx5837" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5841" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5843"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pre-close">pre-close</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5866" class="sc">/&gt;</span></span><span class="txt"> 
    
    </span><span class="ww" id="w5868"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isFinalPart">isFinalPart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parts</span><span class="parenthesis">)</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                  </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5922" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5924"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      
      </span><span class="ww" id="w5940"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w5944"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isFinalPart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm">  use sc class value to mark end of self-closed element </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w5958"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isSelfClosed">isSelfClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-ends-with" class="solar"><span class="function">ends-with</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5986" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5988"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">sc</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scx</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6018"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx6044" class="sc">/&gt;</span></span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6048" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6050"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6087" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6089"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6093"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6103"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6114" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6118" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w6120"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6124"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w6134"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx6142" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6146" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6150" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6154" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6158" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6160"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm"> attribute must exist and name occurs before value, so get this first </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6177"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?left">left</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$part1</span><span class="z">"</span><span id="wx6226" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6228"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pre">pre</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><span class="op">'</span><span class="literal">=</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6250" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm">
               &lt;xsl:variable name="tokens" select="tokenize($pre, '\s+')"/&gt;
          </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6256"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}splitAttributeName" class="solar"><span class="function">f:splitAttributeName</span></a><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6273" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6275"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?attSpans">attSpans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6291"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6301"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class">class</span><span class="z">"</span><span class="z">
                            </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-matches" class="solar"><span class="function">matches</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="op">'</span><span class="literal">\S</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                    </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                                    </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="z">"</span><span id="wx6341" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w6343"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w6355"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx6363" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6367" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx6371" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6375" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6377"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?att-name">att-name</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$attSpans</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="filter">]</span><span class="z">"</span><span id="wx6402" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6404"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xsd-xpath-elements">xsd-xpath-elements</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-element-names" class="solar"><span class="function">f:get-xsd-element-names</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx6430" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6432"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xsd-xpath-attributes">xsd-xpath-attributes</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-attribute-names" class="solar"><span class="function">f:get-xsd-attribute-names</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx6458" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6460"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attSpans</span><span class="z">"</span><span id="wx6468" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6470"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isXPath">isXPath</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">select</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">test</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">match</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xpath</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">context-item</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">namespace-context</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                                
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$xsd-xpath-attributes</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                
                                </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="whitespace"> 
                                </span><span class="variable">$xsd-xpath-attributes</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="filter">]</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                
                                </span><span class="op">else</span><span class="whitespace">
                                
                                </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="whitespace"> 
                                </span><span class="variable">$xsd-xpath-elements</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="step">/</span><span class="qname">dt:att</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="filter">]</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                </span><span class="z">"</span><span id="wx6600" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="z">&lt;!--</span><span class="cm"> for coloring attribute values that are referenced from XPath </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6606"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?metaXPathName">metaXPathName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}get-av-class" class="solar"><span class="function">f:get-av-class</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsd</span><span class="op">,</span><span class="whitespace"> 
                                       </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6644" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6646"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">atneq</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w6656"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6676" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6680" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6682"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?sl">sl</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:double</span><span class="z">"</span><span id="wx6705" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6707"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w6717"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6732" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6736" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6738"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?attValue">attValue</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6765" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6767"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6771"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6781"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{com.qutoric.sketchpath.functions}showXPath" class="solar"><span class="function">loc:showXPath</span></a><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6792" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6796" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w6798"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$metaXPathName</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="z">&lt;!--</span><span class="cm">
                   &lt;xsl:sequence select="f:processAVT($attValue, $metaXPathName)"/&gt;
              </span><span class="z">--&gt;</span><span class="txt">
              </span><span class="ww" id="w6823"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?att-spans">att-spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6846" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w6848"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$att-spans</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w6858"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w6862"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="whitespace"> </span><span class="op">except</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx6876" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w6878"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx6915" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w6917"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6927" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx6931" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx6935" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6939" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w6941"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6945"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$metaXPathName</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w6957"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attValue</span><span class="z">"</span><span id="wx6965" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6969" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6973" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6977" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6979"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w6989"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7003" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7007" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7011" class="ec">&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7015" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7019" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7021"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newExpandText">newExpandText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><a href="xmlspectrum.xsl.html#f?{internal}checkExpandSpans" class="solar"><span class="function">f:checkExpandSpans</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="variable">$expand-text</span><span class="z">"</span><span id="wx7058" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7060"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span id="wx7068" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7070"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newOffset">newOffset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="z">"</span><span id="wx7098" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7100"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$isFinalPart</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w7113"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getAttributes" class="solar"><span class="function">f:getAttributes</span></a><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newOffset</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newExpandText</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7149" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7153" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7157" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7159"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-av-class">f:get-av-class</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7175"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-xsl-element">is-xsl-element</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx7189" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7191"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx7205" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7207"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx7221" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7223"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?elementName">elementName</span><span class="z">"</span><span id="wx7231" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7233"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?att-name">att-name</span><span class="z">"</span><span id="wx7241" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7243"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span id="wx7251" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7253"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?vp-name">vp-name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">param</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7290" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7292"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p-name">p-name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$vp-name</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx7315" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7317"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$vp-name</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$p-name</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">pname</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">vname</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">import</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">include</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">href</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">href</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">call-template</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">tcall</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> 
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">template</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> 
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">tname</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> 
                 </span><span class="op">and</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}is-xsd-fname" class="solar"><span class="function">f:is-xsd-fname</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="z">"</span><span id="wx7589" class="sc">/&gt;</span></span><span class="txt">
    
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7593" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7595"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}unescape-p">f:unescape-p</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7605"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx7613" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7615"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">{{</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7644" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7646"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">}}</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7669" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7673" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7675"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}processAVT">f:processAVT</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7685"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?attText">attText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx7699" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7701"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?class">class</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx7715" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7717"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?regex1">regex1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">\{.*?\}</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx7739" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7741"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$attText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\{\{</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7770" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7772"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t2">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\}\}</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7801" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> flags:s = match . to any char including \n </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w7807"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t2</span><span class="z">"</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$regex1</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      
      </span><span class="ww" id="w7831"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7835"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}unescape-p" class="solar"><span class="function">f:unescape-p</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7868" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w7870"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7880"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">{</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx7886" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7890" class="ec">&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w7892"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{com.qutoric.sketchpath.functions}showXPath" class="solar"><span class="function">loc:showXPath</span></a><span class="parenthesis">(</span><span class="variable">$p</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7903" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w7905"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7915"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">}</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx7921" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7925" class="ec">&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx7929" class="ec">&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w7931"><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7935"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}unescape-p" class="solar"><span class="function">f:unescape-p</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7952" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w7954"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7966"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$p</span><span class="z">"</span><span id="wx7974" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7978" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span id="wx7982" class="ec">&gt;</span></span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx7986" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7990" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7992"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}splitAttributeName">f:splitAttributeName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8002"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx8010" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8012"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">(\S+)|(\s+)</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8028"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8032"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx8040" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx8044" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx8048" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8052" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       signature:
           loc:showXPath(text-content)
       
       description:
       
           Converts the xpath content string to a sequence of span elements. with each
           containing a class attribute used for coloring with CSS. 
       
       params:
          text-content: string containing a single XPath expression
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w8058"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{com.qutoric.sketchpath.functions}showXPath">loc:showXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8068"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chunk">chunk</span><span class="z">"</span><span id="wx8076" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;xsl:variable name="chars" as="xs:string*"
         select="loc:stringToCharSequence($chunk)"/&gt;
         
         &lt;xsl:variable name="blocks" as="element()*"&gt;
         &lt;xsl:sequence select="loc:createBlocks($chars, false(), 1, '', 0, 0)"/&gt;
         &lt;/xsl:variable&gt;
         &lt;xsl:variable name="pbPairs" as="element()*"
         select="loc:createPairs($blocks[name() = 'block' and @type = ('[',']','(',')')])"/&gt;
         
         &lt;xsl:variable name="omitPairs" as="element()*"
         select="($blocks[name() = ('literal','comment')])"/&gt;
         
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w8082"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8098"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xquery" class="solar"><span class="function">qf:show-xquery</span></a><span class="parenthesis">(</span><span class="variable">$chunk</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8109" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx8113" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w8115"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8119"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="highlight-file.xsl.html#p?css-inline" class="solar"><span class="variable">$css-inline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8136"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span id="wx8144" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx8148" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8150"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8154"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}style-spans" class="solar"><span class="function">f:style-spans</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8165" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx8169" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx8173" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8177" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w8179"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}style-spans">f:style-spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8195"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()*</span><span class="z">"</span><span id="wx8209" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8211"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8221"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-key">color-key</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx8236" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8238"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-mode1">color-mode1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(color)?</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-modes" class="solar"><span class="variable">$color-modes</span></a><span class="step">/</span><span class="qname">color</span><span class="filter">[</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$color-key</span><span class="filter">]</span><span class="z">"</span><span id="wx8267" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="z">&lt;!--</span><span class="cm"> use the yellow color mode if none defined for class </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="ww" id="w8273"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-mode2">color-mode2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(color)</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$color-mode1</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$color-mode1</span><span class="whitespace">
                            </span><span class="op">else</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#v?color-modes" class="solar"><span class="variable">$color-modes</span></a><span class="step">/</span><span class="qname">color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yellow</span><span class="op">'</span><span class="filter">]</span><span class="z">"</span><span id="wx8321" class="sc">/&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w8323"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?property">property</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="parenthesis">)</span><span class="whitespace">
                                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="whitespace">
                                            </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">color</span><span class="op">'</span><span class="z">"</span><span id="wx8358" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8360"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8364"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="z">"</span><span id="wx8373" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w8375"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">style</span><span class="z">"</span><span class="z">
                       </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$property</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">: #</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8404" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w8406"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx8414" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx8418" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx8422" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8426" class="ec">&gt;</span></span><span class="txt">
  
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span id="wx8430" class="ec">&gt;</span></span><span class="txt">
</span></pre></div></body></html>