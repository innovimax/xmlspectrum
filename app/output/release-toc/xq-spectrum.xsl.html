<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>xq-spectrum.xsl</title><link rel="stylesheet" type="text/css" href="theme.css"></link></head><body><div><pre class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="UTF-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="ww" id="w5"><span class="es">&lt;</span><a class="solar" href="index.html"><span class="enxsl" id="e?{http://www.w3.org/1999/XSL/Transform}stylesheet">xsl:stylesheet</span></a><span class="z"> </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">urn:xq.internal-function</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xq</span><span class="atneq">=</span><span class="z">"</span><span class="av">com.qutoric.xq.functions</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xpath-default-namespace</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">f xs xq</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  </span><span class="ww" id="w57"><span class="es">&lt;</span><span class="enxsl">xsl:output</span><span class="z"> </span><span class="atn">indent</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx65" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w67"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html" class="solar"><span class="href">xq-handler.xsl</span></a><span class="z">"</span><span id="wx75" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w77"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cQuote">cQuote</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">34</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx97" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w99"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cApos">cApos</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">39</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx119" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w121"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cColon">cColon</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">58</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx141" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w143"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cParenStart">cParenStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">91</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx163" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w165"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cParenEnd">cParenEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">93</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx185" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w187"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cBracketStart">cBracketStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">40</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx207" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w209"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cBracketEnd">cBracketEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">41</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx229" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w231"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cCloseComment">cCloseComment</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="z">"</span><span id="wx254" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w256"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cTagStart">cTagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">60</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx276" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w278"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cTagEnd">cTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">62</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx298" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w300"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cWhitespace">cWhitespace</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">13</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">32</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx323" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w325"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cFnStart">cFnStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">123</span><span class="z">"</span><span id="wx345" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w347"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cFnEnd">cFnEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">125</span><span class="z">"</span><span id="wx367" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w369"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xExclam">xExclam</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">33</span><span class="z">"</span><span id="wx389" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w391"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xPI">xPI</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">63</span><span class="z">"</span><span id="wx411" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w413"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xSlash">xSlash</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">47</span><span class="z">"</span><span id="wx433" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w435"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xHyphen">xHyphen</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">45</span><span class="z">"</span><span id="wx455" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w457"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xEquals">xEquals</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">61</span><span class="z">"</span><span id="wx477" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="z">&lt;!--</span><span class="cm"> unused codepoints when waiting for / or &gt; chars </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w483"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxInitTagEnd">xxInitTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">6</span><span class="z">"</span><span id="wx503" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w505"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxTagEnd">xxTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">7</span><span class="z">"</span><span id="wx525" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w527"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxAnyTagEnd">xxAnyTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">6</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">7</span><span class="z">"</span><span id="wx550" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w552"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxCloseTagEnd">xxCloseTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">8</span><span class="z">"</span><span id="wx572" class="sc">/&gt;</span></span><span class="txt">     
  
  </span><span class="ww" id="w574"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}show-xquery">f:show-xquery</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w584"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx598" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w600"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text-points">text-points</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-to-codepoints" class="solar"><span class="function">string-to-codepoints</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx623" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w625"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w641"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$text-points</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx652" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx656" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w658"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx672" class="sc">/&gt;</span></span><span class="txt">             
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx676" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w678"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}show-xsl-tvt">f:show-xsl-tvt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w688"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx702" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w704"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefixed-text">prefixed-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;t&amp;gt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$doc-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx732" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w734"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text-points">text-points</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-to-codepoints" class="solar"><span class="function">string-to-codepoints</span></a><span class="parenthesis">(</span><span class="variable">$prefixed-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx757" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w759"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w775"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXslTvtBlocks" class="solar"><span class="function">f:createXslTvtBlocks</span></a><span class="parenthesis">(</span><span class="variable">$text-points</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx786" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx790" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w792"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$prefixed-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx812" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx816" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w818"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tokeniseBlocks">f:tokeniseBlocks</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w828"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx842" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w844"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx858" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w860"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx892" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx896" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w898"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tokeniseBlocks">f:tokeniseBlocks</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w908"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx922" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w924"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx938" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w940"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx954" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w956"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx970" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w972"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx986" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> if is-preceding-closed then an operator is expected next, normally a qname is expected
         but a comment may have been placed where an operator was expected - eg. abc (: test :) div def
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w992"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-preceding-closed">is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx1006" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1008"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?block">block</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$blocks</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span id="wx1031" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1033"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextBlock">nextBlock</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$blocks</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span id="wx1060" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1062"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-name" class="solar"><span class="function">name</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1085" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1087"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1144" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1146"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextStart">nextStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1203" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1205"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?length">length</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:double?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">length</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">length</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1288" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1290"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newType">newType</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="op">'</span><span class="literal">x-text</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> 
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx1353" class="sc">/&gt;</span></span><span class="txt">
    
     
    </span><span class="ww" id="w1355"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?count">count</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1378" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1380"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?followingStart">followingStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$length</span><span class="z">"</span><span id="wx1398" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> when closed, an op is expected next in xquery </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w1404"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?current-is-preceding-closed">current-is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1460" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1462"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isClose">isClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-close-tag</span><span class="op">'</span><span class="z">"</span><span id="wx1483" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1485"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isOpen">isOpen</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-open-tag</span><span class="op">'</span><span class="z">"</span><span id="wx1506" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1508"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isOpen</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx1552" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1554"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?shiftStart">shiftStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> 
                                                            </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="z">"</span><span id="wx1593" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1595"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text">text</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$length</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                      </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="parenthesis">)</span><span class="whitespace">
                                      </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$length</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1643" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1645"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?following-string">following-string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace">
                                                  </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                                  </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="whitespace">
                                                  </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1711" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1713"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?token-string">token-string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$following-string</span><span class="whitespace"> 
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="variable">$text</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx1775" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1777"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xq-token">xq-token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$token-string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$current-is-preceding-closed</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1819" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> todo: must check if whitespace found </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w1825"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?new-is-preceding-closed">new-is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$xq-token</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">whitespace</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">open</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1909" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1911"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1927"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1952"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text">text</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$doc-text</span><span class="whitespace">
                                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1994" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1996"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2012" class="sc">/&gt;</span></span><span class="txt">            
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2016" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2018"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">                &lt;xsl:when test="empty($length)"&gt;
             &lt;length-empty name="{$name}" shiftStart="{$shiftStart}" nextStart="{$nextStart}"/&gt;
             &lt;/xsl:when&gt;</span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w2026"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2039"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2049"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">sc</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;/</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2061" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2065" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2067"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpen</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2077"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">es</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2089" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2093" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2095"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2099"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2116"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="z">&lt;!--</span><span class="cm">&lt;xquery pos="{$shiftStart}"/&gt;</span><span class="z">--&gt;</span><span class="txt">
                </span><span class="ww" id="w2141"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xq-token</span><span class="z">"</span><span id="wx2149" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2153" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2157" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2159"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2183"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w2187"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w2204"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?quote">quote</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-codepoints-to-string" class="solar"><span class="function">codepoints-to-string</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2224" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2226"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2236"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$quote</span><span class="z">"</span><span id="wx2244" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2248" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2250"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w2262"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2286" class="sc">/&gt;</span></span><span class="txt">                               
                  </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2290" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2292"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2302"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$quote</span><span class="z">"</span><span id="wx2310" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2314" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2318" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w2320"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w2324"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w2336"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span id="wx2344" class="sc">/&gt;</span></span><span class="txt">                               
                  </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2348" class="ec">&gt;</span></span><span class="txt">                                   
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2352" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2356" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2360" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2362"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2366"><span class="es">&lt;</span><span class="en">span</span><span class="z">
                  </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                         </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getClassFromName" class="solar"><span class="function">f:getClassFromName</span></a><span class="parenthesis">(</span><span class="variable">$name</span><span class="parenthesis">)</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">                                      
                </span><span class="ww" id="w2410"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span id="wx2418" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2422" class="ec">&gt;</span></span><span class="txt">                           
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2426" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2430" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2434" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2438" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2440"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$followingStart</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2463"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2467"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">   
            </span><span class="ww" id="w2492"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xq-token</span><span class="z">"</span><span id="wx2500" class="sc">/&gt;</span></span><span class="txt">                     
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2504" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2506"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2531"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="open"></span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getClassFromType" class="solar"><span class="function">f:getClassFromType</span></a><span class="parenthesis">(</span><span class="variable">$newType</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2568"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$following-string</span><span class="z">"</span><span id="wx2576" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2580" class="ec">&gt;</span></span><span class="txt">                                          
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2584" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2588" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2592" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx2596" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2598"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2623" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2625"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2629"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$count</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2643"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="z">"</span><span id="wx2651" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2655" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2657"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2661"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newType</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$new-is-preceding-closed</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2691" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2695" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2699" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2703" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2705"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}handleXquery">f:handleXquery</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2721"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx2729" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2731"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-preceding-literal">is-preceding-literal</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2745" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2747"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-preceding-literal</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2761" class="sc">/&gt;</span></span><span class="txt">       
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2765" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2767"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXqBlocks">f:createXqBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2783"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx2797" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2799"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace">
                          </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2849" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2853" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2855"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXslTvtBlocks">f:createXslTvtBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2871"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx2885" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;xsl:sequence select="f:createXmlBlocks($chars, 1, $cTagStart, 1, 1, 1, (), (), ())"/&gt;
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w2891"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace">
                          </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2941" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2945" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2947"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class-in">class-in</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-comment</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">x-cdata</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">x-pi</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">x-dtd</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2987" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2989"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class-out">class-out</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">cm</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">cd</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">pi</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">dt</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3029" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3031"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name-in">name-in</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">nested-query</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">unnested-xquery</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-open-tag</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">xml-name-end</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-equals</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">xml-att-quote</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-literal-start</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-literal-end</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">resume-x-literal</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">resume-x-literal-txt</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-close-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3114" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3116"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name-out">name-out</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atneq</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3201" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3203"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getClassFromType">f:getClassFromType</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3213"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span id="wx3221" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3223"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-index-of" class="solar"><span class="function">index-of</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?class-in" class="solar"><span class="variable">$class-in</span></a><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3249" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3251"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$index</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?class-out" class="solar"><span class="variable">$class-out</span></a><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx3277" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3281" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3283"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getClassFromName">f:getClassFromName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3293"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span id="wx3301" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3303"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-index-of" class="solar"><span class="function">index-of</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?name-in" class="solar"><span class="variable">$name-in</span></a><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3329" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3331"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$index</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?name-out" class="solar"><span class="variable">$name-out</span></a><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx3357" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3361" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3363"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXmlBlocks">f:createXmlBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3379"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3393" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3395"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3409" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3411"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3425" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3427"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3441" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3443"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3457" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3459"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-fnlevel">xq-fnlevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3473" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3475"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xml-stack">xml-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3489" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3491"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-stack">xq-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3505" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3507"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx3521" class="sc">/&gt;</span></span><span class="txt">        
    
    </span><span class="ww" id="w3523"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx3546" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3548"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pChar">pChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx3575" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3577"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?n1Char">n1Char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx3604" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3606"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?n2Char">n2Char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx3633" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3635"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?limit">limit</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx3662" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3664"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?compChars">compChars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$i</span><span class="filter">]</span><span class="z">"</span><span id="wx3705" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3707"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isLiteralStart">isLiteralStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx3744" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3746"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isLiteralEnd">isLiteralEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx3783" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3785"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting-tag">awaiting-tag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3801"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3805"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3818"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getAwaitingFrom2ndChar" class="solar"><span class="function">f:getAwaitingFrom2ndChar</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3832" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3836" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w3838"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$char</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3860"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getAwaitingFrom2ndChar" class="solar"><span class="function">f:getAwaitingFrom2ndChar</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$n2Char</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3874" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3878" class="ec">&gt;</span></span><span class="txt">               
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3882" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3886" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3888"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?other-tag-end">other-tag-end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$compChars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3922" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3924"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3940"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3944"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$other-tag-end</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3954"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx3976" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3980" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w3982"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4004"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">1</span><span class="z">"</span><span id="wx4020" class="sc">/&gt;</span></span><span class="txt">               
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4024" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4026"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4048"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">1</span><span class="z">"</span><span id="wx4064" class="sc">/&gt;</span></span><span class="txt">                
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4068" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4070"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xEquals" class="solar"><span class="variable">$xEquals</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4092"><span class="es">&lt;</span><span class="en">x-equals</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx4102" class="sc">/&gt;</span></span><span class="txt">                
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4106" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4110" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4114" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> a close tag &lt;/close&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4120"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isCloseTag">isCloseTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="z">"</span><span id="wx4160" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> probably an open tag &lt;open&gt; - but may be empty eg. &lt;empty/&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4166"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isOpenTag">isOpenTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4225" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4227"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isTagNameEnd">isTagNameEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cWhitespace" class="solar"><span class="variable">$cWhitespace</span></a><span class="z">"</span><span id="wx4259" class="sc">/&gt;</span></span><span class="txt">        
    
    </span><span class="z">&lt;!--</span><span class="cm"> last 2 items in sequence are reserved for tag markup </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4265"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?count-awaiting">count-awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="z">"</span><span id="wx4292" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4294"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowAwaiting">nowAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4310"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w4314"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpenTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4324"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="z">"</span><span id="wx4332" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4336" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4338"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isTagNameEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4348"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxTagEnd" class="solar"><span class="variable">$xxTagEnd</span></a><span class="z">"</span><span id="wx4356" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4360" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4362"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isCloseTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4372"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="z">"</span><span id="wx4380" class="sc">/&gt;</span></span><span class="txt">                      
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4384" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4386"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4399"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$count-awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4416" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4420" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4422"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4444"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4452" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4456" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4458"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4485"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4493" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4497" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4499"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4509"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="z">"</span><span id="wx4517" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4521" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4523"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4533"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxTagEnd" class="solar"><span class="variable">$xxTagEnd</span></a><span class="z">"</span><span id="wx4541" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4545" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4547"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$compChars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm"> must always be waiting for something in XML, so assume tag start </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w4567"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4575" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4579" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4581"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4585"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx4593" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4597" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4601" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4605" class="ec">&gt;</span></span><span class="txt">
    
    
    </span><span class="z">&lt;!--</span><span class="cm"> required to correct an empty tag falsely assumed to be an open tag &lt;empty/&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4611"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isEmptyTag">isEmptyTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span id="wx4651" class="sc">/&gt;</span></span><span class="txt">       
    
    </span><span class="z">&lt;!--</span><span class="cm"> must ignore {{ char sequence, but no need to ignore }} </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4657"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isEmbeddedXQuery">isEmbeddedXQuery</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx4715" class="sc">/&gt;</span></span><span class="txt">
    
    
    </span><span class="ww" id="w4717"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?poss-xml-end">poss-xml-end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmptyTag</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$other-tag-end</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx4764" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4766"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isOpenTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isCloseTag</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$isEmptyTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span id="wx4822" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4824"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newXqFnLevel">newXqFnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isEmbeddedXQuery</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$xq-fnlevel</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$xq-fnlevel</span><span class="z">"</span><span id="wx4860" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">       &lt;xsl:variable name="test-string" select="codepoints-to-string(subsequence($chars, $index + 1, 10))"/&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w4866"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result2">result2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4882"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w4886"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isTagNameEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4896"><span class="es">&lt;</span><span class="en">xml-name-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx4906" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4910" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4912"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpenTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4922"><span class="es">&lt;</span><span class="en">xml-open-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx4952" class="sc">/&gt;</span></span><span class="txt">                    
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4956" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4958"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmptyTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4968"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">2</span><span class="z">"</span><span class="z"> </span><span class="atn">level</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$level</span><span class="op">}</span><span class="z">"</span><span id="wx4992" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4996" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4998"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isCloseTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5008"><span class="es">&lt;</span><span class="en">xml-close-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5018" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5022" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5024"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5034"><span class="es">&lt;</span><span class="en">xml-att-quote</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5044" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5046"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w5068"><span class="es">&lt;</span><span class="en">xml-literal-start</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5082" class="sc">/&gt;</span></span><span class="txt">                            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5086" class="ec">&gt;</span></span><span class="txt">            
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5090" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5092"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5102"><span class="es">&lt;</span><span class="en">xml-att-quote</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5112" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5114"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w5136"><span class="es">&lt;</span><span class="en">xml-literal-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5150" class="sc">/&gt;</span></span><span class="txt">                         
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5154" class="ec">&gt;</span></span><span class="txt">               
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5158" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5160"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5173"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting-offset">awaiting-offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx5208" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5210"><span class="es">&lt;</span><span class="en">xml-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$awaiting-offset</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">type</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$awaiting-tag</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$awaiting-tag</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span id="wx5254" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5258" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx5262" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5266" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5268"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5296" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5298"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xml-stack-level">xml-stack-level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx5338" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5340"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w5344"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">                
        </span><span class="ww" id="w5361"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="z">"</span><span id="wx5369" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5371"><span class="es">&lt;</span><span class="en">terminate-xml</span><span id="wx5373" class="sc">/&gt;</span></span><span class="txt">   
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5377" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w5379"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$newLevel</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$xml-stack-level</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$poss-xml-end</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">&lt;xsl:when test="($level eq $xml-stack-level and $char eq $cTagEnd) or ($level eq $xml-stack-level + 1 and $other-tag-end)"&gt;</span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w5403"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isEmptyTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$limit</span><span class="z">"</span><span id="wx5435" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5437"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5453"><span class="es">&lt;</span><span class="en">start-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5471" class="sc">/&gt;</span></span><span class="txt">                     
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5475" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5477"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?popped-stack">popped-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5513" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5515"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$popped-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5571" class="sc">/&gt;</span></span><span class="txt">                 
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5575" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w5577"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmbeddedXQuery</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w5587"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5603"><span class="es">&lt;</span><span class="en">nested-query</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5613" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5615"><span class="es">&lt;</span><span class="en">start-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5629" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5633" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5635"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace">
                              </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5696" class="sc">/&gt;</span></span><span class="txt">               
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5700" class="ec">&gt;</span></span><span class="txt">           
      </span><span class="ww" id="w5702"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w5706"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5745" class="sc">/&gt;</span></span><span class="txt">                
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx5749" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx5753" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5757" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5759"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXqBlocks">f:createXqBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5775"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5789" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5791"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?skip">skip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5805" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5807"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5821" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5823"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5837" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5839"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5853" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5855"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5869" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5871"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?fnLevel">fnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5885" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> xml nesting level </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w5891"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xLevel">xLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5905" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> whether in attribute ' or " or element: &lt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w5911"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xAwaiting">xAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5925" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5927"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xml-stack">xml-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5941" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5943"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-stack">xq-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5957" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5959"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5973" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5975"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?charCount">charCount</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5992" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5994"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx6017" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6019"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nChar">nChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx6046" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6048"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pChar">pChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx6075" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6077"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6093"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6097"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6116"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketStart" class="solar"><span class="variable">$cBracketStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span id="wx6185" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6189" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6191"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6195"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$level</span><span class="z">"</span><span id="wx6203" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6207" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6211" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6215" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6217"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowAwaiting">nowAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6233"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6237"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6250"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
              </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                      </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> 
                      </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketStart" class="solar"><span class="variable">$cBracketStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> 
                      </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6308" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6312" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6314"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6330"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6339" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6343" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6345"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6388"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6397" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6401" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6403"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6407"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx6415" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6419" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6423" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6427" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6429"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowSkip">nowSkip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6445"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6449"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$skip</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6459"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6469" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6473" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6475"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$char</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6510"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6520" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6524" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6526"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6530"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6540" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6544" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6548" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6552" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">        &lt;xsl:if test="empty($awaiting) and empty($nowAwaiting)"&gt;
         &lt;xsl:if test="$char = ($cParenStart,$cParenEnd,$cBracketStart,$cBracketEnd)"&gt;
         &lt;block position="{$index}" type="{codepoints-to-string($char)}"/&gt;
         &lt;/xsl:if&gt;
         &lt;/xsl:if&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w6558"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isFound">isFound</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="op">,</span><span class="variable">$nowAwaiting</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$skip</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6597" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6599"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newStart">newStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$start</span><span class="z">"</span><span id="wx6631" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6633"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6649"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$isFound</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6666"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6707"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6729"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="z">"</span><span id="wx6743" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx6747" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6749"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span id="wx6763" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6765"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="z">"</span><span id="wx6779" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx6783" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx6787" class="ec">&gt;</span></span><span class="txt">            
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6791" class="ec">&gt;</span></span><span class="txt">
    
            
    </span><span class="ww" id="w6793"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newFnLevel">newFnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6809"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6813"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6826"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnEnd" class="solar"><span class="variable">$cFnEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="z">"</span><span id="wx6871" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6875" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6877"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6881"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$fnLevel</span><span class="z">"</span><span id="wx6889" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6893" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6897" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6901" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6903"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xq-stack-level">xq-stack-level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx6943" class="sc">/&gt;</span></span><span class="txt">        
    </span><span class="ww" id="w6945"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xqueryEnds">xqueryEnds</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newFnLevel</span><span class="whitespace"> </span><span class="op">lt</span><span class="whitespace"> </span><span class="variable">$xq-stack-level</span><span class="z">"</span><span id="wx6969" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6971"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xmlStarts">xmlStarts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tagStart" class="solar"><span class="function">f:tagStart</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7004" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">        &lt;xsl:variable name="test-string" select="codepoints-to-string(subsequence($chars, $index + 1, 10))"/&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w7010"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="z">"</span><span id="wx7033" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7035"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w7039"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><span class="variable">$charCount</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7053"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7073"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="open"></span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7112"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7134"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx7148" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7152" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7154"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span id="wx7168" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx7172" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7176" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w7178"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7194"><span class="es">&lt;</span><span class="en">terminate-xquery</span><span id="wx7196" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7200" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w7202"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="z">"</span><span id="wx7213" class="sc">/&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7217" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w7219"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7223"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7227"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xqueryEnds</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7237"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7253"><span class="es">&lt;</span><span class="en">unnested-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx7263" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w7265"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w7279"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z">
                              </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xAwaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                           </span><span class="op">'</span><span class="literal">resume-x-literal-txt</span><span class="op">'</span><span class="open"></span><span class="whitespace">
                                           </span><span class="op">else</span><span class="whitespace">
                                           </span><span class="op">'</span><span class="literal">resume-x-literal</span><span class="op">'</span><span class="z">"</span><span id="wx7315" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w7317"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w7329"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">pos</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx7347" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx7351" class="ec">&gt;</span></span><span class="txt">                            
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7355" class="ec">&gt;</span></span><span class="txt">                           
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7359" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7361"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?popped-xqstack">popped-xqstack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7397" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7399"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace">
                                  </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$popped-xqstack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7443" class="sc">/&gt;</span></span><span class="txt">                       
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7447" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7449"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xmlStarts</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7459"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7475"><span class="es">&lt;</span><span class="en">xml-constructor</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx7485" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7489" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7491"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace">
                                  </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7542" class="sc">/&gt;</span></span><span class="txt">                       
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7546" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7548"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7552"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newStart</span><span class="op">,</span><span class="whitespace"> 
                                  </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7600" class="sc">/&gt;</span></span><span class="txt">                           
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx7604" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7608" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx7612" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7616" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7620" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> suffixed with label and length of start char sequence eg. tags: cdata start, comment start pi start </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="ww" id="w7626"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getAwaitingFrom2ndChar">f:getAwaitingFrom2ndChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7642"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx7656" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7658"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char2">char2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span id="wx7672" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7674"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="open"></span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xExclam" class="solar"><span class="variable">$xExclam</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cParenStart" class="solar"><span class="variable">$cParenStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-cdata</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">9</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-comment</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-dtd</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="comment">(: not supported in XQuery anyway :)</span><span class="open"></span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xPI" class="solar"><span class="variable">$xPI</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xPI" class="solar"><span class="variable">$xPI</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-pi</span><span class="op">'</span><span class="open"></span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-tag</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7821" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7825" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7827"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tagStart">f:tagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7843"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char1">char1</span><span class="z">"</span><span id="wx7857" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7859"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char2">char2</span><span class="z">"</span><span id="wx7873" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7875"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">33</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">63</span><span class="parenthesis">)</span><span class="whitespace"> 
                          </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="numeric">91</span><span class="op">,</span><span class="numeric">92</span><span class="op">,</span><span class="numeric">93</span><span class="op">,</span><span class="numeric">94</span><span class="op">,</span><span class="numeric">96</span><span class="op">,</span><span class="numeric">123</span><span class="op">,</span><span class="numeric">124</span><span class="op">,</span><span class="numeric">125</span><span class="op">,</span><span class="numeric">126</span><span class="op">,</span><span class="numeric">127</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7944" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7948" class="ec">&gt;</span></span><span class="txt">
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span id="wx7952" class="ec">&gt;</span></span><span class="txt">
</span></pre></div></body></html>